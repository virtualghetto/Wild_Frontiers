#textdomain wesnoth-Wild_Frontiers

#define SHARED_GUARDIAN_EVENTS
    [event]
        name=prestart

        {STASH_GOLD}

        # Unstore the hero
        [store_starting_location]
            side=1
            variable=starting_loc
        [/store_starting_location]

        [unstore_unit]
            variable=old_hero_store
            x,y=$starting_loc.x,$starting_loc.y
        [/unstore_unit]
        {CLEAR_VARIABLE starting_loc}

        # Enemy sides stuff
        # Side 2
        {SELECT_FIEF_FACTION}

        [modify_side]
            side=2
            hidden=no
            recruit=$recruit_type
            user_team_name=$rnd_team
        [/modify_side]

        [store_starting_location]
            side=1
            variable=side1_location
        [/store_starting_location]
        [store_starting_location]
            side=2
            variable=side2_location
        [/store_starting_location]

        {DIRECTION_CONE $side1_location.x $side1_location.y $side2_location.x $side2_location.y side2_locations}
        {SPAWN_UNITS 2 $recruit_type side2_locations {ON_DIFFICULTY 6 7 8}}
        {CLEAR_VARIABLE side2_locations}
        {SPAWN_CIRCLE 2 $leader_type $side2_location.x $side2_location.y}
        {CLEAR_VARIABLE leader_type}
        {CLEAR_VARIABLE recruit_type}
        {CLEAR_VARIABLE rnd_team}

        {PLACE_HOSTAGE {ANIMALS_HOSTAGE_LIST} $side2_location.x $side2_location.y}

        # Remove the enemy keep
        [terrain]
            terrain=Rb
            [and]
                x,y=$side2_location.x,$side2_location.y
                radius=1
            [/and]
        [/terrain]

        {CLEAR_VARIABLE side1_location}
        {CLEAR_VARIABLE side2_location}

        # Calculate gold cost
        {VARIABLE recruit_cost 0}
        {VARIABLE recruit_count 0}
        [store_unit]
            [filter]
                side=2
            [/filter]
            variable=enemy_units
            mode=always_clear
            kill=no
        [/store_unit]

        [foreach]
            array=enemy_units
            [do]
                [store_unit_type]
                    type=$this_item.type
                    variable=recruit_store
                    mode=always_clear
                [/store_unit_type]
                {VARIABLE_OP recruit_cost add $recruit_store.cost}
                {VARIABLE_OP recruit_count add 1}
                {CLEAR_VARIABLE recruit_store}
            [/do]
        [/foreach]
        {CLEAR_VARIABLE enemy_units}
        # Get average recruit cost
        [if]
            {VARIABLE_CONDITIONAL recruit_count greater_than 0}
            [then]
                {VARIABLE_OP recruit_cost divide $recruit_count}
                {VARIABLE_OP recruit_cost round floor}
            [/then]
        [/if]
        {VARIABLE_OP recruit_cost multiply $recruit_count}
        [gold]
            side=2
            amount=$recruit_cost
        [/gold]

        {VARIABLE recruit_cost "$($recruit_cost + (20.0 * {ON_DIFFICULTY 2.0 1.5 1.25}))"}
        [if]
            {VARIABLE_CONDITIONAL recruit_cost less_than {WF_MIN_GOLD}}
            [then]
                {VARIABLE recruit_cost {WF_MIN_GOLD}}
            [/then]
        [/if]
        [gold]
            side=1
            amount=$recruit_cost
        [/gold]
        {CLEAR_VARIABLE recruit_cost}
        {CLEAR_VARIABLE recruit_count}
    [/event]
#enddef

#define SHARED_TREK_EVENTS
    {WF_PEDDLER_EVENTS}
    [event]
        name=prestart

        {STASH_GOLD}

        # Trek should lead somewhere
        {VARIABLE chain_quest yes}
        {VARIABLE cave_quest no}

        # Remove all keeps
        [terrain]
            terrain=Gg
            [and]
                terrain=K*^*,C*^*
            [/and]
        [/terrain]

        [store_map_dimensions]
            variable=store_map_dim
        [/store_map_dimensions]

        [if]
            {VARIABLE_CONDITIONAL store_map_dim.width less_than $store_map_dim.height}
            [then]
                #Vertical map
                [set_variable]
                    name=axis
                    ipart="$($store_map_dim.width/2.0)"
                [/set_variable]

                # Down-Up
                {ASSIGN_RAND_IF_NULL trek_dir "1,3"}
                [switch]
                    variable=trek_dir
                    [case]
                        value=1
                        # Starting down, going up.
                        [store_locations]
                            [and]
                                x=$axis
                                y="$($store_map_dim.height-1)"
                            [/and]
                            variable=side1_location
                        [/store_locations]
                        [store_locations]
                            [and]
                                x=$axis
                                y=1
                            [/and]
                            variable=side2_location
                        [/store_locations]
                    [/case]
                    [else]
                        #value=3
                        # Starting up, going down.
                        [store_locations]
                            [and]
                                x=$axis
                                y=2
                            [/and]
                            variable=side1_location
                        [/store_locations]
                        [store_locations]
                            [and]
                                x=$axis
                                y="$($store_map_dim.height-0)"
                            [/and]
                            variable=side2_location
                        [/store_locations]
                    [/else]
                [/switch]
                {CLEAR_VARIABLE trek_dir}

                [store_locations]
                    terrain=!,*^V*,W*^*,M*^*,Q*^*,X*^*,*^Q*,*^X*
                    [and]
                        x=$axis
                        y=1-$store_map_dim.height
                        radius=3
                    [/and]
                    [and]
                        [not]
                            x,y=$side1_location.x,$side1_location.y
                            radius=4
                        [/not]
                    [/and]
                    [and]
                        [not]
                            x,y=$side2_location.x,$side2_location.y
                            radius=1
                        [/not]
                    [/and]
                    [and]
                        [not]
                            [filter]
                            [/filter]
                        [/not]
                    [/and]
                    include_borders=no
                    variable=side2_locations
                [/store_locations]
                {CLEAR_VARIABLE axis}
            [/then]
            [else]
                #Horizontal map
                [set_variable]
                    name=axis
                    ipart="$($store_map_dim.height/2.0)"
                [/set_variable]
                # Left-Right
                {ASSIGN_RAND_IF_NULL trek_dir "0,2"}
                [switch]
                    variable=trek_dir
                    [case]
                        value=0
                        # Starting left, going right.
                        [store_locations]
                            [and]
                                x=2
                                y=$axis
                            [/and]
                            variable=side1_location
                        [/store_locations]
                        [store_locations]
                            [and]
                                x="$($store_map_dim.width-0)"
                                y=$axis
                            [/and]
                            variable=side2_location
                        [/store_locations]
                    [/case]
                    [else]
                        #value=2
                        # Starting right, going left.
                        [store_locations]
                            [and]
                                x="$($store_map_dim.width-1)"
                                y=$axis
                            [/and]
                            variable=side1_location
                        [/store_locations]
                        [store_locations]
                            [and]
                                x=1
                                y=$axis
                            [/and]
                            variable=side2_location
                        [/store_locations]
                    [/else]
                [/switch]
                {CLEAR_VARIABLE trek_dir}
                [store_locations]
                    terrain=!,*^V*,W*^*,M*^*,Q*^*,X*^*,*^Q*,*^X*
                    [and]
                        x=1-$store_map_dim.width
                        y=$axis
                        radius=3
                    [/and]
                    [and]
                        [not]
                            x,y=$side1_location.x,$side1_location.y
                            radius=4
                        [/not]
                    [/and]
                    [and]
                        [not]
                            x,y=$side2_location.x,$side2_location.y
                            radius=1
                        [/not]
                    [/and]
                    [and]
                        [not]
                            [filter]
                            [/filter]
                        [/not]
                    [/and]
                    include_borders=no
                    variable=side2_locations
                [/store_locations]
                {CLEAR_VARIABLE axis}
            [/else]
        [/if]
        {CLEAR_VARIABLE store_map_dim}

        # Clear important areas
        [terrain]
            terrain=Gg
            [and]
                x,y=$side1_location.x,$side1_location.y
                radius=2
            [/and]
        [/terrain]

        [terrain]
            terrain=Gg
            [and]
                x,y=$side2_location.x,$side2_location.y
                radius=2
            [/and]
        [/terrain]

        {MODIFY_TERRAIN Ker $side1_location.x $side1_location.y}
        [terrain]
            terrain=Cer
            [and]
                [not]
                    terrain=C*
                [/not]
                [filter_adjacent_location]
                    terrain=K*
                [/filter_adjacent_location]
            [/and]
        [/terrain]

        # Unstore the hero
        [unstore_unit]
            variable=old_hero_store
            x,y=$side1_location.x,$side1_location.y
        [/unstore_unit]
        {CLEAR_VARIABLE side1_location}

        # Enemy sides stuff
        # Side 2
        {SELECT_FIEF_FACTION}

        [modify_side]
            side=2
            hidden=no
            recruit=$recruit_type
            user_team_name=$rnd_team
        [/modify_side]

        {SPAWN_UNITS 2 $recruit_type side2_locations {ON_DIFFICULTY 9 10 11}}
        {CLEAR_VARIABLE side2_locations}
        {CLEAR_VARIABLE leader_type}
        {CLEAR_VARIABLE recruit_type}
        {CLEAR_VARIABLE rnd_team}

        [store_locations]
            terrain=!,*^V*,W*^*,M*^*,Q*^*,X*^*,*^Q*,*^X*
            [and]
                x,y=$side2_location.x,$side2_location.y
                radius=2
            [/and]
            [and]
                [not]
                    x,y=$side2_location.x,$side2_location.y
                [/not]
            [/and]
            [and]
                [not]
                    find_in=item_xy
                [/not]
            [/and]
            include_borders=no
            variable=gold_chest_locations
        [/store_locations]
        {RANDOM_VAR rnd_c 0.."$($gold_chest_locations.length-1)"}
        {PLACE_WOOD_CHEST $gold_chest_locations[$rnd_c].x $gold_chest_locations[$rnd_c].y}
        [store_locations]
            [and]
                find_in=gold_chest_locations
            [/and]
            [and]
                [not]
                    x,y=$gold_chest_locations[$rnd_c].x,$gold_chest_locations[$rnd_c].y
                [/not]
            [/and]
            variable=gold_chest_locations
        [/store_locations]
        {RANDOM_VAR rnd_c 0.."$($gold_chest_locations.length-1)"}
        {PLACE_PEDDLER_TENT $gold_chest_locations[$rnd_c].x $gold_chest_locations[$rnd_c].y}
        {CLEAR_VARIABLE rnd_c}
        {CLEAR_VARIABLE gold_chest_locations}

        # Calculate costs
        {VARIABLE recruit_cost 0}
        {VARIABLE recruit_count 0}
        [store_unit]
            [filter]
                side=2
            [/filter]
            variable=enemy_units
            mode=always_clear
            kill=no
        [/store_unit]

        [foreach]
            array=enemy_units
            [do]
                [store_unit_type]
                    type=$this_item.type
                    variable=recruit_store
                    mode=always_clear
                [/store_unit_type]
                {VARIABLE_OP recruit_cost add $recruit_store.cost}
                {VARIABLE_OP recruit_count add 1}
                {CLEAR_VARIABLE recruit_store}
            [/do]
        [/foreach]
        {CLEAR_VARIABLE enemy_units}
        # Get average recruit cost
        [if]
            {VARIABLE_CONDITIONAL recruit_count greater_than 0}
            [then]
                {VARIABLE_OP recruit_cost divide $recruit_count}
                {VARIABLE_OP recruit_cost round floor}
            [/then]
        [/if]
        {VARIABLE_OP recruit_cost multiply $recruit_count}
        [gold]
            side=2
            amount=$recruit_cost
        [/gold]

        {VARIABLE recruit_cost "$($recruit_cost + (20.0 * {ON_DIFFICULTY 2.0 1.5 1.25}))"}
        [if]
            {VARIABLE_CONDITIONAL recruit_cost less_than {WF_MIN_GOLD}}
            [then]
                {VARIABLE recruit_cost {WF_MIN_GOLD}}
            [/then]
        [/if]
        [gold]
            side=1
            amount=$recruit_cost
        [/gold]
        {CLEAR_VARIABLE recruit_cost}
        {CLEAR_VARIABLE recruit_count}

        {SWITCH_TERRAIN_BASE "Mm" "Md"}
        [if]
            {VARIABLE_CONDITIONAL wf_vars.season_str equals "autumn"}
            [then]
                {SWITCH_TERRAIN_BASE "Gg" "Gs"}
                {SWITCH_TERRAIN_BASE "Hh" "Hhd"}
                {SWITCH_TERRAIN_BASE "Ww" "Wwg"}
                {SWITCH_TERRAIN_OVERLAY "Fds" "Fdf"}
                {SWITCH_TERRAIN_OVERLAY "Fms" "Fmf"}
                {SWITCH_TERRAIN_BASE "Md" "Mm"}
            [/then]
        [/if]

        # Create a "move to somewhere" objective
        {PLACE_IMAGE "scenery/signpost.png" $side2_location.x $side2_location.y}
        {VARIABLE_OP objective_goal add 1}
        [event]
            name=moveto
            first_time_only=yes
            delayed_variable_substitution=no

            [filter]
                side=1
                id=Hero
                [filter_location]
                    x,y=$side2_location.x,$side2_location.y
                [/filter_location]
            [/filter]
            {VARIABLE_OP objective_goal sub 1}
            [fire_event]
                name=check_objectives
            [/fire_event]
        [/event]
        {CLEAR_VARIABLE side2_location}
    [/event]
#enddef

#define SHARED_CAVE_TREK_EVENTS
    [event]
        name=prestart

        {STASH_GOLD}

        # Trek should lead somewhere
        {VARIABLE chain_quest yes}
        {VARIABLE cave_quest yes}

        # Remove all keeps
        [terrain]
            terrain=Rb
            [and]
                terrain=K*^*,C*^*
            [/and]
        [/terrain]

        [store_starting_location]
            side=1
            variable=side1_location
        [/store_starting_location]

        [store_starting_location]
            side=2
            variable=side2_location
        [/store_starting_location]

        [store_locations]
            terrain=!,*^V*,W*^*,M*^*,Q*^*,X*^*,*^Q*,*^X*
            [and]
                [not]
                    x,y=$side1_location.x,$side1_location.y
                    radius=4
                [/not]
            [/and]
            [and]
                [not]
                    x,y=$side2_location.x,$side2_location.y
                    radius=1
                [/not]
            [/and]
            [and]
                [not]
                    [filter]
                    [/filter]
                [/not]
            [/and]
            include_borders=no
            variable=side2_locations
        [/store_locations]

        # Clear important areas
        [terrain]
            terrain=Rb
            [and]
                x,y=$side1_location.x,$side1_location.y
                radius=2
            [/and]
        [/terrain]

        [terrain]
            terrain=Rb
            [and]
                x,y=$side2_location.x,$side2_location.y
                radius=2
            [/and]
        [/terrain]

        # Unstore the hero
        [unstore_unit]
            variable=old_hero_store
            x,y=$side1_location.x,$side1_location.y
        [/unstore_unit]
        {CLEAR_VARIABLE side1_location}

        # Enemy sides stuff
        # Side 2
        {VARIABLE rnd_team "Undead"}
        {VARIABLE leader_type "Walking Corpse"}
        {VARIABLE recruit_type "Walking Corpse"}

        [modify_side]
            side=2
            hidden=no
            recruit=$recruit_type
            user_team_name=$rnd_team
        [/modify_side]

        {SPAWN_UNITS 2 $recruit_type side2_locations {ON_DIFFICULTY 4 5 6}}
        {CLEAR_VARIABLE side2_locations}
        {CLEAR_VARIABLE leader_type}
        {CLEAR_VARIABLE recruit_type}
        {CLEAR_VARIABLE rnd_team}

        {PLACE_GOLD_PILE_ANYWHERE}
        {PLACE_GOLD_PILE_ANYWHERE}
        {PLACE_GOLD_PILE_ANYWHERE}
        {PLACE_GOLD_PILE_ANYWHERE}

        # Create a "move to somewhere" objective
        {PLACE_IMAGE "scenery/signpost.png" $side2_location.x $side2_location.y}
        {VARIABLE_OP objective_goal add 1}
        [event]
            name=moveto
            first_time_only=yes
            delayed_variable_substitution=no

            [filter]
                side=1
                id=Hero
                [filter_location]
                    x,y=$side2_location.x,$side2_location.y
                [/filter_location]
            [/filter]
            {VARIABLE_OP objective_goal sub 1}
            [fire_event]
                name=check_objectives
            [/fire_event]
        [/event]
        {CLEAR_VARIABLE side2_location}
    [/event]
#enddef

#define WF_SCENE_GUARDIAN
    {SUB_SIDES no no}
    {SIDE_DEFEAT 2 no_units_left}

    random_start_time=no
    {TURNS 36 36 36}
    victory_when_enemies_defeated=no

    {SHARED_GUARDIAN_EVENTS}

    [event]
        name=start

        {FIEF_UNIT (Elvish Fighter,Elvish Archer,Elvish Scout)}

#ifdef EASY
        {FIEF_UNIT (Elvish Archer)}
        {FIEF_UNIT (Elvish Scout)}
        {FIEF_UNIT (Elvish Fighter)}
#endif

        [unhide_unit]
        [/unhide_unit]

        [message]
            side=1
            [not]
                id=Hero
            [/not]
            message=_"These criminals want to unleash some wild beast on us."
        [/message]

        [message]
            id=Hero
            message=_"In the name of the king, let the wild one go."
        [/message]

        [message]
            side=2
            message=_"Ha!"
        [/message]

        [objectives]
            side=1
            [objective]
                description= _ "Kill all enemy units"
                condition=win
            [/objective]
            [objective]
                description= _ "Free the wild beast"
                condition=win
            [/objective]
            #[objective]
            #    description= _ "Loot the chest"
            #    condition=win
            #[/objective]
            [objective]
                description= _ "Death of Hero"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}

            [gold_carryover]
                {WF_CARRYOVER}
            [/gold_carryover]
        [/objectives]
        {CLEAR_VARIABLE store_enemies}
        {CLEAR_VARIABLE objective_arr}
    [/event]

    {VICTORY_MESSAGE}
    {DEFEAT_MESSAGE}
    [event]
        name=time_over_message

        [message]
            speaker=Hero
            message= _ "Aaah! They have unleashed the wild beasts upon us!"
        [/message]
    [/event]

    {SHARED_SUB_EVENTS}
#enddef

#define WF_SCENE_GUARDIAN_URM
    {SUB_SIDES no no}
    {SIDE_DEFEAT 2 no_units_left}

    random_start_time=no
    {TURNS 36 36 36}
    victory_when_enemies_defeated=no

    {SHARED_GUARDIAN_EVENTS}

    [event]
        name=start

        {FIEF_UNIT (Drake Fighter,Drake Burner,Drake Glider)}

#ifdef EASY
        {FIEF_UNIT (Drake Fighter)}
        {FIEF_UNIT (Drake Burner)}
        {FIEF_UNIT (Drake Glider)}
#endif

        [unhide_unit]
        [/unhide_unit]

        [message]
            side=1
            [not]
                id=Hero
            [/not]
            message=_"Be our champion, melord. Free the beast."
        [/message]

        [message]
            id=Hero
            message=_"In the name of the king, let the wild one go."
        [/message]

        [message]
            side=2
            message=_"Ha!"
        [/message]

        [objectives]
            side=1
            [objective]
                description= _ "Kill all enemy units"
                condition=win
            [/objective]
            [objective]
                description= _ "Free the wild beast"
                condition=win
            [/objective]
            #[objective]
            #    description= _ "Loot the chest"
            #    condition=win
            #[/objective]
            [objective]
                description= _ "Death of Hero"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}

            [gold_carryover]
                {WF_CARRYOVER}
            [/gold_carryover]
        [/objectives]
        {CLEAR_VARIABLE store_enemies}
        {CLEAR_VARIABLE objective_arr}
    [/event]

    {VICTORY_MESSAGE}
    {DEFEAT_MESSAGE}
    [event]
        name=time_over_message
        [message]
            speaker=Hero
            message= _ "Aaah! They have unleashed the wild beasts upon us!"
        [/message]
    [/event]

    {SHARED_SUB_EVENTS}
#enddef

#define WF_SCENE_TREK
    {SUB_SIDES no no}
    {SIDE_DEFEAT 2 no_units_left}

    random_start_time=no
    {TURNS 36 36 36}
    victory_when_enemies_defeated=no

    {SHARED_TREK_EVENTS}
    [event]
        name=start

        {FIEF_UNIT (Elvish Fighter,Elvish Archer,Elvish Scout)}

#ifdef EASY
        {FIEF_UNIT (Elvish Archer)}
        {FIEF_UNIT (Elvish Scout)}
        {FIEF_UNIT (Elvish Fighter)}
#endif

        [unhide_unit]
        [/unhide_unit]

        [message]
            side=1
            [not]
                id=Hero
            [/not]
            message=_"Careful melord. Brigands ahead."
        [/message]

        [objectives]
            side=1
            [objective]
                description= _ "Kill all enemy units"
                condition=win
            [/objective]
            [objective]
                description= _ "Hero must reach the signpost"
                condition=win
            [/objective]
            [objective]
                description= _ "Loot the chest"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Hero"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}

            [gold_carryover]
                {WF_CARRYOVER}
            [/gold_carryover]
        [/objectives]
        {CLEAR_VARIABLE store_enemies}
        {CLEAR_VARIABLE objective_arr}
    [/event]

    {VICTORY_MESSAGE}
    {DEFEAT_MESSAGE}
    [event]
        name=time_over_message
        [message]
            speaker=Hero
            message= _ "Aaah! They are descending on us from all sides!"
        [/message]
    [/event]

    {SHARED_SUB_EVENTS}
#enddef

#define WF_SCENE_CAVE_TREK
    {SUB_SIDES no yes}
    {SIDE_DEFEAT 2 no_units_left}

    random_start_time=no
    {TURNS 36 36 36}
    victory_when_enemies_defeated=no

    {SHARED_CAVE_TREK_EVENTS}
    [event]
        name=start

        [unhide_unit]
        [/unhide_unit]

        [message]
            id=Hero
            message=_"Eek! Where the hell is my advisor?"
        [/message]

        [message]
            id=Hero
            message=_"I can do this... don't be scared... I can do this..."
        [/message]

        [message]
            side=2
            race=undead
            message=_"(slow moan)"
        [/message]

        [message]
            id=Hero
            message=_"(shriek)"
        [/message]

        [objectives]
            side=1
            [objective]
                description= _ "Kill all enemy units"
                condition=win
            [/objective]
            [objective]
                description= _ "Hero must reach the signpost"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Hero"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}

            [gold_carryover]
                {WF_CARRYOVER}
            [/gold_carryover]
        [/objectives]
        {CLEAR_VARIABLE store_enemies}
        {CLEAR_VARIABLE objective_arr}
    [/event]

    [event]
        name=victory_message

        [message]
            speaker=Hero
            message= _ "Yes! I made it!"
        [/message]
    [/event]

    [event]
        name=defeat_message

        [message]
            speaker=Hero
            message= _ "Mommy!"
        [/message]
    [/event]

    [event]
        name=time_over_message

        {VARIABLE_OP random_sound rand (rumble.ogg,cave-in.ogg)}
        {QUAKE $random_sound}
        {CLEAR_VARIABLE random_sound}
        [message]
            speaker=Hero
            message= _ "The entrance caved in. I'm trapped!"
        [/message]
    [/event]

    {SHARED_SUB_EVENTS}
#enddef
