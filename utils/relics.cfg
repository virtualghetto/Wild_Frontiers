#textdomain wesnoth-Wild_Frontiers
# Relic (item) macros for Wild Frontiers

#define RELIC_ITEMS_DROP
    {VALUE1 type "potion_of_experience"}
#enddef

#define RELIC_ITEMS_START
    {VALUE1 type "arcane_bow"}
    {VALUE1 type "arcane_sword"}
    {VALUE1 type "fire_bow"}
    {VALUE1 type "potion_of_animal_nature"}
    {VALUE1 type "sword_of_flame"}
    {VALUE1 type "ring_of_regrowth"}
    {VALUE1 type "ring_of_resistance_all"}
#enddef

#define RELIC_ITEMS_UNCURSED
    {VALUE1 type "arcane_bow"}
    {VALUE1 type "arcane_sword"}
    {VALUE1 type "axe_of_ice"}
    {VALUE1 type "cold_bow"}
    {VALUE1 type "fire_bow"}
    {VALUE1 type "marksman_bow"}
    {VALUE1 type "potion_of_animal_nature"}
    {VALUE1 type "potion_of_flight"}
    {VALUE1 type "potion_of_illumination"}
    {VALUE1 type "potion_of_strength"}
    {VALUE1 type "potion_of_dexterity"}
    {VALUE1 type "ring_of_magnetism"}
    {VALUE1 type "ring_of_regeneration"}
    {VALUE1 type "sword_of_flame"}
    {VALUE1 type "ring_of_regrowth"}
    {VALUE1 type "ring_of_resistance_all"}
    {VALUE1 type "ring_of_resistance_arcane"}
    {VALUE1 type "ring_of_resistance_blade"}
    {VALUE1 type "ring_of_resistance_impact"}
    {VALUE1 type "ring_of_resistance_pierce"}
    {VALUE1 type "ring_of_resistance_temperature"}
#enddef

#define RELIC_ITEMS_CURSED
    {VALUE1 type "arcane_bow_cursed"}
    {VALUE1 type "arcane_sword_cursed"}
    {VALUE1 type "axe_of_ice_cursed"}
    {VALUE1 type "cold_bow_cursed"}
    {VALUE1 type "fire_bow_cursed"}
    {VALUE1 type "marksman_bow_cursed"}
    {VALUE1 type "potion_of_gloom"}
    {VALUE1 type "ring_of_magnetism_cursed"}
    {VALUE1 type "ring_of_regeneration_cursed"}
    {VALUE1 type "ring_of_regrowth_cursed"}
    {VALUE1 type "sword_of_flame_cursed"}
    #{VALUE1 type "potion_of_stoneskin"}
#enddef

#define SET_UP_RELICS
    # Called at the beginning of each scenario to (re)-create the events needed
    # Also contains details about the types of relics and the conversation
    # prior to/after picking them up. Almost all of the relic details are in
    # this event. Also contain effect events that need to be re-generated at the
    # start of each new scenario for item persistence.

    # Loop 1 re-init curses for found cursed artifacts
    # and clear_variable on uncursed found artifacts
    [for]
        array=relics.relics_list
        reverse=yes
        [do]
            [if]
                {VARIABLE_CONDITIONAL relics.relics_list[$i].found boolean_equals yes}
                [then]
                    # Found and not cursed, remove it from list
                    {CLEAR_VARIABLE relics.relics_list[$i]}
                [/then]
            [/if]
        [/do]
    [/for]

    # Loop 2 re-init unfound artifacts
    [for]
        array=relics.relics_list
        reverse=yes
        [do]
            [if]	# for some reason wesnoth changes my "false" to "no"
                {VARIABLE_CONDITIONAL relics.relics_list[$i].found boolean_equals no}
                [then]
                    [switch]
                        variable=relics.relics_list[$i].type
                        [case]	# Ring of regeneration
                            value="ring_of_regeneration"
                            {PLACE_RELIC $i _"Ring" "Ring of Regeneration" yes no
                            {RING_DIALOGUE}
                            {RING_OPTION}
                            (_"This ring heals the wearer a little each turn") (
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        {ABILITY_REGENERATES}
                                    [/abilities]
                                [/effect]
                            ) ( ) }
                        [/case]
                        [case]	# Ring of regeneration (cursed)
                            value="ring_of_regeneration_cursed"
                            {PLACE_RELIC $i _"Ring" "Ring of Regeneration" yes no
                            {RING_DIALOGUE}
                            {RING_OPTION}
                            (_"This ring heals the wearer a little each turn") (
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=cursed
                                            name=_"cursed"
                                            female_name=_"female^cursed"
                                            description=_"This unit is cursed."
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                                [effect]
                                    apply_to=status
                                    add=undead_generator
                                [/effect]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        {ABILITY_REGENERATES}
                                    [/abilities]
                                [/effect]
                            ) (
                                #{ASSIGN_UNIT_VARIABLE $relics.relics_list[$i].x $relics.relics_list[$i].y curse undead_generator}
                                #{WF_CALL_FUNCTION curse curse="undead_generator"}
                            ) }
                        [/case]
                        [case]	# Ring of regrowth
                            value="ring_of_regrowth"
                            {PLACE_RELIC $i _"Ring" "Ring of Regrowth" yes no
                            {RING_DIALOGUE}
                            {RING_OPTION}
                            (_"This ring heals the wearer as well as those nearby") (
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        {ABILITY_REGENERATES}
                                        {ABILITY_HEALS}
                                    [/abilities]
                                [/effect]
                            ) ( )}
                        [/case]
                        [case]	# Ring of regrowth (cursed)
                            value="ring_of_regrowth_cursed"
                            {PLACE_RELIC $i _"Ring" "Ring of Regrowth" yes no
                            {RING_DIALOGUE}
                            {RING_OPTION}
                            (_"This ring heals the wearer as well as those nearby") (
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=cursed
                                            name=_"cursed"
                                            female_name=_"female^cursed"
                                            description=_"This unit is cursed."
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                                [effect]
                                    apply_to=status
                                    add=undead_generator
                                [/effect]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        {ABILITY_REGENERATES}
                                        {ABILITY_HEALS}
                                    [/abilities]
                                [/effect]
                            ) (
                                #{ASSIGN_UNIT_VARIABLE $relics.relics_list[$i].x $relics.relics_list[$i].y curse undead_generator}
                                #{WF_CALL_FUNCTION curse curse="undead_generator"}
                            )}
                        [/case]
                        [case]	# Ring of resistance (all)
                            value="ring_of_resistance_all"
                            {PLACE_RELIC $i _"Ring" "Ring of Major Resistance" no no
                            {RING_DIALOGUE}
                            {RING_OPTION}
                            (_"This ring increases all of the wearer's resistance by 20%") (
                                #[effect]
                                #    apply_to=new_ability
                                #    [abilities]
                                #        [dummy]
                                #            id=major_resistance
                                #            name=_"major resistance"
                                #            female_name= _ "female^major resistance"
                                #            description=_"This unit's resistances are all increased by 20% from their base values."
                                #        [/dummy]
                                #    [/abilities]
                                #[/effect]
                                [effect]
                                    apply_to=resistance
                                    replace=no
                                    [resistance]
                                        blade=-20
                                        pierce=-20
                                        impact=-20
                                        fire=-20
                                        cold=-20
                                        arcane=-20
                                    [/resistance]
                                [/effect]
                            ) ( ) }
                        [/case]
                        [case]	# Ring of resistance (blade)
                            value="ring_of_resistance_blade"
                            {PLACE_RELIC $i _"Ring" "Ring of Blade Resistance" no no
                            {RING_DIALOGUE}
                            {RING_OPTION}
                            (_"This ring increases the wearer's blade resistance by 10%") (
                                #[effect]
                                #	apply_to=new_ability
                                #	[abilities]
                                #		[dummy]
                                #			id=blade_resistance
                                #			name=_"blade resistance"
                                #			female_name= _ "female^blade resistance"
                                #			description=_"This unit's blade resistance is increased by 30% from the base value."
                                #		[/dummy]
                                #	[/abilities]
                                #[/effect]
                                [effect]
                                    apply_to=resistance
                                    replace=no
                                    [resistance]
                                        blade=-10
                                    [/resistance]
                                [/effect]
                            ) ( ) }
                        [/case]
                        [case]	# Ring of resistance (impact)
                            value="ring_of_resistance_impact"
                            {PLACE_RELIC $i _"Ring" "Ring of Impact Resistance" no no
                            {RING_DIALOGUE}
                            {RING_OPTION}
                            (_"This ring increases the wearer's impact resistance by 10%") (
                                #[effect]
                                #	apply_to=new_ability
                                #	[abilities]
                                #		[dummy]
                                #			id=impact_resistance
                                #			name=_"impact resistance"
                                #			female_name=_"female^impact resistance"
                                #			description=_"This unit's impact resistance is increased by 30% from the base value."
                                #		[/dummy]
                                #	[/abilities]
                                #[/effect]
                                [effect]
                                    apply_to=resistance
                                    replace=no
                                    [resistance]
                                        impact=-10
                                    [/resistance]
                                [/effect]
                            ) ( ) }
                        [/case]
                        [case]	# Ring of resistance (pierce)
                            value="ring_of_resistance_pierce"
                            {PLACE_RELIC $i _"Ring" "Ring of Pierce Resistance" no no
                            {RING_DIALOGUE}
                            {RING_OPTION}
                            (_"This ring increases the wearer's pierce resistance by 10%") (
                                #[effect]
                                #	apply_to=new_ability
                                #	[abilities]
                                #		[dummy]
                                #			id=pierce_resistance
                                #			name=_"pierce resistance"
                                #			female_name= _ "female^pierce resistance"
                                #			description=_"This unit's pierce resistance is increased by 30% from the base value."
                                #		[/dummy]
                                #	[/abilities]
                                #[/effect]
                                [effect]
                                    apply_to=resistance
                                    replace=no
                                    [resistance]
                                        pierce=-10
                                    [/resistance]
                                [/effect]
                            ) ( ) }
                        [/case]
                        [case]	# Ring of resistance (fire+cold)
                            value="ring_of_resistance_temperature"
                            {PLACE_RELIC $i _"Ring" "Ring of Weather Resistance" no no
                            {RING_DIALOGUE}
                            {RING_OPTION}
                            (_"This ring increases the wearer's fire and cold resistances by 10%") (
                                #[effect]
                                #	apply_to=new_ability
                                #	[abilities]
                                #		[dummy]
                                #			id=temperature_resistance
                                #			name=_"temperature resistance"
                                #			female_name= _ "female^temperature resistance"
                                #			description=_"This unit's fire and cold resistances are increased by 30% from their base values."
                                #		[/dummy]
                                #	[/abilities]
                                #[/effect]
                                [effect]
                                    apply_to=resistance
                                    replace=no
                                    [resistance]
                                        fire=-10
                                        cold=-10
                                    [/resistance]
                                [/effect]
                            ) ( ) }
                        [/case]
                        [case]	# Ring of resistance (arcane)
                            value="ring_of_resistance_arcane"
                            {PLACE_RELIC $i _"Ring" "Ring of Arcane Resistance" no no
                            {RING_DIALOGUE}
                            {RING_OPTION}
                            (_"This ring increases the wearer's arcane resistance by 10%") (
                                #[effect]
                                #	apply_to=new_ability
                                #	[abilities]
                                #		[dummy]
                                #			id=arcane_resistance
                                #			name=_"arcane resistance"
                                #			female_name= _ "female^arcane resistance"
                                #			description=_"This unit's arcane resistance is increased by 30% from the base value."
                                #		[/dummy]
                                #	[/abilities]
                                #[/effect]
                                [effect]
                                    apply_to=resistance
                                    replace=no
                                    [resistance]
                                        arcane=-10
                                    [/resistance]
                                [/effect]
                            ) ( ) }
                        [/case]
                        [case]	# Ring of magnetism (cursed)
                            value="ring_of_magnetism_cursed"
                            {PLACE_RELIC $i _"Ring" "Ring of Magnetism" yes no
                            {RING_DIALOGUE}
                            {RING_OPTION}
                            (_"This ring greatly increases the wearer's accuracy") (
                                [effect]	# remove existing weapon specials
                                    apply_to=attack
                                    remove_specials=magical,marksman,magnetic,truestrike
                                [/effect]
                                #[effect]
                                #    apply_to=remove_ability
                                #    [abilities]
                                #        [dummy]
                                #            id=truestrike
                                #        [/dummy]
                                #    [/abilities]
                                #[/effect]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=cursed
                                            name=_"cursed"
                                            female_name=_"female^cursed"
                                            description=_"This unit is cursed."
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=magnetic
                                            name=_"magnetic"
                                            female_name=_"female^magnetic"
                                            description=_"All of this unit's attacks have an extremely high chance to hit."
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                                [effect]
                                    apply_to=attack
                                    # no filter keys -- I want to modify all attacks
                                    [set_specials]
                                        mode=append
                                        [chance_to_hit]
                                            id=magnetic_cursed
                                            name=_"magnetic"
                                            description=_"This attack always has a 90% chance to hit regardless of the defensive ability of the unit being attacked."
                                            value=90
                                            cumulative=no
                                            apply_to=both
                                        [/chance_to_hit]
                                    [/set_specials]
                                [/effect]
                            ) (
                                #{ASSIGN_UNIT_VARIABLE $relics.relics_list[$i].x $relics.relics_list[$i].y curse magnetic}
                                #{WF_CALL_FUNCTION curse curse="magnetic"}
                                [modify_unit]
                                    [filter]
                                        x=$relics.relics_list[$i].x
                                        y=$relics.relics_list[$i].y
                                    [/filter]
                                    [effect]
                                        apply_to=remove_ability
                                        [abilities]
                                            [dummy]
                                                id=truestrike
                                            [/dummy]
                                        [/abilities]
                                    [/effect]
                                [/modify_unit]
                            )}
                        [/case]
                        [case]	# Ring of magnetism
                            value="ring_of_magnetism"
                            {PLACE_RELIC $i _"Ring" "Ring of Magnetism" yes no
                            {RING_DIALOGUE}
                            {RING_OPTION}
                            (_"This ring greatly increases the wearer's accuracy") (
                                [effect]	# remove existing weapon specials
                                    apply_to=attack
                                    remove_specials=magical,marksman,magnetic_cursed,truestrike
                                [/effect]
                                #[effect]
                                #    apply_to=remove_ability
                                #    [abilities]
                                #        [dummy]
                                #            id=truestrike
                                #        [/dummy]
                                #    [/abilities]
                                #[/effect]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=magnetic
                                            name=_"magnetic"
                                            female_name=_"female^magnetic"
                                            description=_"All of this unit's attacks have an extremely high chance to hit."
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                                [effect]
                                    apply_to=attack
                                    # no filter keys -- I want to modify all attacks
                                    [set_specials]
                                        mode=append
                                        [chance_to_hit]
                                            id=magnetic
                                            name=_"magnetic"
                                            description=_"This attack always has a 90% chance to hit regardless of the defensive ability of the unit being attacked."
                                            value=90
                                            cumulative=no
                                        [/chance_to_hit]
                                    [/set_specials]
                                [/effect]
                            ) (
                                [modify_unit]
                                    [filter]
                                        x=$relics.relics_list[$i].x
                                        y=$relics.relics_list[$i].y
                                    [/filter]
                                    [effect]
                                        apply_to=remove_ability
                                        [abilities]
                                            [dummy]
                                                id=truestrike
                                            [/dummy]
                                        [/abilities]
                                    [/effect]
                                [/modify_unit]
                            ) }
                        [/case]
                        [case]	# Potion of strength
                            value="potion_of_strength"
                            {PLACE_RELIC $i _"Potion" "Potion of Strength" yes no
                            {POTION_DIALOGUE}
                            {POTION_OPTION}
                            (_"This potion grants the drinker incredible strength") (
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=strength
                                            name=_"strength"
                                            female_name= _ "female^strength"
                                            description=_"This unit has incredible strength."
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                                [effect]
                                    apply_to=attack
                                    increase_damage=2
                                [/effect]
                                [effect]
                                    apply_to=hitpoints
                                    increase_total=5
                                    heal_full=yes
                                [/effect]
                            ) (
                                {UNIT_SAYS _"I feel incredibly powerful! Where is the nearest orc? I shall disembowel him!"}
                            )}
                        [/case]
                        [case]	# Potion of dexterity
                            value="potion_of_dexterity"
                            {PLACE_RELIC $i _"Potion" "Potion of Dexterity" yes no
                            {POTION_DIALOGUE}
                            {POTION_OPTION}
                            (_"This potion grants the drinker extra strikes") (
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=dexterous
                                            name=_"dexterous"
                                            female_name= _ "female^dexterous"
                                            description=_"This unit has extra strikes."
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                                [effect]
                                    apply_to=attack
                                    increase_attacks=2
                                [/effect]
                                [effect]
                                    apply_to=hitpoints
                                    increase_total=5
                                    heal_full=yes
                                [/effect]
                            ) (
                                {UNIT_SAYS _"I feel incredibly flexible! I am ready to pounce!"}
                            )}
                        [/case]
                        [case]	# Potion of illumination
                            value="potion_of_illumination"
                            {PLACE_RELIC $i _"Potion" "Potion of Illumination" yes no
                            {POTION_DIALOGUE}
                            {POTION_OPTION}
                            (_"This potion causes drinker to glow with a warm inner light") (
                                #[effect]
                                #    apply_to=remove_ability
                                #    [abilities]
                                #        [illuminates]
                                #            id=darkens
                                #        [/illuminates]
                                #    [/abilities]
                                #[/effect]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        {ABILITY_ILLUMINATES}
                                    [/abilities]
                                [/effect]
                                [effect]
                                    apply_to=halo
                                    halo=halo/illuminates-aura.png
                                [/effect]
                            ) (
                                [modify_unit]
                                    [filter]
                                        x=$relics.relics_list[$i].x
                                        y=$relics.relics_list[$i].y
                                    [/filter]
                                    [effect]
                                        apply_to=remove_ability
                                        [abilities]
                                            [illuminates]
                                                id=darkens
                                            [/illuminates]
                                        [/abilities]
                                    [/effect]
                                [/modify_unit]
                                {UNIT_SAYS _"I'm. . . I'm. . . I'm glowing!"}
                                {UNIT_SAYS _"Hmmm. . . I guess this means no more covert nighttime rendezvous for me."}
                            )}
                        [/case]
                        [case]	# Potion of gloom
                            value="potion_of_gloom"
                            {PLACE_RELIC $i _"Potion" "Potion of Gloom" yes no
                            {POTION_DIALOGUE}
                            {POTION_OPTION}
                            (_"This potion casts a dark gloom over the drinker") (
                                #[effect]
                                #    apply_to=remove_ability
                                #    [abilities]
                                #        [illuminates]
                                #            id=illumination
                                #        [/illuminates]
                                #    [/abilities]
                                #[/effect]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [illuminates]
                                            id=darkens
                                            value=-25
                                            min_value=-25
                                            cumulative=no
                                            name=_"darkens"
                                            female_name=_"female^darkens"
                                            description=_"This unit darkens the surrounding area, making lawful units fight worse, and chaotic units fight better."
                                            affect_self=yes
                                        [/illuminates]
                                    [/abilities]
                                [/effect]
                                [effect]
                                    apply_to=halo
                                    halo=halo/darkens-aura.png
                                [/effect]
                            ) (
                                [modify_unit]
                                    [filter]
                                        x=$relics.relics_list[$i].x
                                        y=$relics.relics_list[$i].y
                                    [/filter]
                                    [effect]
                                        apply_to=remove_ability
                                        [abilities]
                                            [illuminates]
                                                id=illumination
                                            [/illuminates]
                                        [/abilities]
                                    [/effect]
                                [/modify_unit]
                                {UNIT_SAYS _"Hello darkness, my old friend..."}
                            )}
                        [/case]
                        [case]	# Potion of stoneskin
                            value="potion_of_stoneskin"
                            {PLACE_RELIC $i _"Potion" "Potion of Stoneskin" yes no
                            {POTION_DIALOGUE}
                            {POTION_OPTION}
                            (_"This potion hardens the drinker's skin, but greatly reduces movement") (
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=stoneskin
                                            name=_"stoneskin"
                                            female_name= _ "female^stoneskin"
                                            description=_"This unit is highly resistant to all forms of attack, but its hardened skin makes movement difficult."
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                                [effect]
                                    apply_to=resistance
                                    replace=yes
                                    [resistance]
                                        blade=20
                                        pierce=20
                                        impact=20
                                        fire=20
                                        cold=20
                                        arcane=80
                                    [/resistance]
                                [/effect]
                                [effect]
                                    apply_to=movement
                                    set=4
                                [/effect]
                                [effect]
                                    apply_to=movement_costs
                                    replace=yes
                                    [movement_costs]
                                        shallow_water=2
                                        reef=2
                                        swamp_water=2
                                        flat=1
                                        sand=2
                                        forest=2
                                        hills=2
                                        mountains=1
                                        village=1
                                        castle=1
                                        cave=2
                                        frozen=2
                                        fungus=2
                                    [/movement_costs]
                                [/effect]
                                [effect]
                                    apply_to=defense
                                    replace=yes
                                    [defense]
                                        shallow_water=90
                                        reef=90
                                        swamp_water=90
                                        flat=80
                                        sand=80
                                        forest=70
                                        hills=70
                                        mountains=70
                                        village=60
                                        castle=60
                                        cave=70
                                        frozen=90
                                        fungus=80
                                    [/defense]
                                [/effect]
                            ) ( )}
                        [/case]
                        [case]	# Potion of flight
                            value="potion_of_flight"
                            {PLACE_RELIC $i _"Potion" "Potion of Flight" yes no
                            {POTION_DIALOGUE}
                            {POTION_OPTION}
                            (_"This potion causes the drinker to levitate a cubit or so above the ground") (
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=levitates
                                            name=_"levitates"
                                            female_name=_"female^levitates"
                                            description=_"This unit can levitate, greatly reducing its movement costs over rough terrain."
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                                [effect]
                                    apply_to=movement_costs
                                    replace=yes
                                    [movement_costs]
                                        shallow_water=1
                                        reef=1
                                        swamp_water=1
                                        flat=1
                                        sand=1
                                        forest=1
                                        hills=1
                                        mountains=1
                                        village=1
                                        castle=1
                                        cave=1
                                        frozen=1
                                        fungus=1
                                        unwalkable=1
                                    [/movement_costs]
                                [/effect]
                            ) (
                                #[store_unit]
                                #    variable=unit_to_levitate
                                #    [filter]
                                #        x,y=$relics.relics_list[$i].x,$relics.relics_list[$i].y
                                #    [/filter]
                                #[/store_unit]
                                #{VARIABLE unit_to_levitate.flying yes}
                                #[unstore_unit]
                                #    variable=unit_to_levitate
                                #    find_vacant=no
                                #[/unstore_unit]
                                #{CLEAR_VARIABLE unit_to_levitate}
                            )}
                        [/case]
                        [case]	# Potion of animal nature
                            value="potion_of_animal_nature"
                            {PLACE_RELIC $i _"Potion" "Potion of Animal Nature" yes no
                            {POTION_DIALOGUE}
                            {POTION_OPTION}
                            (_"This potion reveals the drinker's hidden animal nature") (
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=animal
                                            name=_"animal"
                                            female_name=_"female^animal"
                                            description=_"This unit gains several powerful attacks, at the cost of his or her humanity."
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                                [effect]
                                    apply_to=status
                                    add=feral
                                [/effect]
                                [effect]
                                    apply_to=new_attack
                                    name=claws
                                    description=_"claws"
                                    type=blade
                                    range=melee
                                    damage=14
                                    number=2
                                    icon="attacks/claws-animal.png"
                                    [specials]
                                        {WEAPON_SPECIAL_POISON}
                                    [/specials]
                                [/effect]
                                [effect]
                                    apply_to=new_attack
                                    name=fangs
                                    description=_"fangs"
                                    type=blade
                                    range=melee
                                    damage=14
                                    number=2
                                    icon="attacks/fangs-animal.png"
                                    [specials]
                                        {WEAPON_SPECIAL_DRAIN}
                                    [/specials]
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=claws
                                        [/filter_attack]
                                        start_time=-200
                                        offset=0~0.6:200,0.6~0:200
                                        {SOUND:HIT_AND_MISS claws.ogg {SOUND_LIST:MISS} -100}
                                    [/attack_anim]
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=fangs
                                        [/filter_attack]
                                        start_time=-200
                                        offset=0~0.6:200,0.6~0:200
                                        {SOUND:HIT_AND_MISS bite-small.ogg {SOUND_LIST:MISS} -100}
                                    [/attack_anim]
                                [/effect]
                            ) (
                                [modify_unit]
                                    [filter]
                                        x=$relics.relics_list[$i].x
                                        y=$relics.relics_list[$i].y
                                    [/filter]
                                    [effect]
                                        apply_to=remove_ability
                                        [abilities]
                                            [dummy]
                                                id=stench
                                            [/dummy]
                                        [/abilities]
                                    [/effect]
                                [/modify_unit]
                                {NARRATOR_SAYS _"The soldier's shoulders and chest begin to swell. Dark fur sprouts and teeth grown into razor-sharp fangs."}
                                {UNIT_SAYS _"Raaaawwwwwwwrrrrrrrr!"}
                                {HERO_SAYS ( {WHISPER _"trembles"} _" Is that still you in there?")}
                                {UNIT_SAYS _"Aye, it is still me, milord, just a bit stronger than I used to be!"}
                                #{ASSIGN_UNIT_VARIABLE $relics.relics_list[$i].x $relics.relics_list[$i].y curse feral}
                            )}
                            # Note: don't need to call_function curse here, animal_goal already defined
                        [/case]
                        [case]	# Sword of flame
                            value="sword_of_flame"
                            {PLACE_RELIC $i _"Sword" "Sword of Flame" yes no
                            ({UNIT_SAYS _"There is a beautifully-crafted blade here. It must be magical - I can feel heat radiating from it."} )
                            (_"Take the sword?")
                            (_"A blade constructed from pure fire") (
                                [effect]
                                    apply_to=new_attack
                                    name=sword_of_flame
                                    description=_"sword of flame"
                                    type=fire
                                    range=melee
                                    damage=10
                                    number=4
                                    icon="attacks/longsword.png"
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=sword_of_flame
                                        [/filter_attack]
                                        start_time=-200
                                        offset=0~0.6:200,0.6~0:200
                                        {SOUND:HIT_AND_MISS {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS} -100}
                                    [/attack_anim]
                                [/effect]
                            ) ( ) }
                        [/case]
                        [case]	# Sword of flame (cursed)
                            value="sword_of_flame_cursed"
                            {PLACE_RELIC $i _"Sword" "Sword of Flame" yes no
                            ({UNIT_SAYS _"There is a beautifully-crafted blade here. It must be magical - I can feel heat radiating from it."} )
                            (_"Take the sword?")
                            (_"A blade constructed from pure fire") (
                                [effect]
                                    apply_to=new_attack
                                    name=sword_of_flame_cursed
                                    description=_"feisty sword of flame"
                                    type=fire
                                    range=melee
                                    damage=12
                                    number=4
                                    icon="attacks/longsword.png"
                                    [specials]
                                        [heal_on_hit]
                                            id=feisty
                                            name= _ "feisty"
                                            description= _ "Each successful strike with this weapon harms the user for 1 HP"
                                            sub=1
                                        [/heal_on_hit]
                                    [/specials]
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=sword_of_flame_cursed
                                        [/filter_attack]
                                        start_time=-200
                                        offset=0~0.6:200,0.6~0:200
                                        {SOUND:HIT_AND_MISS {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS} -100}
                                    [/attack_anim]
                                [/effect]
                            ) (
                                #{ASSIGN_UNIT_VARIABLE $relics.relics_list[$i].x $relics.relics_list[$i].y curse feisty_weapon}
                                #{WF_CALL_FUNCTION curse curse="feisty_weapon"}
                            )}
                        [/case]
                        [case]	# Axe of ice
                            value="axe_of_ice"
                            {PLACE_RELIC $i _"Axe" "Axe of Ice" yes no
                            ({UNIT_SAYS _"There is a beautifully-crafted axe here. It must be magical - it seems to suck all the heat out of this place."} )
                            (_"Take the axe?")
                            (_"A short-handled axe crafted from enchanted ice") (
                                [effect]
                                    apply_to=new_attack
                                    name=axe_of_ice
                                    description=_"axe of ice"
                                    type=cold
                                    range=melee
                                    damage=14
                                    number=3
                                    icon="attacks/battleaxe.png"
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=axe_of_ice
                                        [/filter_attack]
                                        start_time=-200
                                        offset=0~0.6:200,0.6~0:200
                                        {SOUND:HIT_AND_MISS axe.ogg {SOUND_LIST:MISS} -50}
                                    [/attack_anim]
                                [/effect]
                            ) ( ) }
                        [/case]
                        [case]	# Axe of ice (cursed)
                            value="axe_of_ice_cursed"
                            {PLACE_RELIC $i _"Axe" "Axe of Ice" yes no
                            ({UNIT_SAYS _"There is a beautifully-crafted axe here. It must be magical - it seems to suck all the heat out of this place."} )
                            (_"Take the axe?")
                            (_"A short-handled axe crafted from enchanted ice") (
                                [effect]
                                    apply_to=new_attack
                                    name=axe_of_ice_cursed
                                    description=_"feisty axe of ice"
                                    type=cold
                                    range=melee
                                    damage=16
                                    number=3
                                    icon="attacks/battleaxe.png"
                                    [specials]
                                        [heal_on_hit]
                                            id=feisty
                                            name= _ "feisty"
                                            description= _ "Each successful strike with this weapon harms the user for 1 HP"
                                            sub=1
                                        [/heal_on_hit]
                                    [/specials]
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=axe_of_ice_cursed
                                        [/filter_attack]
                                        start_time=-200
                                        offset=0~0.6:200,0.6~0:200
                                        {SOUND:HIT_AND_MISS axe.ogg {SOUND_LIST:MISS} -50}
                                    [/attack_anim]
                                [/effect]
                            ) (
                                #{ASSIGN_UNIT_VARIABLE $relics.relics_list[$i].x $relics.relics_list[$i].y curse feisty_weapon}
                                #{WF_CALL_FUNCTION curse curse="feisty_weapon"}
                            )}
                        [/case]
                        [case]	# Arcane bow
                            value="arcane_bow"
                            {PLACE_RELIC $i _"Bow" "Arcane Bow" yes no
                            ({UNIT_SAYS _"There is a fine bow here, in perfect condition, but no arrows or quivers to be found. I cannot identify its origin, but it does not look to be of elven make."} )
                            (_"Take the bow?")
                            (_"A bow that fires bolts of magical energy") (
                                [effect]
                                    apply_to=new_attack
                                    name=arcane_bow
                                    description=_"arcane bow"
                                    type=arcane
                                    range=ranged
                                    damage=9
                                    number=3
                                    [specials]
                                        {WEAPON_SPECIAL_MAGICAL}
                                    [/specials]
                                    icon="attacks/bow-elven-magic.png"
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=arcane_bow
                                        [/filter_attack]
                                        start_time=-250
                                        missile_start_time=-150

                                        [missile_frame]
                                            duration=150
                                            image="projectiles/missile-n.png"
                                            image_diagonal="projectiles/missile-ne.png"
                                        [/missile_frame]
                                        {SOUND:HIT_AND_MISS bow-puny.ogg bow-puny-miss.ogg -225}
                                    [/attack_anim]
                                [/effect]
                            ) ( ) }
                        [/case]
                        [case]	# Arcane bow (cursed)
                            value="arcane_bow_cursed"
                            {PLACE_RELIC $i _"Bow" "Arcane Bow" yes no
                            ({UNIT_SAYS _"There is a fine bow here, in perfect condition, but no arrows or quivers to be found. I cannot identify its origin, but it does not look to be of elven make."} )
                            (_"Take the bow?")
                            (_"A bow that fires bolts of magical energy") (
                                [effect]
                                    apply_to=new_attack
                                    name=arcane_bow_cursed
                                    description=_"feisty arcane bow"
                                    type=arcane
                                    range=ranged
                                    damage=11
                                    number=3
                                    [specials]
                                        {WEAPON_SPECIAL_MAGICAL}
                                        [heal_on_hit]
                                            id=feisty
                                            name= _ "feisty"
                                            description= _ "Each successful strike with this weapon harms the user for 1 HP"
                                            sub=1
                                        [/heal_on_hit]
                                    [/specials]
                                    icon="attacks/bow-elven-magic.png"
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=arcane_bow_cursed
                                        [/filter_attack]
                                        start_time=-250
                                        missile_start_time=-150

                                        [missile_frame]
                                            duration=150
                                            image="projectiles/missile-n.png"
                                            image_diagonal="projectiles/missile-ne.png"
                                        [/missile_frame]
                                        {SOUND:HIT_AND_MISS bow-puny.ogg bow-puny-miss.ogg -225}
                                    [/attack_anim]
                                [/effect]
                            ) (
                                #{ASSIGN_UNIT_VARIABLE $relics.relics_list[$i].x $relics.relics_list[$i].y curse feisty_weapon}
                                #{WF_CALL_FUNCTION curse curse="feisty_weapon"}
                            ) }
                        [/case]
                        [case]	# Marksman bow
                            value="marksman_bow"
                            {PLACE_RELIC $i _"Bow" "Marksman Bow" yes no
                            ({UNIT_SAYS _"There is a fine bow here, in perfect condition, but no arrows or quivers to be found. I cannot identify its origin, but it does not look to be of elven make."} )
                            (_"Take the bow?")
                            (_"A bow that fires bolts with high accuracy") (
                                [effect]
                                    apply_to=new_attack
                                    name=marksman_bow
                                    description=_"marksman bow"
                                    type=pierce
                                    range=ranged
                                    damage=9
                                    number=3
                                    [specials]
                                        {WEAPON_SPECIAL_MARKSMAN}
                                    [/specials]
                                    icon="attacks/bow-elven.png"
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=marksman_bow
                                        [/filter_attack]
                                        start_time=-250
                                        missile_start_time=-150

                                        [missile_frame]
                                            duration=150
                                            image="projectiles/missile-n.png"
                                            image_diagonal="projectiles/missile-ne.png"
                                        [/missile_frame]
                                        {SOUND:HIT_AND_MISS bow-puny.ogg bow-puny-miss.ogg -225}
                                    [/attack_anim]
                                [/effect]
                            ) ( ) }
                        [/case]
                        [case]	# Marksman bow (cursed)
                            value="marksman_bow_cursed"
                            {PLACE_RELIC $i _"Bow" "Marksman Bow" yes no
                            ({UNIT_SAYS _"There is a fine bow here, in perfect condition, but no arrows or quivers to be found. I cannot identify its origin, but it does not look to be of elven make."} )
                            (_"Take the bow?")
                            (_"A bow that fires bolts with high accuracy") (
                                [effect]
                                    apply_to=new_attack
                                    name=marksman_bow_cursed
                                    description=_"feisty marksman bow"
                                    type=pierce
                                    range=ranged
                                    damage=11
                                    number=3
                                    [specials]
                                        {WEAPON_SPECIAL_MARKSMAN}
                                        [heal_on_hit]
                                            id=feisty
                                            name= _ "feisty"
                                            description= _ "Each successful strike with this weapon harms the user for 1 HP"
                                            sub=1
                                        [/heal_on_hit]
                                    [/specials]
                                    icon="attacks/bow-elven.png"
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=marksman_bow_cursed
                                        [/filter_attack]
                                        start_time=-250
                                        missile_start_time=-150

                                        [missile_frame]
                                            duration=150
                                            image="projectiles/missile-n.png"
                                            image_diagonal="projectiles/missile-ne.png"
                                        [/missile_frame]
                                        {SOUND:HIT_AND_MISS bow-puny.ogg bow-puny-miss.ogg -225}
                                    [/attack_anim]
                                [/effect]
                            ) (
                                #{ASSIGN_UNIT_VARIABLE $relics.relics_list[$i].x $relics.relics_list[$i].y curse feisty_weapon}
                                #{WF_CALL_FUNCTION curse curse="feisty_weapon"}
                            ) }
                        [/case]
                        [case]	# Fire bow
                            value="fire_bow"
                            {PLACE_RELIC $i _"Bow" "Fire Bow" yes no
                            ({UNIT_SAYS _"There is a fine bow here, in perfect condition, but no arrows or quivers to be found. I cannot identify its origin, but it does not look to be of elven make."} )
                            (_"Take the bow?")
                            (_"A bow that fires bolts of fire energy") (
                                [effect]
                                    apply_to=new_attack
                                    name=fire_bow
                                    description=_"fire bow"
                                    type=fire
                                    range=ranged
                                    damage=9
                                    number=3
                                    [specials]
                                        {WEAPON_SPECIAL_MAGICAL}
                                    [/specials]
                                    icon="attacks/bow-elven-magic.png"
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=fire_bow
                                        [/filter_attack]
                                        start_time=-250
                                        missile_start_time=-150

                                        [missile_frame]
                                            duration=150
                                            image="projectiles/missile-n.png"
                                            image_diagonal="projectiles/missile-ne.png"
                                        [/missile_frame]
                                        {SOUND:HIT_AND_MISS bow-puny.ogg bow-puny-miss.ogg -225}
                                    [/attack_anim]
                                [/effect]
                            ) ( ) }
                        [/case]
                        [case]	# Fire bow (cursed)
                            value="fire_bow_cursed"
                            {PLACE_RELIC $i _"Bow" "Fire Bow" yes no
                            ({UNIT_SAYS _"There is a fine bow here, in perfect condition, but no arrows or quivers to be found. I cannot identify its origin, but it does not look to be of elven make."} )
                            (_"Take the bow?")
                            (_"A bow that fires bolts of fire energy") (
                                [effect]
                                    apply_to=new_attack
                                    name=fire_bow_cursed
                                    description=_"feisty fire bow"
                                    type=fire
                                    range=ranged
                                    damage=11
                                    number=3
                                    [specials]
                                        {WEAPON_SPECIAL_MAGICAL}
                                        [heal_on_hit]
                                            id=feisty
                                            name= _ "feisty"
                                            description= _ "Each successful strike with this weapon harms the user for 1 HP"
                                            sub=1
                                        [/heal_on_hit]
                                    [/specials]
                                    icon="attacks/bow-elven-magic.png"
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=fire_bow_cursed
                                        [/filter_attack]
                                        start_time=-250
                                        missile_start_time=-150

                                        [missile_frame]
                                            duration=150
                                            image="projectiles/missile-n.png"
                                            image_diagonal="projectiles/missile-ne.png"
                                        [/missile_frame]
                                        {SOUND:HIT_AND_MISS bow-puny.ogg bow-puny-miss.ogg -225}
                                    [/attack_anim]
                                [/effect]
                            ) (
                                #{ASSIGN_UNIT_VARIABLE $relics.relics_list[$i].x $relics.relics_list[$i].y curse feisty_weapon}
                                #{WF_CALL_FUNCTION curse curse="feisty_weapon"}
                            ) }
                        [/case]
                        [case]	# Cold bow
                            value="cold_bow"
                            {PLACE_RELIC $i _"Bow" "Cold Bow" yes no
                            ({UNIT_SAYS _"There is a fine bow here, in perfect condition, but no arrows or quivers to be found. I cannot identify its origin, but it does not look to be of elven make."} )
                            (_"Take the bow?")
                            (_"A bow that fires bolts of cold energy") (
                                [effect]
                                    apply_to=new_attack
                                    name=cold_bow
                                    description=_"cold bow"
                                    type=cold
                                    range=ranged
                                    damage=9
                                    number=3
                                    [specials]
                                        {WEAPON_SPECIAL_MAGICAL}
                                    [/specials]
                                    icon="attacks/bow-elven-magic.png"
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=cold_bow
                                        [/filter_attack]
                                        start_time=-250
                                        missile_start_time=-150

                                        [missile_frame]
                                            duration=150
                                            image="projectiles/missile-n.png"
                                            image_diagonal="projectiles/missile-ne.png"
                                        [/missile_frame]
                                        {SOUND:HIT_AND_MISS bow-puny.ogg bow-puny-miss.ogg -225}
                                    [/attack_anim]
                                [/effect]
                            ) ( ) }
                        [/case]
                        [case]	# Cold bow (cursed)
                            value="cold_bow_cursed"
                            {PLACE_RELIC $i _"Bow" "Cold Bow" yes no
                            ({UNIT_SAYS _"There is a fine bow here, in perfect condition, but no arrows or quivers to be found. I cannot identify its origin, but it does not look to be of elven make."} )
                            (_"Take the bow?")
                            (_"A bow that fires bolts of cold energy") (
                                [effect]
                                    apply_to=new_attack
                                    name=cold_bow_cursed
                                    description=_"feisty cold bow"
                                    type=cold
                                    range=ranged
                                    damage=11
                                    number=3
                                    [specials]
                                        {WEAPON_SPECIAL_MAGICAL}
                                        [heal_on_hit]
                                            id=feisty
                                            name= _ "feisty"
                                            description= _ "Each successful strike with this weapon harms the user for 1 HP"
                                            sub=1
                                        [/heal_on_hit]
                                    [/specials]
                                    icon="attacks/bow-elven-magic.png"
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=cold_bow_cursed
                                        [/filter_attack]
                                        start_time=-250
                                        missile_start_time=-150

                                        [missile_frame]
                                            duration=150
                                            image="projectiles/missile-n.png"
                                            image_diagonal="projectiles/missile-ne.png"
                                        [/missile_frame]
                                        {SOUND:HIT_AND_MISS bow-puny.ogg bow-puny-miss.ogg -225}
                                    [/attack_anim]
                                [/effect]
                            ) (
                                #{ASSIGN_UNIT_VARIABLE $relics.relics_list[$i].x $relics.relics_list[$i].y curse feisty_weapon}
                                #{WF_CALL_FUNCTION curse curse="feisty_weapon"}
                            ) }
                        [/case]
                        [case]	# Arcane sword
                            value="arcane_sword"
                            {PLACE_RELIC $i _"Sword" "Arcane Sword" yes no
                            ({UNIT_SAYS _"There is a beautifully-crafted blade here. It must be magical."} )
                            (_"Take the sword?")
                            (_"A blade with magical energy") (
                                [effect]
                                    apply_to=new_attack
                                    name=arcane_sword
                                    description=_"arcane sword"
                                    type=arcane
                                    range=melee
                                    damage=10
                                    number=4
                                    [specials]
                                        {WEAPON_SPECIAL_MAGICAL}
                                    [/specials]
                                    icon="attacks/sword-holy.png"
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=arcane_sword
                                        [/filter_attack]
                                        start_time=-200
                                        offset=0~0.6:200,0.6~0:200
                                        {SOUND:HIT_AND_MISS {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS} -100}
                                    [/attack_anim]
                                [/effect]
                            ) ( ) }
                        [/case]
                        [case]	# Arcane sword (cursed)
                            value="arcane_sword_cursed"
                            {PLACE_RELIC $i _"Sword" "Arcane Sword" yes no
                            ({UNIT_SAYS _"There is a beautifully-crafted blade here. It must be magical."} )
                            (_"Take the sword?")
                            (_"A blade with magical energy") (
                                [effect]
                                    apply_to=new_attack
                                    name=arcane_sword_cursed
                                    description=_"feisty arcane sword"
                                    type=arcane
                                    range=melee
                                    damage=12
                                    number=4
                                    icon="attacks/sword-holy.png"
                                    [specials]
                                        {WEAPON_SPECIAL_MAGICAL}
                                        [heal_on_hit]
                                            id=feisty
                                            name= _ "feisty"
                                            description= _ "Each successful strike with this weapon harms the user for 1 HP"
                                            sub=1
                                        [/heal_on_hit]
                                    [/specials]
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=arcane_sword_cursed
                                        [/filter_attack]
                                        start_time=-200
                                        offset=0~0.6:200,0.6~0:200
                                        {SOUND:HIT_AND_MISS {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS} -100}
                                    [/attack_anim]
                                [/effect]
                            ) (
                                #{ASSIGN_UNIT_VARIABLE $relics.relics_list[$i].x $relics.relics_list[$i].y curse feisty_weapon}
                                #{WF_CALL_FUNCTION curse curse="feisty_weapon"}
                            )}
                        [/case]
                        # Event only relics
                        [case]	# Potion of experience
                            value="potion_of_experience"
                            {PLACE_RELIC $i _"Potion" "Potion of Experience" no yes
                            {POTION_DIALOGUE}
                            {POTION_OPTION}
                            (_"This potion gives the drinker +20 XP") (
                                # No object effect
                            ) (
                                [sound]
                                    name=potion.ogg
                                [/sound]
                                {UNIT_SAYS _"I feel experienced."}
                                [floating_text]
                                    x=$relics.relics_list[$i].x
                                    y=$relics.relics_list[$i].y
                                    text=_"+20 XP"
                                [/floating_text]
                                [delay]
                                    time=400
                                [/delay]
                                [modify_unit]
                                    [filter]
                                        x=$relics.relics_list[$i].x
                                        y=$relics.relics_list[$i].y
                                    [/filter]
                                    [effect]
                                        apply_to=experience
                                        increase=20
                                    [/effect]
                                [/modify_unit]
                            )}
                        [/case]
                        [else]
                            {DEBUG_MSG _"Unrecognized relic named $relics.relics_list[$i].type . Please report this error in the forums."}
                        [/else]
                    [/switch]
                [/then]
            [/if]
        [/do]
    [/for]

    {CURSE_OF_UNDEAD}
    {LEADER_DROPS_RELIC}
#enddef

#define LEADER_DROPS_RELIC
    [event]
        name=die
        id=leader_drop_relic
        first_time_only=no
        [filter]
            side=2,3,4,5,6,7,8,9
            {FILTER_FOR_LEADER}
        [/filter]
        [filter_second]
            [not]
                side=1
            [/not]
        [/filter_second]

        #{RANDOM_VAR drop_relic (no,yes,yes,yes)}
        {VARIABLE drop_relic yes}
        [for]
            array=relics.relics_list
            reverse=yes
            [do]
                [if]
                    [and]
                        {VARIABLE_CONDITIONAL relics.relics_list[$i].x numerical_equals $x1}
                        {VARIABLE_CONDITIONAL relics.relics_list[$i].y numerical_equals $y1}
                        {VARIABLE_CONDITIONAL relics.relics_list[$i].found boolean_equals no}
                    [/and]
                    [then]
                        #Already have a relic there, don't drop a new one.
                        {VARIABLE drop_relic no}
                        #[break]
                        #[/break]
                    [/then]
                [/if]
            [/do]
        [/for]

        [if]
            {VARIABLE_CONDITIONAL drop_relic boolean_equals yes}
            [then]
                # The dropped relic is setup for this season, but pickable the following season.
                [set_variables]
                    name=relic_list
                    mode=replace

                    {RELIC_ITEMS_CURSED}
                    {RELIC_ITEMS_UNCURSED}
                    #Improve chances of uncursed
                    {RELIC_ITEMS_UNCURSED}
                    {RELIC_ITEMS_UNCURSED}
                    {RELIC_ITEMS_DROP}
                    {RELIC_ITEMS_DROP}
                    {RELIC_ITEMS_DROP}
                [/set_variables]

                {RANDOM_VAR i_relic 0.."$($relic_list.length-1)"}

                # Always bones
                {VARIABLE image1 "items/bones.png"}

                [switch]
                    variable=relic_list[$i_relic].type
                    [case]
                        value="ring_of_regeneration","ring_of_regeneration_cursed","ring_of_regrowth","ring_of_regrowth_cursed","ring_of_resistance_all","ring_of_resistance_blade","ring_of_resistance_impact","ring_of_resistance_pierce","ring_of_resistance_temperature","ring_of_resistance_arcane","ring_of_magnetism","ring_of_magnetism_cursed"
                        {RANDOM_VAR image2 ("items/ring-brown.png","items/ring-gold.png","items/ring-red.png","items/ring-silver.png","items/ring-white.png")}
                    [/case]
                    [case]
                        value="potion_of_strength","potion_of_dexterity","potion_of_stoneskin","potion_of_flight","potion_of_illumination","potion_of_gloom","potion_of_animal_nature","potion_of_experience"
                        {RANDOM_VAR image2 ("items/potion-blue.png","items/potion-green.png","items/potion-grey.png","items/potion-poison.png","items/potion-red.png","items/potion-yellow.png")}
                    [/case]
                    [case]
                        value="sword_of_flame","sword_of_flame_cursed","arcane_sword","arcane_sword_cursed"
                        {RANDOM_VAR image2 ("items/flame-sword.png","items/sword.png")}
                    [/case]
                    [case]
                        value="axe_of_ice","axe_of_ice_cursed"
                        {VARIABLE image2 "items/axe.png"}
                    [/case]
                    [case]
                        value="arcane_bow","arcane_bow_cursed","marksman_bow","marksman_bow_cursed","fire_bow","fire_bow_cursed","cold_bow","cold_bow_cursed"
                        {RANDOM_VAR image2 ("items/bow.png","items/bow-crystal.png","items/bow-elven.png")}
                    [/case]
                [/switch]

                # Insert new relic
                {ASSIGN_RELIC $image1 $image2}

                {CLEAR_VARIABLE relic_list}
                {CLEAR_VARIABLE i_relic}
                {CLEAR_VARIABLE image1}
                {CLEAR_VARIABLE image2}
            [/then]
        [/if]
        {CLEAR_VARIABLE drop_relic}
    [/event]
#enddef

# ----- Initial selection of relics --------------------------------------
#define SELECT_RELICS
    # Used to choose and place the relics at the beginning of the first scenario
    # Placed in this file at least temporarily so I don't have to hunt it down
    # to work on it. Should be placed in a prestart event
    [set_variables]
        name=relics.relics_list
        mode=replace
    [/set_variables]
    [set_variables]		# Note that frequency of appearance in this list determines
        name=relic_list	# the likelihood of appearance in the game
        mode=replace

        {RELIC_ITEMS_START}

        # maybe some other bows - a marksman one?
        # arcane sword
        # potion that appears to do nothing, but makes you come back as a shadow or something
        # {VALUE1 type "speed"}
        # {VALUE1 type "marksman"}
        # {VALUE1 type "holy water"}
        # -give steadfast

        # Mixed / cursed:
        # increase blade resistance a lot, decrease impact (or vice versa)
        # -minus 1 or 2 health per turn, possibly with flame/ice sword (wait a few turns first), or injure on attack
        # -teleport (ability), with random teleporting occurring every 15-20 turns or so
        # chameleon - resistances or maybe defense is set randomly every turn or two
        # books? or maybe magic balls
    [/set_variables]

    {RANDOM_VAR i_max "$({NUM_RELICS}-2)".."{NUM_RELICS}"}
    #{VARIABLE i_max 20}
    {VARIABLE i 0}
    [while]
        {VARIABLE_CONDITIONAL i less_than $i_max}
        [do]
            # Find a suitable location and change the map as needed.
            # The cave terrain requires some handling to place walls and
            # ensure it's accessible
            # Terrain checking always occurs in the spring
            # No swamp castles, as swamp terrain is rare and I don't want
            # two relics next to each other
            # I'm also avoiding the map edges, as this seems to lead to odd behavior
            {RANDOM_VAR terrain_new ("Chr","Chr","Chr","Gg","Gg","Gg","Chw")}
            # Maybe add hills and/or mountains at some point
            [switch]
                variable=terrain_new
                #[case]
                #	value="Uu"
                #	# TODO: deal with cave stuff here
                #	[store_locations]
                #		variable=loc_store
                #		x={BORDER}-"$({MAP_WIDTH}-{BORDER})"
                #		y={BORDER}-"$({MAP_HEIGHT}-{BORDER})"
                #	[/store_locations]
                #[/case]
                [case]	# Ruined castles go pretty much anywhere
                    value="Chr"
                    [store_locations]
                        variable=loc_store
                        terrain=Gg,Gg^E*,*^F*,H*,H*^E*,M*,M*^E*
                        x={BORDER}-"$({MAP_WIDTH}-{BORDER})"
                        y={BORDER}-"$({MAP_HEIGHT}-{BORDER})"
                    [/store_locations]
                [/case]
                [case]	# Water castles go in the water, near shore
                    value="Chw"
                    [store_locations]
                        variable=loc_store
                        terrain=Ww,Ss
                        x={BORDER}-"$({MAP_WIDTH}-{BORDER})"
                        y={BORDER}-"$({MAP_HEIGHT}-{BORDER})"
                        [filter_adjacent_location]
                            terrain=W*,Ss
                            count=1-3
                        [/filter_adjacent_location]
                    [/store_locations]
                [/case]
                [case]	# Plains cannot be placed on hills or mountains
                    value="Gg"
                    [store_locations]
                        variable=loc_store
                        terrain=Gg,Gg^E*,G*^F*
                        x={BORDER}-"$({MAP_WIDTH}-{BORDER})"
                        y={BORDER}-"$({MAP_HEIGHT}-{BORDER})"
                    [/store_locations]
                [/case]
            [/switch]
            {RANDOM_VAR i_loc 0.."$($loc_store.length-1)"}
            {VARIABLE x1 $loc_store[$i_loc].x}
            {VARIABLE y1 $loc_store[$i_loc].y}
            {MODIFY_TERRAIN $terrain_new $x1 $y1}

            # Choose relic types and set variables
            {RANDOM_VAR i_relic 0.."$($relic_list.length-1)"}
            # Each [case] block should Set the relics variable so moveto events
            # can be created: set values .name, .description, .image1 (ground),
            # image2 (item)
            [switch]
                variable=relic_list[$i_relic].type
                [case]
                    value="ring_of_regeneration","ring_of_regeneration_cursed","ring_of_regrowth","ring_of_regrowth_cursed","ring_of_resistance_all","ring_of_resistance_blade","ring_of_resistance_impact","ring_of_resistance_pierce","ring_of_resistance_temperature","ring_of_resistance_arcane","ring_of_magnetism","ring_of_magnetism_cursed"
                    {PICK_RANDOM_IMAGES ("items/ring-brown.png","items/ring-gold.png","items/ring-red.png","items/ring-silver.png","items/ring-white.png") "ring"}
                [/case]
                [case]
                    value="potion_of_strength","potion_of_dexterity","potion_of_stoneskin","potion_of_flight","potion_of_illumination","potion_of_gloom","potion_of_animal_nature","potion_of_experience"
                    {PICK_RANDOM_IMAGES ("items/potion-blue.png","items/potion-green.png","items/potion-grey.png","items/potion-poison.png","items/potion-red.png","items/potion-yellow.png") "potion"}
                    #[if] # Potions just laying around don't make much sense
                    #	{VARIABLE_CONDITIONAL terrain_new equals "Gg"}
                    #	[then]
                    #		{VARIABLE image1 "items/leather-pack.png"}
                    #	[/then]
                    #	[else]
                    #		[if] # Potions on skeletons don't make much sense
                    #			{VARIABLE_CONDITIONAL image1 equals "items/bones.png"}
                    #			[then]
                    #				{VARIABLE image1 $image2}
                    #			[/then]
                    #		[/if]
                    #	[/else]
                    #[/if]
                [/case]
                [case]
                    value="sword_of_flame","sword_of_flame_cursed","arcane_sword","arcane_sword_cursed"
                    {PICK_RANDOM_IMAGES ("items/flame-sword.png","items/sword.png") "sword"}
                    #{VARIABLE image2 "items/flame-sword.png"}	# always use this one
                [/case]
                [case]
                    value="axe_of_ice","axe_of_ice_cursed"
                    {PICK_RANDOM_IMAGES ("items/axe.png") "axe"}
                [/case]
                [case]
                    value="arcane_bow","arcane_bow_cursed","marksman_bow","marksman_bow_cursed","fire_bow","fire_bow_cursed","cold_bow","cold_bow_cursed"
                    {PICK_RANDOM_IMAGES ("items/bow.png","items/bow-crystal.png","items/bow-elven.png") "bow"}
                [/case]
            [/switch]

            {ASSIGN_RELIC $image1 $image2}

            # Ensure no duplicates by deleting the chosen relic type
            {CLEAR_VARIABLE relic_list[$i_relic]}
            {VARIABLE_OP i add 1}
        [/do]
    [/while]
    {CLEAR_VARIABLE relic_list}
    {CLEAR_VARIABLE i_relic}
    {CLEAR_VARIABLE loc_store}
    {CLEAR_VARIABLE i_loc}
    {CLEAR_VARIABLE image1}
    {CLEAR_VARIABLE image2}
    {CLEAR_VARIABLE terrain_orig}
    {CLEAR_VARIABLE terrain_new}
    {CLEAR_VARIABLE i}
    {CLEAR_VARIABLE i_max}
#enddef

#define ASSIGN_RELIC IMAGE_GND IMAGE_ITEM
    # This should ONLY be called from inside a [case] in the SELECT_RELIC
    # macro. It will fail hard elsewhere.
    {RANDOM_VAR str_i 0..2}		# pick between description strings
    [set_variables]
        name=relics.relics_list
        mode=append
        [value]
            found=no
            type=$relic_list[$i_relic].type
            x,y=$x1,$y1
            image_gnd={IMAGE_GND}
            image_item={IMAGE_ITEM}
            str_i=$str_i
            label=""
        [/value]
    [/set_variables]
    {CLEAR_VARIABLE str_i}
#enddef

# ----- Item-type specific stuff -------------------------------------
# ----- Specific (but repeated) item events -----
#define CURSE_OF_UNDEAD
    # Undead / regeneration curse:
    [event]
        #name=side 2 turn end
        name=curse_of_undead
        id=curse_of_undead
        first_time_only=no

        # Spawn undead on identified bones
        [for]
            array=relics.relics_list
            reverse=yes
            [do]
                [if]
                    {VARIABLE_CONDITIONAL relics.relics_list[$i].found boolean_equals no}
                    {VARIABLE_CONDITIONAL relics.relics_list[$i].label not_equals ""}
                    {VARIABLE_CONDITIONAL relics.relics_list[$i].image_gnd equals "items/bones.png"}
                    [then]
                        {RANDOM_VAR turn_test 1..5}
                        [if]
                            {VARIABLE_CONDITIONAL turn_test numerical_equals 1}
                            [have_unit]
                                side=2
                                #role=curse
                                #status=guardian
                                x=$relics.relics_list[$i].x
                                y=$relics.relics_list[$i].y
                                count=0
                            [/have_unit]
                            [then]
                                {SCROLL_TO $relics.relics_list[$i].x $relics.relics_list[$i].y}
                                {RANDOM_VAR curse_type ("Walking Corpse","Ghost","Skeleton","Skeleton Archer","Soulless")}
                                [sound]	# warn the player who is paying attention (and has the sound on)
                                    name="petrified.ogg"
                                [/sound]
                                [unit]
                                    animate=yes
                                    passable=yes
                                    placement=map
                                    random_traits=yes
                                    side=2
                                    role=curse
                                    type=$curse_type
                                    x=$relics.relics_list[$i].x
                                    y=$relics.relics_list[$i].y
                                    ai_special=guardian
                                    {MOD_OBJECT_LOYAL}
                                [/unit]
                                [capture_village]
                                    [filter]
                                        side=2
                                        role=curse
                                    [/filter]
                                    fire_event=no
                                [/capture_village]
                                {CLEAR_VARIABLE curse_type}
                                [unhide_unit]
                                [/unhide_unit]
                            [/then]
                        [/if]
                        {CLEAR_VARIABLE turn_test}
                    [/then]
                [/if]
            [/do]
        [/for]

        [if]
            [have_unit]
                {FILTER_FOR_CURSE undead_generator}
            [/have_unit]
            [then]
                #{VARIABLE turn_test "$($turn_number%3)"} # this sets the frequency
                {RANDOM_VAR turn_test 1..5}
                [if]
                    {VARIABLE_CONDITIONAL turn_test numerical_equals 1}
                    [then]
                        [store_unit]
                            variable=curse_store
                            [filter]
                                {FILTER_FOR_CURSE undead_generator}
                            [/filter]
                        [/store_unit]
                        [foreach]
                            array=curse_store
                            [do]
                                {SCROLL_TO $this_item.x $this_item.y}
                                {RANDOM_VAR curse_type ("Walking Corpse","Ghost","Skeleton","Skeleton Archer","Soulless")}
                                [sound]	# warn the player who is paying attention (and has the sound on)
                                    name="petrified.ogg"
                                [/sound]
                                [unit]
                                    animate=yes
                                    passable=yes
                                    placement=map
                                    random_traits=yes
                                    side=2
                                    role=curse
                                    type=$curse_type
                                    x,y=$this_item.x,$this_item.y # actually will just place near here, as this is occupied
                                    ai_special=guardian
                                    {MOD_OBJECT_LOYAL}
                                [/unit]
                                [capture_village]
                                    [filter]
                                        side=2
                                        role=curse
                                    [/filter]
                                    fire_event=no
                                [/capture_village]
                                {CLEAR_VARIABLE curse_type}
                                [unhide_unit]
                                [/unhide_unit]
                                [fire_event]
                                    name=undead_curse_commentary
                                    [primary_unit]
                                        x,y=$this_item.x,$this_item.y
                                    [/primary_unit]
                                [/fire_event]
                            [/do]
                        [/foreach]
                        {CLEAR_VARIABLE curse_store}
                    [/then]
                [/if]
                {CLEAR_VARIABLE turn_test}
            [/then]
        [/if]
    [/event]

    {HIST_EVENT undead_curse (
        [event]
            name=undead_curse_commentary
            id=undead_curse_commentary
            first_time_only=yes	# this gets re-instated each season, so need to check the history
            {DIALOGUE undead_curse (
                {UNIT_SAYS _"Aaah! Where did that thing come from?"}
                # the second sentence here might be untrue in very specific instances, but I don't care
                {HERO_SAYS _"It looked as if it 'twas pulled from the earth itself, but I see no sign of a necromancer nearby."}
                {UNIT_SAYS _"I would not decline some help making sure it is put back in the earth, where it belongs!"} )}
            [/event]
        )}
#enddef

# ----- Dialogue for different item types ------
# Dialogue macros should have two parts: discussion and option
#define RING_DIALOGUE
    {UNIT_SAYS _"I have found a small glowing ring. What should I do with it, milord?"}
    {HERO_SAYS _"Well, put it on and see if it does anything!"}
#enddef

#define RING_OPTION
    _"Put on the ring?"
#enddef

#define POTION_DIALOGUE
    {UNIT_SAYS _"There are a few broken bottles here, but one small vial remains intact and has some sort of liquid inside."}
    {HERO_SAYS _"Well, aren't you going to drink it?"}
#enddef

#define POTION_OPTION
    _"Drink the potion?"
#enddef

# ----- Random image picking -----------------------------------------
#define PICK_RANDOM_IMAGES LIST KEYWORD
    [if]
        {VARIABLE_CONDITIONAL terrain_new equals "Gg"}
        [then] # on the plains or in the forest
            #[set_variable]
            #	name=image1
            #	rand="items/bones.png,items/leather-pack.png"
            #[/set_variable]
            {VARIABLE image1 "items/leather-pack.png"}
            {RANDOM_VAR image2 {LIST}}
        [/then]
        [else] # in a run-down castle or cave
            [set_variable]
                name=image1
                rand="items/barrel.png","items/coffin-closed.png","items/chest.png","items/chest-plain-closed.png",{LIST}
            [/set_variable]
            [if]
                {VARIABLE_CONDITIONAL image1 contains {KEYWORD}}
                [then]
                    {VARIABLE image2 $image1}
                [/then]
                [else]
                    {RANDOM_VAR image2 {LIST}}
                [/else]
            [/if]
        [/else]
    [/if]
#enddef

# ----- Utility macros ---------------------------------------------------
#define FILTER_FOR_CURSE CURSE
    #side=1
    #[filter_wml]
    #	[variables]
    #		curse={CURSE}
    #	[/variables]
    #[/filter_wml]
    #formula="wml_vars.curse='{CURSE}'"
    status={CURSE}
    #formula="status=['{CURSE}']"
#enddef

#define PLACE_RELIC INDEX TYPE NAME TAKE_ONCE EVENT_ONLY TALK_WML OPTION_STRING DESCRIPTION EFFECT_WML POST_WML
    # I've modified the "pickuppable_item" macro here to make to use the existing
    # variable and allow multiple lines of dialog. Additional dialog can be added
    # after the effect has been applied
    # INDEX = index # of relics where info is stored
    # TALK_WML = all pre-pickup messages between various units
    # OPTION_STRING = question unit asks, e.g. "Should I put on the ring, milord?"
    # EFFECT_WML = effects of the item on the unit
    [item]
        x,y=$relics.relics_list[{INDEX}].x,$relics.relics_list[{INDEX}].y
        image=$relics.relics_list[{INDEX}].image_gnd
    [/item]
    [label]
        x,y=$relics.relics_list[{INDEX}].x,$relics.relics_list[{INDEX}].y
        text=$relics.relics_list[{INDEX}].label
    [/label]
    [event]	# Dialogue for your cowardly leader
        name=moveto
        id=moveto_leader_relic_{INDEX}
        first_time_only=no
        delayed_variable_substitution=no	# this is necessary to get event to fire at all
        [filter]
            side=1
            id=Hero
            x,y=$relics.relics_list[{INDEX}].x,$relics.relics_list[{INDEX}].y
        [/filter]
        [if]
            {HAVE_ADVISOR}
            [or]
                {HAVE_CYNIC}
            [/or]
            [or]
                {HAVE_FOOL}
            [/or]
            [then]
                [store_unit]
                    variable=advisor_unit
                    [filter]
                        role=advisor
                        [or]
                            role=cynic
                        [/or]
                        [or]
                            role=fool
                        [/or]
                    [/filter]
                [/store_unit]
                {RANDOM_VAR rnd_i 0.."$|($|advisor_unit.length-1)"}
                {HERO_SAYS _"There is something peculiar about this area. $|advisor_unit[$|rnd_i].name, you should investigate it further."}
                {SPEAKER_SAYS $|advisor_unit[$|rnd_i].id  _"Me, milord?"}
                {HERO_SAYS _"Well, we cannot just have one of the peasants mucking about with something potentially dangerous, now can we?"}
                {CLEAR_VARIABLE advisor_unit,rnd_i}
            [/then]
            [else]	# no advisor, unlikely to be other roles
                {HERO_SAYS _"There is something peculiar about this area. I shall send someone to investigate it later."}
            [/else]
        [/if]
    [/event]
    [event]
        name=moveto
        id=moveto_relic_{INDEX}
        first_time_only=no
        delayed_variable_substitution=no	# this is necessary to get event to fire at all
        [filter]
            side=1
            [not]
                id=Hero
            [/not]
            x,y=$relics.relics_list[{INDEX}].x,$relics.relics_list[{INDEX}].y
        [/filter]
        [if]
            {VARIABLE_CONDITIONAL relics.relics_list[{INDEX}].found boolean_equals no}
            [then]
                [if]
                    {VARIABLE_CONDITIONAL relics.relics_list[{INDEX}].seen boolean_not_equals yes}
                    [then]
                        # 0 => wizard
                        # 1 => adventurer / battle
                        # 2 => animal nest
                        # ----- First the narrator describes the terrain -----
                        [store_locations]
                            variable=relic_terrain
                            x,y=$relics.relics_list[{INDEX}].x,$relics.relics_list[{INDEX}].y
                        [/store_locations]
                        [switch]
                            variable=relic_terrain.terrain
                            [case]	# Ruined castle/tower
                                value=Chr
                                [switch]
                                    variable=relics.relics_list[{INDEX}].str_i
                                    [case]
                                        value=0
                                        {NARRATOR_SAYS _"A weather-worn tower of slowly crumbling stonework still stand high above the surrouding landscape. Cautiously ascending the spiraling staircase inside leads to the remains of a rotting door on the top floor. Removing it reveals what appears to have been a wizard's workshop. Tables are filled with both intact and shattered bottles of crudely-blown glass. A few papers with cryptic symbols been incorporated into a bird's nest in a corner."}
                                    [/case]
                                    [case]
                                        value=1
                                        {NARRATOR_SAYS _"A few strongly-listing walls of large grey stones are all that remain of what must once have been a small but imposing fortress. Some brush partially hides a stone staircase decending into dank storerooms beneath the outpost."}
                                    [/case]
                                    [case]
                                        value=2
                                        {NARRATOR_SAYS _"Only the base of this stone watchtower remains intact; what must have been the roof lies in a pile of weathered grey stone just outside the south wall. The second floor appears to be a popular nesting place for the local crows."}
                                    [/case]
                                [/switch]
                            [/case]
                            [case]	# Sunken ruined castle
                                value=Chw
                                [switch]
                                    variable=relics.relics_list[{INDEX}].str_i
                                    [case]
                                        value=0
                                        {NARRATOR_SAYS _"Although water now laps at the walls of this crumbling fortress, the upper rooms of the corner towers remain dry. In one, the stone shelves bear an odd assortment of rusting daggers, rotted books, and colorful but valueless gemstones."}
                                    [/case]
                                    [case]
                                        value=1
                                        {NARRATOR_SAYS _"Once surely on the shore, generations of gentle pushing by rising waters have felled two of the six walls of this outpost. Rusting shields, axe heads, and the occasional humanoid bone testify to the ferocity of the final battle fought here."}
                                    [/case]
                                    [case]
                                        value=2
                                        {NARRATOR_SAYS _"Surprisingly intact given how much of them are below the water line, these walls likely once guarded a tiny village. Now they guard schools of small fish and a nest of dangerous-looking eels."}
                                    [/case]
                                [/switch]
                            [/case]
                            [case]	# Snow (these are all kind of similar)
                                value=Aa
                                [switch]
                                    variable=relics.relics_list[{INDEX}].str_i
                                    [case]
                                        value=0
                                        {NARRATOR_SAYS _"Trudging through the endless drifts, your soldier happens to kick an object beneath the snow."}
                                    [/case]
                                    [case]
                                        value=1
                                        {NARRATOR_SAYS _"Following an unnaturally-strong hunch, your soldier walks to a particular snow drift and begins to dig."}
                                    [/case]
                                    [case]
                                        value=2
                                        {NARRATOR_SAYS _"After nearly tripping over something buried in the snow, your soldier digs away some snow to investigate."}
                                    [/case]
                                [/switch]
                            [/case]
                            [else]	# Plains, done as [else] in case you build a structure over a relic or something
                                [switch]
                                    variable=relics.relics_list[{INDEX}].str_i
                                    [case]
                                        value=0
                                        {NARRATOR_SAYS _"The faint remains of a dirt path through the grasslands are the only evidence of habitation."}
                                    [/case]
                                    [case]
                                        value=1
                                        {NARRATOR_SAYS _"Rusting spear tips, arrowheads, and armor buckles indicate that this was once the site of a large battle. The few intact skulls suggest that none of the participants were humans. Given the disarray of the skeletons, it is not clear that whether either side won."}
                                    [/case]
                                    [case]
                                        value=2
                                        {NARRATOR_SAYS _"Enormous spiderwebs and animal skeletons fill a secluded hollow near a small stream. Carefully, to avoid being caught in the webs or suprised by a returning beast, your soldier investigates."}
                                    [/case]
                                [/switch]
                            [/else]
                        [/switch]

                        # ----- Next unit or narrator describes the relic "container" -----
                        # These [if]s are mutually exclusive -- no need to nest them
                        # Images that don't match these keywords just won't have a
                        # message here, which should be fine.
                        [if]	# leather pack
                            {VARIABLE_CONDITIONAL relics.relics_list[{INDEX}].image_gnd contains "pack"}
                            [then]
                                [switch]
                                    variable=relics.relics_list[{INDEX}].str_i
                                    [case]
                                        value=0
                                        {UNIT_SAYS _"There's a large leather pack here, and in perfect condition! It is not particularly heavy, but there seem to be a number of things inside. It feels... important... somehow."}
                                    [/case]
                                    [case]
                                        value=1
                                        {UNIT_SAYS _"There is something strange about this tiny bag. Not only is it glowing a faint blue, but it seems to be larger on the inside that it is on the outside!"}
                                    [/case]
                                    [case]
                                        value=2
                                        {NARRATOR_SAYS _"Tucked away under a small bush is a leather satchel, cracked with age. The strap pulls away from bag as the soldier tries to pick it up."}
                                    [/case]
                                [/switch]
                            [/then]
                        [/if]
                        [if]	# Bones - these appear in both castles and plains. It's not really possible to write for both
                            {VARIABLE_CONDITIONAL relics.relics_list[{INDEX}].image_gnd contains "bones"}
                            [then]
                                [switch]	# Done as a switch in case I feel masochistic later and want to write more dialogue
                                    variable=relic_terrain.terrain
                                    [case]
                                        value=Chr,Chw,Uu
                                        [switch]
                                            variable=relics.relics_list[{INDEX}].str_i
                                            [case]
                                                value=0
                                                {NARRATOR_SAYS _"A mostly-intact skeleton lies on the floor. While its lack of burial is certainly curious, nothing in its position or in the room hints of a violent end. The finger bones of the left hand clench tightly about an object."}
                                            [/case]
                                            [case]
                                                value=1
                                                {UNIT_SAYS _"There was a pile of bones in a corner, but something about the way it was stacked didn't look quite right. Turns out, the pile was sitting on something interesting."}
                                            [/case]
                                            [case]
                                                value=2
                                                {NARRATOR_SAYS _"A glint of light from the nest catches the soldier's eye. Looking closer clearly reveals human hand-bones clutching a shiny object."}
                                            [/case]
                                        [/switch]
                                    [/case]
                                    [else]	# bones in the grass or snow or farm
                                        [switch]
                                            variable=relics.relics_list[{INDEX}].str_i
                                            [case]
                                                value=0
                                                {NARRATOR_SAYS _"A diminuitive skeleton, bones bleached a stark white by the sun, lies on the ground. What caused the man or elf to die here in the desolate emptiness of the plains, with few predators and no way for outlaws to stage an ambush, is a mystery. A object glows weakly under its ribcage, apparently the dead traveler's only possession to withstand the ravages of time and weather."}
                                            [/case]
                                            [case]
                                                value=1
                                                {UNIT_SAYS _"Without a doubt, the owner of this skeleton was once a warrior. Huge shoulders, remnants of some fancy armor, and the bones of a lot of smaller fighters all around him. Of course, there's also a battle-axe through the back of his skull. He still seems to be holding something in his hand, though."}
                                            [/case]
                                            [case]
                                                value=2
                                                {UNIT_SAYS _"This corpse was probably a man, although it has been picked clean by animals. Looks like his leg bones have been carried away too, probably by an enterprising wolf. There's something interesting by his side, though."}
                                            [/case]
                                        [/switch]
                                    [/else]
                                [/switch]
                            [/then]
                        [/if]
                        [if]	# Chest - only appears in castle/cave
                            {VARIABLE_CONDITIONAL relics.relics_list[{INDEX}].image_gnd contains "chest"}
                            [then]
                                [switch]
                                    variable=relics.relics_list[{INDEX}].str_i
                                    [case]
                                        value=0
                                        {NARRATOR_SAYS _"On a shelf sits an ornate lacquered box with gold inlay, somehow missed by generations of looters. Opening it displaces an thick film of dust and sends at least one rat scurrying away."}
                                    [/case]
                                    [case]
                                        value=1
                                        {NARRATOR_SAYS _"In a hidden alcove now revealed by a crumbling wall lies a large box made of rotting wood. Once locked, the latch has fallen off and now lies on the ground."}
                                    [/case]
                                    [case]
                                        value=2
                                        {UNIT_SAYS _"Looks like just about the only thing the animals haven't gotten into here is this iron-bound chest. If the hinges haven't completely rusted together, I should be able to open it."}
                                        {UNIT_SAYS _"Ooofff."}
                                    [/case]
                                [/switch]
                            [/then]
                        [/if]
                        {CLEAR_VARIABLE relic_terrain}

                        {TUTORIAL first_relic_found _"You have found a magical artifact, perhaps left behind by a reclusive mage or a fallen adventurer. There will be several such items scattered about the map. While all artifacts you find in Wild Frontiers have benefits for the units that pick them up, some will also have significant negative effects. These negative effects may not be immediately apparent.

You are advised to only pick up magical items with units you deem to be 'expendable'."}
                    [/then]
                [/if]

                # ----- Thirdly the unit describes the relic itself, text from setup macro -----
                {VARIABLE take_once_relic {TAKE_ONCE}}
                {VARIABLE event_only_relic {EVENT_ONLY}}
                {VARIABLE relics.relics_list[{INDEX}].seen yes}
                {VARIABLE unit_has_item no}
                [foreach]
                    array=unit.modifications.object
                    [do]
                        [if]
                            {VARIABLE_CONDITIONAL this_item.name equals {NAME}}
                            [then]
                                {VARIABLE unit_has_item yes}
                            [/then]
                        [/if]
                    [/do]
                [/foreach]
                [if]
                    {VARIABLE_CONDITIONAL take_once_relic boolean_equals no}
                    [then]
                        {VARIABLE unit_has_item no}
                    [/then]
                [/if]
                [if]
                    {VARIABLE_CONDITIONAL event_only_relic boolean_equals yes}
                    [then]
                        {VARIABLE unit_has_item no}
                    [/then]
                [/if]
                [if]
                    {VARIABLE_CONDITIONAL unit_has_item boolean_equals no}
                    [then]
                        {TALK_WML}
                        [message]
                            speaker=unit
                            message={OPTION_STRING}
                            [option]
                                label=_"Yes"
                                [command]
                                    {VARIABLE give_overlay yes}
                                    [store_unit]
                                        [filter]
                                            x,y=$relics.relics_list[{INDEX}].x,$relics.relics_list[{INDEX}].y
                                        [/filter]
                                        kill=no
                                        variable=unit_store
                                        mode=always_clear
                                    [/store_unit]
                                    [for]
                                        array=unit_store.modifications.object
                                        reverse=yes
                                        [do]
                                            [if]
                                                {VARIABLE_CONDITIONAL unit_store.modifications.object[$|i].id equals "pickable_overlay"}
                                                [then]
                                                    {VARIABLE give_overlay no}
                                                [/then]
                                            [/if]
                                        [/do]
                                    [/for]
                                    {CLEAR_VARIABLE unit_store}
                                    [if]
                                        {VARIABLE_CONDITIONAL event_only_relic boolean_equals yes}
                                        [then]
                                            {VARIABLE give_overlay no}
                                        [/then]
                                    [/if]
                                    [if]
                                        {VARIABLE_CONDITIONAL give_overlay boolean_equals yes}
                                        [then]
                                            [object]
                                                id="pickable_overlay"
                                                take_only_once=no
                                                [effect]
                                                    apply_to=overlay
                                                    add=misc/pickable-overlay.png
                                                [/effect]
                                            [/object]
                                        [/then]
                                    [/if]
                                    {CLEAR_VARIABLE give_overlay}
                                    # ----- And finally we get to the actual relic -----
                                    [if]
                                        {VARIABLE_CONDITIONAL event_only_relic boolean_equals no}
                                        [then]
                                            {VARIABLE relic_id {NAME}}
                                            {RANDOM_VAR unit_has_item_count "1..99999"}
                                            {VARIABLE relic_id "$relic_name| $unit_has_item_count|"}
                                            [object]
                                                #duration=forever
                                                name={NAME}
                                                id=$relic_name
                                                image=$relics.relics_list[{INDEX}].image_item
                                                description={DESCRIPTION}
                                                take_only_once=no
                                                {EFFECT_WML}
                                            [/object]
                                            {CLEAR_VARIABLE relic_id}
                                            {CLEAR_VARIABLE unit_has_item_count}
                                        [/then]
                                    [/if]
                                    [remove_item]
                                        x,y=$relics.relics_list[{INDEX}].x,$relics.relics_list[{INDEX}].y
                                        image=$relics.relics_list[{INDEX}].image_gnd
                                    [/remove_item]
                                    [label]
                                        x,y=$relics.relics_list[{INDEX}].x,$relics.relics_list[{INDEX}].y
                                        text=""
                                    [/label]
                                    {VARIABLE relics.relics_list[{INDEX}].found yes}
                                    {POST_WML}
                                    [remove_event]
                                        id=moveto_leader_relic_{INDEX}
                                    [/remove_event]
                                    [remove_event]
                                        id=moveto_relic_{INDEX}
                                    [/remove_event]
                                [/command]
                            [/option]
                            [option]
                                label=_"No"
                                [command]
                                    {UNIT_SAYS _"I am wary of magical items, milord. Perhaps another might be better-suited to examine this."}
                                    #{HERO_SAYS _"Bah! Perhaps another might be braver."}
                                    {SCROLL_TO $relics.relics_list[{INDEX}].x $relics.relics_list[{INDEX}].y}
                                    [if]
                                        {VARIABLE_CONDITIONAL wf_vars.prisoner_bonus greater_than 0}
                                        [then]
                                            {VARIABLE relics.relics_list[{INDEX}].label {NAME}}
                                            [label]
                                                x,y=$relics.relics_list[{INDEX}].x,$relics.relics_list[{INDEX}].y
                                                text={NAME}
                                            [/label]
                                        [/then]
                                    [/if]
                                    [if]
                                        {VARIABLE_CONDITIONAL relics.relics_list[{INDEX}].label equals ""}
                                        [then]
                                            {VARIABLE relics.relics_list[{INDEX}].label {TYPE}}
                                            [label]
                                                x,y=$relics.relics_list[{INDEX}].x,$relics.relics_list[{INDEX}].y
                                                text={TYPE}
                                            [/label]
                                        [/then]
                                    [/if]
                                [/command]
                            [/option]
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=unit
                            message=_"I already have this, better leave it for someone else."
                        [/message]
                        {VARIABLE relics.relics_list[{INDEX}].label {NAME}}
                        [label]
                            x,y=$relics.relics_list[{INDEX}].x,$relics.relics_list[{INDEX}].y
                            text={NAME}
                        [/label]
                    [/else]
                [/if]
                {CLEAR_VARIABLE unit_has_item}
                {CLEAR_VARIABLE take_once_relic}
                {CLEAR_VARIABLE event_only_relic}
            [/then]
        [/if]
    [/event]
#enddef
