#textdomain wesnoth-Wild_Frontiers

#define TRAINING_COURSE_REPORT
    {VARIABLE final_cost 0}
    [store_unit]
        [filter]
            side=1
            [not]
                type=Caravan,Peasant_no_Advance,Woodsman_no_Advance,Ruffian_no_Advance
            [/not]
            status=training
            [filter_location]
                terrain=*^Yf,*^Yfo,*^Yb,*^Ybo,*^Ys,*^Yso,*^Yu,*^Yuo,*^Ya,*^Yao
            [/filter_location]
        [/filter]
        variable=unit_store
        mode=always_clear
    [/store_unit]
    [for]
        array=unit_store
        reverse=yes
        [do]
            {VARIABLE training_cost $wf_vars.training_level}
            {VARIABLE_OP training_cost multiply $unit_store[$i].level}
            [if]
                {VARIABLE_CONDITIONAL unit_store[$i].upkeep equals "full"}
                {VARIABLE_CONDITIONAL unit_store[$i].canrecruit equals no}
                [then]
                    {VARIABLE_OP training_cost add 5}
                [/then]
            [/if]
            [if]
                {VARIABLE_CONDITIONAL unit_store[$i].canrecruit equals yes}
                [then]
                    {VARIABLE_OP training_cost add 10}
                [/then]
            [/if]
            {VARIABLE_OP final_cost add $training_cost}
            {CLEAR_VARIABLE training_cost}
        [/do]
    [/for]
    {CLEAR_VARIABLE unit_store}
    [message]
        speaker=narrator
        image=portraits/linaera.png
        message=_"As it stands, the training courses might cost around $final_cost| gold per turn."
    [/message]
    {CLEAR_VARIABLE final_cost}
#enddef

#define DIPLOMACY_FACTION_UNLOCK FACTION
    {VARIABLE quota.diplomacy_bonus_{FACTION} no}
    {VARIABLE quota.diplomacy_recruit_{FACTION} no}

    [if]
        {VARIABLE_CONDITIONAL diplomacy.{FACTION}_state greater_than_equal_to 10}
        [then]
            {VARIABLE quota.diplomacy_bonus_{FACTION} yes}
        [/then]
    [/if]

    [if]
        {VARIABLE_CONDITIONAL diplomacy.{FACTION}_state greater_than_equal_to 5}
        [then]
            {VARIABLE quota.diplomacy_recruit_{FACTION} yes}
        [/then]
    [/if]
#enddef

#define WF_DIPLOMACY_MENU
    #[event]
    #	name=prestart
    #	[set_menu_item]
    #	id=start_diplomacy
    #	description=_"Hire mercenaries"
    #	[show_if]
    #		[have_unit]
    #			id=Hero
    #			x,y=$x1,$y1
    #		[/have_unit]
    #		[have_location]
    #			x,y=$x1,$y1
    #			terrain=*^Yu*
    #		[/have_location]
    #	[/show_if]
    #	[command]
    [fire_event]
        name=diplomacy_refresh
    [/fire_event]
    [while]
        [true][/true]
        [do]
            {STORE_GOLD}
            {DIPLOMACY_FACTION_UNLOCK drakes}
            {DIPLOMACY_FACTION_UNLOCK dunefolk}
            {DIPLOMACY_FACTION_UNLOCK dwarves}
            {DIPLOMACY_FACTION_UNLOCK elves}
            {DIPLOMACY_FACTION_UNLOCK loyalists}
            {DIPLOMACY_FACTION_UNLOCK orcs}
            {DIPLOMACY_FACTION_UNLOCK outlaws}
            {DIPLOMACY_FACTION_UNLOCK undead}
            [message]
                speaker=unit
                message=_"Quest for ..."
                [option]
                    label=_"Nevermind"
                    default=yes
                    [command]
                        [break][/break]
                    [/command]
                [/option]
                [option]
                    label=_"Spymaster report"
                    [command]
                        {FIRE_EVENT spymaster_report}
                        [message]
                            speaker=narrator
                            image=portraits/linaera.png
                            message=_"Our spymaster reports that we are likely to get raided up to ...
$quota.outlaws| times by Outlaws. Chance of next raid is $relations.outlaws_nice|%.
$quota.outlaws| times by Bandits. Chance of next raid is $relations.outlaws_mean|%.

$quota.elves| times by Rogue Elves. Chance of next raid is $relations.trees|%.
$quota.dwarves| times by Rogue Dwarves. Chance of next raid is $relations.hills|%.

$quota.orc_raids| times by Orcish Hordes. Chance of next raid is $relations.orc_raids|%.
$quota.undead_raids| times by Necromancers. Chance of next raid is $relations.undead_raids|%.

$quota.calamity|

New King's patrol support chance is $relations.king|%.

Wild animals are $quota.animal_units| strong and $quota.animal_hitpoints| in strength.
Wild guardians are $quota.guardian_units| strong and $quota.guardian_hitpoints| in strength.
Raiders are $quota.enemy_units| strong and $quota.enemy_hitpoints| in strength.
Allies are $quota.ally_units strong and $quota.ally_hitpoints| in strength."
                        [/message]
                    [/command]
                [/option]
                [option]
                    label=_"Farms and Peasant workers report"
                    [command]
                        [store_unit]
                            [filter]
                                side=1
                                type=Peasant Workers
                                {X_AND_Y_ARE_ON_THE_MAP}
                            [/filter]
                            variable=total_peasant_workers
                        [/store_unit]
                        [store_unit]
                            [filter]
                                side=1
                                type=Peasant Workers
                                {X_AND_Y_ARE_ON_THE_MAP}
                                {FILTER_FOR_WORKER}
                            [/filter]
                            variable=busy_peasant_workers
                        [/store_unit]
                        [store_unit]
                            [filter]
                                side=1
                                type=Peasant Workers
                                {X_AND_Y_ARE_ON_THE_MAP}
                                [not]
                                    {FILTER_FOR_WORKER}
                                [/not]
                            [/filter]
                            variable=idle_peasant_workers
                        [/store_unit]
                        {VARIABLE proj_goals ""}
                        [for]
                            array=projects.proj_list
                            reverse=yes
                            [do]
                                [if]
                                    {VARIABLE_CONDITIONAL projects.proj_list[$i].turns less_than_equal_to 1}
                                    [then]
                                        {VARIABLE proj_goals "'$projects.proj_list[$i].goal|',$proj_goals|"}
                                    [/then]
                                [/if]
                            [/do]
                        [/for]
                        {VARIABLE proj_goals_map "$(tomap([$proj_goals|]))"}
                        [if]
                            {VARIABLE_CONDITIONAL proj_goals_map equals ""}
                            [then]
                                {VARIABLE proj_goals_map "None."}
                            [/then]
                        [/if]
                        [store_villages]
                            variable=total_villages
                        [/store_villages]
                        [store_villages]
                            variable=owned_villages
                            owner_side=1
                        [/store_villages]
                        [store_villages]
                            variable=unowned_villages
                            [not]
                                owner_side=1
                            [/not]
                        [/store_villages]
                        [message]
                            speaker=narrator
                            image=portraits/linaera.png
                            message=_"There are $total_villages.length| farms in total...
We own $owned_villages.length| farms.
We don't own $unowned_villages.length| farms.

Current rank is $wf_vars.expand_rank| and village capacity is $wf_vars.village_limit|.

We have $total_peasant_workers.length| Peasant Workers in total...
$idle_peasant_workers.length| are idle.
$busy_peasant_workers.length| are working.

The list of projects that will finish soon:
$proj_goals_map|

Unlocked hardworking Peasant Workers: $wf_vars.work_faster|."
                        [/message]
                        {CLEAR_VARIABLE total_peasant_workers}
                        {CLEAR_VARIABLE idle_peasant_workers}
                        {CLEAR_VARIABLE busy_peasant_workers}
                        {CLEAR_VARIABLE proj_goals}
                        {CLEAR_VARIABLE proj_goals_map}
                        {CLEAR_VARIABLE total_villages}
                        {CLEAR_VARIABLE owned_villages}
                        {CLEAR_VARIABLE unowned_villages}
                    [/command]
                [/option]
                [option]
                    label=_"Upgrade training level"
                    [show_if]
                        {VARIABLE_CONDITIONAL wf_vars.side1_gold greater_than_equal_to $wf_vars.gold_cost}
                        {VARIABLE_CONDITIONAL wf_vars.season_str not_equals "winter"}
                        {VARIABLE_CONDITIONAL wf_vars.enable_training boolean_equals yes}
                        {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 2}
                    [/show_if]
                    [command]
                        {STORE_GOLD}
                        [if]
                            {VARIABLE_CONDITIONAL wf_vars.side1_gold greater_than_equal_to $wf_vars.gold_cost}
                            [then]
                                [message]
                                    speaker=narrator
                                    image=portraits/linaera.png
                                    message=_"Invest in higher education."
                                    [option]
                                        label=_"Yes, grant $wf_vars.gold_cost| gold."
                                        [command]
                                            {PAY_GOLD $wf_vars.gold_cost}
                                            {VARIABLE_OP wf_vars.training_level add 1}
                                            {TRAINING_COURSE_REPORT}
                                        [/command]
                                    [/option]
                                    [option]
                                        label=_"No"
                                        [command]
                                        [/command]
                                    [/option]
                                [/message]
                            [/then]
                            [else]
                                [message]
                                    speaker=narrator
                                    image=portraits/linaera.png
                                    message=_"We lack $wf_vars.gold_cost| gold for an educational grant. Try again later."
                                [/message]
                            [/else]
                        [/if]
                    [/command]
                [/option]
                [option]
                    label=_"Disable training courses (Current level: $wf_vars.training_level|)"
                    [show_if]
                        {VARIABLE_CONDITIONAL wf_vars.enable_training boolean_equals yes}
                        {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 2}
                        {VARIABLE_CONDITIONAL wf_vars.season_str not_equals "winter"}
                    [/show_if]
                    [command]
                        {VARIABLE wf_vars.enable_training no}
                    [/command]
                [/option]
                [option]
                    label=_"Enable training courses (Current level: $wf_vars.training_level|)"
                    [show_if]
                        {VARIABLE_CONDITIONAL wf_vars.enable_training boolean_not_equals yes}
                        {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 2}
                        {VARIABLE_CONDITIONAL wf_vars.season_str not_equals "winter"}
                    [/show_if]
                    [command]
                        {VARIABLE wf_vars.enable_training yes}
                        {TRAINING_COURSE_REPORT}
                        {TUTORIAL enroll_training _"You may register units for a training course to increase their XP. Move the unit to any recruiting building, right-click on it, and select 'Enroll for training'."}
                    [/command]
                [/option]
                [option]
                    label=_"The drakes. &#9;&#9;(recruit: $quota.diplomacy_recruit_drakes|, bonus: $quota.diplomacy_bonus_drakes|)"
                    [show_if]
                        {VARIABLE_CONDITIONAL diplomacy.faction equals "none"}
                        {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 2}
                    [/show_if]
                    [command]
                        {FIRE_EVENT diplomacy_init}
                        {ACTION_DRAKES}
                        {ACTION_MESSAGE}
                    [/command]
                [/option]
                [option]
                    label=_"The dunefolk. &#9;(recruit: $quota.diplomacy_recruit_dunefolk|, bonus: $quota.diplomacy_bonus_dunefolk|)"
                    [show_if]
                        {VARIABLE_CONDITIONAL diplomacy.faction equals "none"}
                        {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 1}
                    [/show_if]
                    [command]
                        {FIRE_EVENT diplomacy_init}
                        {ACTION_DUNEFOLK}
                        {ACTION_MESSAGE}
                    [/command]
                [/option]
                [option]
                    label=_"The dwarves. &#9;(recruit: $quota.diplomacy_recruit_dwarves|, bonus: $quota.diplomacy_bonus_dwarves|)"
                    [show_if]
                        {VARIABLE_CONDITIONAL diplomacy.faction equals "none"}
                        {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 2}
                    [/show_if]
                    [command]
                        {FIRE_EVENT diplomacy_init}
                        {ACTION_DWARVES}
                        {ACTION_MESSAGE}
                    [/command]
                [/option]
                [option]
                    label=_"The elves. &#9;&#9;(recruit: $quota.diplomacy_recruit_elves|, bonus: $quota.diplomacy_bonus_elves|)"
                    [show_if]
                        {VARIABLE_CONDITIONAL diplomacy.faction equals "none"}
                        #{VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 0}
                    [/show_if]
                    [command]
                        {FIRE_EVENT diplomacy_init}
                        {ACTION_ELVES}
                        {ACTION_MESSAGE}
                    [/command]
                [/option]
                [option]
                    label=_"The loyalists. &#9;(recruit: $quota.diplomacy_recruit_loyalists|, bonus: $quota.diplomacy_bonus_loyalists|)"
                    [show_if]
                        {VARIABLE_CONDITIONAL diplomacy.faction equals "none"}
                        #{VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 0}
                    [/show_if]
                    [command]
                        {FIRE_EVENT diplomacy_init}
                        {ACTION_LOYALISTS}
                        {ACTION_MESSAGE}
                    [/command]
                [/option]
                [option]
                    label=_"The orcs. &#9;&#9;(recruit: $quota.diplomacy_recruit_orcs|, bonus: $quota.diplomacy_bonus_orcs|)"
                    [show_if]
                        {VARIABLE_CONDITIONAL diplomacy.faction equals "none"}
                        {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 3}
                    [/show_if]
                    [command]
                        {FIRE_EVENT diplomacy_init}
                        {ACTION_ORCS}
                        {ACTION_MESSAGE}
                    [/command]
                [/option]
                [option]
                    label=_"The outlaws. &#9;(recruit: $quota.diplomacy_recruit_outlaws|, bonus: $quota.diplomacy_bonus_outlaws|)"
                    [show_if]
                        {VARIABLE_CONDITIONAL diplomacy.faction equals "none"}
                        {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 1}
                    [/show_if]
                    [command]
                        {FIRE_EVENT diplomacy_init}
                        {ACTION_OUTLAWS}
                        {ACTION_MESSAGE}
                    [/command]
                [/option]
                [option]
                    label=_"The undead. &#9;(recruit: $quota.diplomacy_recruit_undead|, bonus: $quota.diplomacy_bonus_undead|)"
                    [show_if]
                        {VARIABLE_CONDITIONAL diplomacy.faction equals "none"}
                        {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 3}
                    [/show_if]
                    [command]
                        {FIRE_EVENT diplomacy_init}
                        {ACTION_UNDEAD}
                        {ACTION_MESSAGE}
                    [/command]
                [/option]
                [option]
                    label=_"The $diplomacy.faction| quest report"
                    [show_if]
                        {VARIABLE_CONDITIONAL diplomacy.faction not_equals "none"}
                        {VARIABLE_CONDITIONAL diplomacy.fee greater_than 0}
                    [/show_if]
                    [command]
                        {ACTION_MESSAGE}
                    [/command]
                [/option]
                [option]
                    label=_"The $diplomacy.faction| quest report"
                    [show_if]
                        {VARIABLE_CONDITIONAL diplomacy.faction not_equals "none"}
                        {VARIABLE_CONDITIONAL diplomacy.fee numerical_equals 0}
                    [/show_if]
                    [command]
                        [message]
                            speaker=narrator
                            #image="wesnoth-icon.png"
                            image=portraits/linaera.png
                            message=_"You have completed your quest for the $diplomacy.faction|.
The mercenaries will arrive in $diplomacy.turns| turns.

Unlocked faction recruit: $diplomacy.faction_recruit|.
Unlocked faction bonus: $diplomacy.faction_bonus|.
Faction bonus: $diplomacy.faction_bonus_desc|."
                        [/message]
                    [/command]
                [/option]
                [option]
                    label=_"Reduce $diplomacy.faction| quest requirement"
                    [show_if]
                        {VARIABLE_CONDITIONAL diplomacy.faction not_equals "none"}
                        {VARIABLE_CONDITIONAL diplomacy.fee greater_than 0}
                        {VARIABLE_CONDITIONAL diplomacy.current less_than $diplomacy.required}
                        {VARIABLE_CONDITIONAL wf_vars.side1_gold greater_than_equal_to $wf_vars.gold_cost}
                    [/show_if]
                    [command]
                        {STORE_GOLD}
                        [if]
                            {VARIABLE_CONDITIONAL wf_vars.side1_gold greater_than_equal_to $wf_vars.gold_cost}
                            [then]
                                [message]
                                    speaker=narrator
                                    image=portraits/linaera.png
                                    message=_"Pay to reduce requirement."
                                    [option]
                                        label=_"Yes, pay $wf_vars.gold_cost| gold."
                                        [command]
                                            {PAY_GOLD $wf_vars.gold_cost}
                                            {VARIABLE_OP diplomacy.current add 1}
                                            [switch]
                                                variable=diplomacy.faction
                                                [case]
                                                    value="loyalists"
                                                    {VARIABLE_OP diplomacy.loyalists sub 1}
                                                [/case]
                                                [case]
                                                    value="outlaws"
                                                    {VARIABLE_OP diplomacy.outlaws sub 1}
                                                [/case]
                                                [case]
                                                    value="dunefolk"
                                                    {VARIABLE_OP diplomacy.dunefolk sub 1}
                                                [/case]
                                                [case]
                                                    value="dwarves"
                                                    {VARIABLE_OP diplomacy.dwarves sub 1}
                                                [/case]
                                                [case]
                                                    value="drakes"
                                                    {VARIABLE_OP diplomacy.drakes sub 1}
                                                [/case]
                                                [case]
                                                    value="undead"
                                                    {VARIABLE_OP diplomacy.undead sub 1}
                                                [/case]
                                                [case]
                                                    value="elves"
                                                    {VARIABLE_OP diplomacy.elves sub 1}
                                                [/case]
                                                [case]
                                                    value="orcs"
                                                    {VARIABLE_OP diplomacy.orcs sub 1}
                                                [/case]
                                            [/switch]
                                            [fire_event]
                                                name=diplomacy_refresh
                                            [/fire_event]
                                        [/command]
                                    [/option]
                                    [option]
                                        label=_"No"
                                        [command]
                                        [/command]
                                    [/option]
                                [/message]
                            [/then]
                            [else]
                                [message]
                                    speaker=narrator
                                    image=portraits/linaera.png
                                    message=_"We lack $wf_vars.gold_cost gold. Try again later."
                                [/message]
                            [/else]
                        [/if]
                    [/command]
                [/option]
                [option]
                    label=_"Suspend the $diplomacy.faction| quest"
                    [show_if]
                        {VARIABLE_CONDITIONAL diplomacy.faction not_equals "none"}
                        {VARIABLE_CONDITIONAL diplomacy.fee greater_than 0}
                    [/show_if]
                    [command]
                        {VARIABLE diplomacy.faction "none"}
                        {VARIABLE diplomacy.required 0}
                        {VARIABLE diplomacy.current 0}
                        {VARIABLE diplomacy.fee 0}
                        {VARIABLE diplomacy.turns 0}
                        {CLEAR_VARIABLE diplomacy.action}
                        {CLEAR_VARIABLE diplomacy.faction_bonus}
                        {CLEAR_VARIABLE diplomacy.faction_bonus_desc}
                        {CLEAR_VARIABLE diplomacy.faction_recruit}
                        {DIPLOMACY_REMOVE_EVENTS}
                    [/command]
                [/option]
            [/message]
        [/do]
    [/while]
    #	[/command]
    #[/set_menu_item]
    #[/event]
#enddef

#define WF_DIPLOMACY
    [event]
        name=prestart
        [if]
            {VARIABLE_CONDITIONAL diplomacy.faction not_equals "none"}
            [then]
                {DIPLOMACY_CORE_EVENTS}

                [switch]
                    variable=diplomacy.faction
                    [case]
                        value="loyalists"
                        {MISSION_EVENTS_LOYALISTS}
                    [/case]
                    [case]
                        value="outlaws"
                        {MISSION_EVENTS_OUTLAWS}
                    [/case]
                    [case]
                        value="dunefolk"
                        {MISSION_EVENTS_DUNEFOLK}
                    [/case]
                    [case]
                        value="dwarves"
                        {MISSION_EVENTS_DWARVES}
                    [/case]
                    [case]
                        value="drakes"
                        {MISSION_EVENTS_DRAKES}
                    [/case]
                    [case]
                        value="undead"
                        {MISSION_EVENTS_UNDEAD}
                    [/case]
                    [case]
                        value="elves"
                        {MISSION_EVENTS_ELVES}
                    [/case]
                    [case]
                        value="orcs"
                        {MISSION_EVENTS_ORCS}
                    [/case]
                [/switch]
            [/then]
        [/if]
    [/event]

    [event]
        name=diplomacy_init
        id=diplomacy_init
        first_time_only=no

        {DIPLOMACY_CORE_EVENTS}
    [/event]

    [event]
        name=spymaster_report
        id=spymaster_report
        first_time_only=no

        {VARIABLE quota.animal_units 0}
        {VARIABLE quota.guardian_units 0}
        {VARIABLE quota.enemy_units 0}
        {VARIABLE quota.ally_units 0}

        {VARIABLE quota.animal_hitpoints 0}
        {VARIABLE quota.guardian_hitpoints 0}
        {VARIABLE quota.enemy_hitpoints 0}
        {VARIABLE quota.ally_hitpoints 0}

        [store_unit]
            [filter]
                side=2
                [not]
                    status=guardian
                [/not]
            [/filter]
            variable=unit_store
            mode=always_clear
        [/store_unit]
        [foreach]
            array=unit_store
            [do]
                {VARIABLE_OP quota.animal_units add 1}
                {VARIABLE_OP quota.animal_hitpoints add $this_item.hitpoints}
            [/do]
        [/foreach]

        [store_unit]
            [filter]
                side=2
                status=guardian
            [/filter]
            variable=unit_store
            mode=always_clear
        [/store_unit]
        [foreach]
            array=unit_store
            [do]
                {VARIABLE_OP quota.guardian_units add 1}
                {VARIABLE_OP quota.guardian_hitpoints add $this_item.hitpoints}
            [/do]
        [/foreach]

        [store_unit]
            [filter]
                side=3,4,5,6,7,8
            [/filter]
            variable=unit_store
            mode=always_clear
        [/store_unit]
        [foreach]
            array=unit_store
            [do]
                {VARIABLE_OP quota.enemy_units add 1}
                {VARIABLE_OP quota.enemy_hitpoints add $this_item.hitpoints}
            [/do]
        [/foreach]

        [store_unit]
            [filter]
                side=9
                [not]
                    status=pilgrim
                [/not]
                [not]
                    type=Caravan
                [/not]
            [/filter]
            variable=unit_store
            mode=always_clear
        [/store_unit]
        [foreach]
            array=unit_store
            [do]
                {VARIABLE_OP quota.ally_units add 1}
                {VARIABLE_OP quota.ally_hitpoints add $this_item.hitpoints}
            [/do]
        [/foreach]

        {CLEAR_VARIABLE unit_store}
    [/event]
#enddef

#define REMOVE_EVENT ID
    [remove_event]
        id={ID}
    [/remove_event]
#enddef

#define DIPLOMACY_REMOVE_EVENTS
    {REMOVE_EVENT diplomacy_core_turn_end}
    {REMOVE_EVENT diplomacy_core_turn_refresh}
    {REMOVE_EVENT diplomacy_refresh}

    {REMOVE_EVENT diplomacy_drakes}
    {REMOVE_EVENT diplomacy_drakes_mission_1}
    {REMOVE_EVENT diplomacy_drakes_mission_2a}
    {REMOVE_EVENT diplomacy_drakes_mission_2b}
    {REMOVE_EVENT diplomacy_drakes_mission_3}
    {REMOVE_EVENT diplomacy_drakes_mission_4}
    {REMOVE_EVENT diplomacy_drakes_mission_5}

    {REMOVE_EVENT diplomacy_dunefolk}
    {REMOVE_EVENT diplomacy_dunefolk_mission_1}
    {REMOVE_EVENT diplomacy_dunefolk_mission_2a}
    {REMOVE_EVENT diplomacy_dunefolk_mission_2b}
    {REMOVE_EVENT diplomacy_dunefolk_mission_3}
    {REMOVE_EVENT diplomacy_dunefolk_mission_4}
    {REMOVE_EVENT diplomacy_dunefolk_mission_5}

    {REMOVE_EVENT diplomacy_dwarves}
    {REMOVE_EVENT diplomacy_dwarves_mission_1}
    {REMOVE_EVENT diplomacy_dwarves_mission_2}
    {REMOVE_EVENT diplomacy_dwarves_mission_3a}
    {REMOVE_EVENT diplomacy_dwarves_mission_3b}
    {REMOVE_EVENT diplomacy_dwarves_mission_4}
    {REMOVE_EVENT diplomacy_dwarves_mission_5}

    {REMOVE_EVENT diplomacy_elves}
    {REMOVE_EVENT diplomacy_elves_mission_1}
    {REMOVE_EVENT diplomacy_elves_mission_2}
    {REMOVE_EVENT diplomacy_elves_mission_3}
    {REMOVE_EVENT diplomacy_elves_mission_4}
    {REMOVE_EVENT diplomacy_elves_mission_5}

    {REMOVE_EVENT diplomacy_loyalists}
    {REMOVE_EVENT diplomacy_loyalists_mission_1}
    {REMOVE_EVENT diplomacy_loyalists_mission_2}
    {REMOVE_EVENT diplomacy_loyalists_mission_3}
    {REMOVE_EVENT diplomacy_loyalists_mission_4}
    {REMOVE_EVENT diplomacy_loyalists_mission_5}

    {REMOVE_EVENT diplomacy_orcs}
    {REMOVE_EVENT diplomacy_orcs_mission_1}
    {REMOVE_EVENT diplomacy_orcs_mission_2}
    {REMOVE_EVENT diplomacy_orcs_mission_3}
    {REMOVE_EVENT diplomacy_orcs_mission_4}
    {REMOVE_EVENT diplomacy_orcs_mission_5}

    {REMOVE_EVENT diplomacy_outlaws}
    {REMOVE_EVENT diplomacy_outlaws_mission_1}
    {REMOVE_EVENT diplomacy_outlaws_mission_2}
    {REMOVE_EVENT diplomacy_outlaws_mission_3}
    {REMOVE_EVENT diplomacy_outlaws_mission_4}
    {REMOVE_EVENT diplomacy_outlaws_mission_5}

    {REMOVE_EVENT diplomacy_undead}
    {REMOVE_EVENT diplomacy_undead_mission_1}
    {REMOVE_EVENT diplomacy_undead_mission_2}
    {REMOVE_EVENT diplomacy_undead_mission_3}
    {REMOVE_EVENT diplomacy_undead_mission_4}
    {REMOVE_EVENT diplomacy_undead_mission_5}
#enddef

#define DIPLOMACY_CORE_EVENTS
    [event]
        name=side 1 turn refresh,side 1 turn end
        id=diplomacy_core_turn_refresh
        first_time_only=no

        [fire_event]
            name=diplomacy_refresh
        [/fire_event]
    [/event]

    [event]
        name=diplomacy_refresh
        id=diplomacy_refresh

        first_time_only=no
        [filter_condition]
            {VARIABLE_CONDITIONAL diplomacy.faction not_equals "none"}
            {VARIABLE_CONDITIONAL diplomacy.fee greater_than 0}
        [/filter_condition]

        [switch]
            variable=diplomacy.faction
            [case]
                value="loyalists"
                {VARIABLE diplomacy.current $diplomacy.loyalists}
                {VARIABLE_OP diplomacy.current multiply -1}
            [/case]
            [case]
                value="outlaws"
                {VARIABLE diplomacy.current $diplomacy.outlaws}
                {VARIABLE_OP diplomacy.current multiply -1}
            [/case]
            [case]
                value="dunefolk"
                {VARIABLE diplomacy.current $diplomacy.dunefolk}
                {VARIABLE_OP diplomacy.current multiply -1}
            [/case]
            [case]
                value="dwarves"
                {VARIABLE diplomacy.current $diplomacy.dwarves}
                {VARIABLE_OP diplomacy.current multiply -1}
            [/case]
            [case]
                value="drakes"
                {VARIABLE diplomacy.current $diplomacy.drakes}
                {VARIABLE_OP diplomacy.current multiply -1}
            [/case]
            [case]
                value="undead"
                {VARIABLE diplomacy.current $diplomacy.undead}
                {VARIABLE_OP diplomacy.current multiply -1}
            [/case]
            [case]
                value="elves"
                {VARIABLE diplomacy.current $diplomacy.elves}
                {VARIABLE_OP diplomacy.current multiply -1}
            [/case]
            [case]
                value="orcs"
                {VARIABLE diplomacy.current $diplomacy.orcs}
                {VARIABLE_OP diplomacy.current multiply -1}
            [/case]
        [/switch]

        [if]
            {VARIABLE_CONDITIONAL diplomacy.current greater_than_equal_to $diplomacy.required}
            [then]
                {STORE_GOLD}
                [if]
                    {VARIABLE_CONDITIONAL wf_vars.side1_gold greater_than_equal_to $diplomacy.fee}
                    [then]
                        [message]
                            speaker=Hero
                            message=_"We have completed our quest for the $diplomacy.faction|. Should we pay $diplomacy.fee| to hire the mercenaries?"
                            [option]
                                label=_"Yes."
                                default=yes
                                [command]
                                    {PAY_GOLD $diplomacy.fee}
                                    {VARIABLE diplomacy.fee 0}
                                    {VARIABLE diplomacy.required 0}
                                    {VARIABLE diplomacy.current 0}
                                    {RANDOM_VAR diplomacy.turns 1..3}
                                    {CLEAR_VARIABLE diplomacy.action}
                                    [switch]
                                        variable=diplomacy.faction
                                        [case]
                                            value="loyalists"
                                            {VARIABLE diplomacy.loyalists 0}
                                        [/case]
                                        [case]
                                            value="outlaws"
                                            {VARIABLE diplomacy.outlaws 0}
                                        [/case]
                                        [case]
                                            value="dunefolk"
                                            {VARIABLE diplomacy.dunefolk 0}
                                        [/case]
                                        [case]
                                            value="dwarves"
                                            {VARIABLE diplomacy.dwarves 0}
                                        [/case]
                                        [case]
                                            value="drakes"
                                            {VARIABLE diplomacy.drakes 0}
                                        [/case]
                                        [case]
                                            value="undead"
                                            {VARIABLE diplomacy.undead 0}
                                        [/case]
                                        [case]
                                            value="elves"
                                            {VARIABLE diplomacy.elves 0}
                                        [/case]
                                        [case]
                                            value="orcs"
                                            {VARIABLE diplomacy.orcs 0}
                                        [/case]
                                    [/switch]
                                [/command]
                            [/option]
                            [option]
                                label=_"Not now. Ask me later."
                                [command] [/command]
                            [/option]
                            [option]
                                label=_"Forgo hiring mercenaries."
                                [command]
                                    {VARIABLE diplomacy.fee -1}
                                    {VARIABLE diplomacy.required 0}
                                    {VARIABLE diplomacy.current 0}
                                    {VARIABLE diplomacy.turns 0}
                                    {CLEAR_VARIABLE diplomacy.action}
                                    [switch]
                                        variable=diplomacy.faction
                                        [case]
                                            value="loyalists"
                                            {VARIABLE diplomacy.loyalists 0}
                                            [fire_event]
                                                name=diplomacy_loyalists
                                            [/fire_event]
                                        [/case]
                                        [case]
                                            value="outlaws"
                                            {VARIABLE diplomacy.outlaws 0}
                                            [fire_event]
                                                name=diplomacy_outlaws
                                            [/fire_event]
                                        [/case]
                                        [case]
                                            value="dunefolk"
                                            {VARIABLE diplomacy.dunefolk 0}
                                            [fire_event]
                                                name=diplomacy_dunefolk
                                            [/fire_event]
                                        [/case]
                                        [case]
                                            value="dwarves"
                                            {VARIABLE diplomacy.dwarves 0}
                                            [fire_event]
                                                name=diplomacy_dwarves
                                            [/fire_event]
                                        [/case]
                                        [case]
                                            value="drakes"
                                            {VARIABLE diplomacy.drakes 0}
                                            [fire_event]
                                                name=diplomacy_drakes
                                            [/fire_event]
                                        [/case]
                                        [case]
                                            value="undead"
                                            {VARIABLE diplomacy.undead 0}
                                            [fire_event]
                                                name=diplomacy_undead
                                            [/fire_event]
                                        [/case]
                                        [case]
                                            value="elves"
                                            {VARIABLE diplomacy.elves 0}
                                            [fire_event]
                                                name=diplomacy_elves
                                            [/fire_event]
                                        [/case]
                                        [case]
                                            value="orcs"
                                            {VARIABLE diplomacy.orcs 0}
                                            [fire_event]
                                                name=diplomacy_orcs
                                            [/fire_event]
                                        [/case]
                                    [/switch]

                                    {VARIABLE diplomacy.faction "none"}
                                    {VARIABLE diplomacy.required 0}
                                    {VARIABLE diplomacy.current 0}
                                    {VARIABLE diplomacy.fee 0}
                                    {VARIABLE diplomacy.turns 0}
                                    {CLEAR_VARIABLE diplomacy.action}
                                    {CLEAR_VARIABLE diplomacy.faction_bonus}
                                    {CLEAR_VARIABLE diplomacy.faction_bonus_desc}
                                    {CLEAR_VARIABLE diplomacy.faction_recruit}
                                    {DIPLOMACY_REMOVE_EVENTS}
                                [/command]
                            [/option]
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=Hero
                            message=_"We lack the funds to hire $diplomacy.faction| mercenaries."
                            [option]
                                label=_"Just wait, we'll raise the $diplomacy.fee| gold."
                                default=yes
                                [command] [/command]
                            [/option]
                            [option]
                                label=_"Forgo hiring mercenaries."
                                [command]
                                    {VARIABLE diplomacy.fee -1}
                                    {VARIABLE diplomacy.required 0}
                                    {VARIABLE diplomacy.current 0}
                                    {VARIABLE diplomacy.turns 0}
                                    {CLEAR_VARIABLE diplomacy.action}
                                    [switch]
                                        variable=diplomacy.faction
                                        [case]
                                            value="loyalists"
                                            {VARIABLE diplomacy.loyalists 0}
                                            [fire_event]
                                                name=diplomacy_loyalists
                                            [/fire_event]
                                        [/case]
                                        [case]
                                            value="outlaws"
                                            {VARIABLE diplomacy.outlaws 0}
                                            [fire_event]
                                                name=diplomacy_outlaws
                                            [/fire_event]
                                        [/case]
                                        [case]
                                            value="dunefolk"
                                            {VARIABLE diplomacy.dunefolk 0}
                                            [fire_event]
                                                name=diplomacy_dunefolk
                                            [/fire_event]
                                        [/case]
                                        [case]
                                            value="dwarves"
                                            {VARIABLE diplomacy.dwarves 0}
                                            [fire_event]
                                                name=diplomacy_dwarves
                                            [/fire_event]
                                        [/case]
                                        [case]
                                            value="drakes"
                                            {VARIABLE diplomacy.drakes 0}
                                            [fire_event]
                                                name=diplomacy_drakes
                                            [/fire_event]
                                        [/case]
                                        [case]
                                            value="undead"
                                            {VARIABLE diplomacy.undead 0}
                                            [fire_event]
                                                name=diplomacy_undead
                                            [/fire_event]
                                        [/case]
                                        [case]
                                            value="elves"
                                            {VARIABLE diplomacy.elves 0}
                                            [fire_event]
                                                name=diplomacy_elves
                                            [/fire_event]
                                        [/case]
                                        [case]
                                            value="orcs"
                                            {VARIABLE diplomacy.orcs 0}
                                            [fire_event]
                                                name=diplomacy_orcs
                                            [/fire_event]
                                        [/case]
                                    [/switch]

                                    {VARIABLE diplomacy.faction "none"}
                                    {VARIABLE diplomacy.required 0}
                                    {VARIABLE diplomacy.current 0}
                                    {VARIABLE diplomacy.fee 0}
                                    {VARIABLE diplomacy.turns 0}
                                    {CLEAR_VARIABLE diplomacy.action}
                                    {CLEAR_VARIABLE diplomacy.faction_bonus}
                                    {CLEAR_VARIABLE diplomacy.faction_bonus_desc}
                                    {CLEAR_VARIABLE diplomacy.faction_recruit}
                                    {DIPLOMACY_REMOVE_EVENTS}
                                [/command]
                            [/option]
                        [/message]
                    [/else]
                [/if]
            [/then]
        [/if]
    [/event]

    [event]
        name=turn end
        id=diplomacy_core_turn_end

        first_time_only=no
        [filter_condition]
            {VARIABLE_CONDITIONAL diplomacy.faction not_equals "none"}
            {VARIABLE_CONDITIONAL diplomacy.fee numerical_equals 0}
        [/filter_condition]

        [if]
            {VARIABLE_CONDITIONAL diplomacy.turns greater_than 1}
            [then]
                {VARIABLE_OP diplomacy.turns sub 1}
            [/then]
            [else]
                [switch]
                    variable=diplomacy.faction
                    [case]
                        value=loyalists
                        [fire_event]
                            name=diplomacy_loyalists
                        [/fire_event]
                    [/case]
                    [case]
                        value=outlaws
                        [fire_event]
                            name=diplomacy_outlaws
                        [/fire_event]
                    [/case]
                    [case]
                        value=dunefolk
                        [fire_event]
                            name=diplomacy_dunefolk
                        [/fire_event]
                    [/case]
                    [case]
                        value=dwarves
                        [fire_event]
                            name=diplomacy_dwarves
                        [/fire_event]
                    [/case]
                    [case]
                        value=drakes
                        [fire_event]
                            name=diplomacy_drakes
                        [/fire_event]
                    [/case]
                    [case]
                        value=elves
                        [fire_event]
                            name=diplomacy_elves
                        [/fire_event]
                    [/case]
                    [case]
                        value=undead
                        [fire_event]
                            name=diplomacy_undead
                        [/fire_event]
                    [/case]
                    [case]
                        value=orcs
                        [fire_event]
                            name=diplomacy_orcs
                        [/fire_event]
                    [/case]
                [/switch]

                {VARIABLE diplomacy.faction "none"}
                {VARIABLE diplomacy.required 0}
                {VARIABLE diplomacy.current 0}
                {VARIABLE diplomacy.fee 0}
                {VARIABLE diplomacy.turns 0}
                {CLEAR_VARIABLE diplomacy.action}
                {CLEAR_VARIABLE diplomacy.faction_bonus}
                {CLEAR_VARIABLE diplomacy.faction_bonus_desc}
                {CLEAR_VARIABLE diplomacy.faction_recruit}
                {DIPLOMACY_REMOVE_EVENTS}
            [/else]
        [/if]
    [/event]
#enddef

#define WF_SPAWN_ALLY DIR FACTION TYPE PROFILE
    # 0=east, 1=north, 2=west, 3=south
    {FIND_NEAREST_HEX diplomacy_start $map_signs[{DIR}].x $map_signs[{DIR}].y (
        {NOT_FILTER}
        terrain=!,W*,*^Y*,*^V*,K*,C*
    )}
    [unit]
        passable=yes
        placement=map
        random_traits=no
        role=ally
        side=9
        type={TYPE}
        x=$diplomacy_start.x
        y=$diplomacy_start.y
        {PROFILE}
        [modifications]
            {TRAIT_LOYAL}
        [/modifications]
        {IS_LOYAL}
        to_variable=diplomacy_unit
    [/unit]
    [if]
        {VARIABLE_CONDITIONAL diplomacy.{FACTION}_name not_equals ""}
        [then]
            {VARIABLE diplomacy_unit.name $diplomacy.{FACTION}_name}
        [/then]
        [else]
            {VARIABLE diplomacy.{FACTION}_name $diplomacy_unit.name}
        [/else]
    [/if]
    {SCROLL_TO $diplomacy_start.x $diplomacy_start.y}
    [unstore_unit]
        variable=diplomacy_unit
        find_vacant=yes
        check_passability=yes
        animate=yes
        text=_"Ambassador"
        # fire_event=yes
    [/unstore_unit]
    [unhide_unit]
    [/unhide_unit]
    [redraw]
        side=1
        clear_shroud=yes
    [/redraw]
    [deselect]
    [/deselect]
#enddef

#define WF_CLEANUP_ALLY
    [kill]
        id=$diplomacy_unit.id
        animate=no
        fire_event=no
    [/kill]
    [redraw]
        side=1
        clear_shroud=yes
    [/redraw]
    {CLEAR_VARIABLE diplomacy_unit}
    {CLEAR_VARIABLE diplomacy_start}
#enddef

#define WF_DIPLOMACY_SPAWN DIR FACTION UNIT_LIST
    #{RANDOM_VAR rnd_dir 0,1,2,3}	# 0=east, 1=north, 2=west, 3=south
    {FIND_NEAREST_HEX diplomacy_start $map_signs[{DIR}].x $map_signs[{DIR}].y (
        {NOT_FILTER}
        terrain=!,W*,*^Y*,*^V*,K*,C*
    )}

    [store_unit_type]
        type={UNIT_LIST}
        variable=merc_types
        mode=always_clear
    [/store_unit_type]

    [foreach]
        array=merc_types
        [do]
            [set_variables]
                name=merc_options
                mode=append
                [value]
                    label=$this_item.name
                    image="terrain/grass/green.png~BLIT($this_item.image|)~SCALE(36,36)"
                    [command]
                        [unit]
                            animate=yes
                            passable=yes
                            placement=map
                            random_traits=yes
                            side=1
                            type=$this_item.id
                            x=$|diplomacy_start.x
                            y=$|diplomacy_start.y
                            #{IS_LAST}
                        [/unit]
                        #{STORE_LAST_UNIT}
                        [fire_event]
                            name=amla_extra_event
                            [primary_unit]
                                id=$|last_unit_id
                            [/primary_unit]
                        [/fire_event]
                        #{CLEAR_LAST_UNIT}
                        {SCROLL_TO $|diplomacy_start.x $|diplomacy_start.y}
                        [redraw]
                            side=1
                            clear_shroud=yes
                        [/redraw]
                        {VARIABLE_OP repeat_count sub 1}
                    [/command]
                [/value]
            [/set_variables]
        [/do]
    [/foreach]

    {CLEAR_VARIABLE merc_types}

    {VARIABLE repeat_count $enemy.num_allies}
    {VARIABLE_OP repeat_count add $wf_vars.extra_guardian}
    #{VARIABLE_OP repeat_count add $diplomacy.{FACTION}_mission}

    [wf_sort_array]
        name=merc_options
        first_key=label
        second_key=label
    [/wf_sort_array]

    [while]
        {VARIABLE_CONDITIONAL repeat_count greater_than 0}
        [do]
            [message]
                role=ally
                message=_"Select your mercenaries..."
                [option]
                    label=_"Select $repeat_count| units randomly."
                    image="units/random-dice.png~SCALE(36,36)"
                    default=yes
                    [command]
                        {REPEAT $repeat_count (
                            {WF_RAND_CHOICE {UNIT_LIST}}
                            {SCROLL_TO $diplomacy_start.x $diplomacy_start.y}
                            [unit]
                                passable=yes
                                placement=map
                                random_traits=yes
                                side=1
                                type=$random_choice
                                x=$diplomacy_start.x
                                y=$diplomacy_start.y
                                animate=yes
                                #{IS_LAST}
                            [/unit]
                            #{STORE_LAST_UNIT}
                            [fire_event]
                                name=amla_extra_event
                                [primary_unit]
                                    id=$last_unit_id
                                [/primary_unit]
                            [/fire_event]
                            #{CLEAR_LAST_UNIT}
                            {CLEAR_VARIABLE random_choice}
                            [redraw]
                                side=1
                                clear_shroud=yes
                            [/redraw]
                        )}
                        {CLEAR_VARIABLE random_choice_arr}

                        {VARIABLE repeat_count 0}
                    [/command]
                [/option]
                [insert_tag]
                    name=option
                    variable=merc_options
                [/insert_tag]
                [option]
                    label=_"Nevermind, I don't need them. ($repeat_count| left)"
                    [command]
                        {VARIABLE repeat_count 0}
                    [/command]
                [/option]
            [/message]
        [/do]
    [/while]

    {CLEAR_VARIABLE merc_options}

    [unhide_unit]
    [/unhide_unit]

    {CLEAR_VARIABLE repeat_count}
    {CLEAR_VARIABLE diplomacy_start}
#enddef

#define ACTION_MESSAGE
    [message]
        speaker=narrator
        #image="wesnoth-icon.png"
        #image=portraits/delfador-mentoring.png
        image=portraits/linaera.png
        message="$diplomacy.action|
Your current standing is $diplomacy.current|.
The required standing is $diplomacy.required|.
Fee for the $diplomacy.faction| mercenaries is $diplomacy.fee|.

Unlocked faction recruit: $diplomacy.faction_recruit|.
Unlocked faction bonus: $diplomacy.faction_bonus|.
Faction bonus: $diplomacy.faction_bonus_desc|."
    [/message]
#enddef

#define DIPLOMACY_MISSION VAR NUM WML
    [switch]
        variable={VAR}
        [case]
            value={NUM}
            {WML}
        [/case]
    [/switch]
#enddef

#define DIPLOMACY_BONUS_STATE FACTION_STATE
    {VARIABLE diplomacy.faction_bonus no}
    {VARIABLE diplomacy.faction_recruit no}

    [if]
        {VARIABLE_CONDITIONAL {FACTION_STATE} greater_than_equal_to 10}
        [then]
            {VARIABLE diplomacy.faction_bonus yes}
        [/then]
    [/if]

    [if]
        {VARIABLE_CONDITIONAL {FACTION_STATE} greater_than_equal_to 5}
        [then]
            {VARIABLE diplomacy.faction_recruit yes}
            {VARIABLE diplomacy.fee 50}
            [if]
                {VARIABLE_CONDITIONAL diplomacy.required greater_than 3}
                [then]
                    {VARIABLE diplomacy.required 3}
                [/then]
            [/if]
        [/then]
    [/if]
#enddef
