#textdomain wesnoth-Wild_Frontiers

#define MARKET_MOVETO
    [event]
        name=moveto
        id=moveto_market
        first_time_only=no
        [filter]
            side=9
            type=Caravan
            x,y=$x1,$y1
            [filter_location]
                terrain=*^Wm
                x,y=$x1,$y1
            [/filter_location]
        [/filter]

        {WF_MARKET_ITEMS}
        #market=starting bonus 1 | caravan market 2 | disabled not for sale 3 | filler 4
        [foreach]
            array=market.offered_items
            [do]
                # Disable the item
                {VARIABLE wf_market_items[$this_item.index].market 3}
            [/do]
        [/foreach]
        {WF_MARKET_ITEMS_APPEND_MARKET caravan_market_items 1}
        {WF_MARKET_ITEMS_APPEND_MARKET caravan_market_items 2}
        [if]
            {VARIABLE_CONDITIONAL caravan_market_items.length less_than 4}
            [then]
                {VARIABLE reset_market yes}
            [/then]
        [/if]
        [while]
            {VARIABLE_CONDITIONAL caravan_market_items.length less_than 3}
            [do]
                # Append dummy filler item to make it 3 selections
                {WF_MARKET_ITEMS_APPEND_MARKET caravan_market_items 4}
            [/do]
        [/while]
        {WF_MARKET_ITEMS_RANDOM_INDEX caravan_market_items rnd_i1 rnd_label1}
        {WF_MARKET_ITEMS_RANDOM_INDEX caravan_market_items rnd_i2 rnd_label2}
        {WF_MARKET_ITEMS_RANDOM_INDEX caravan_market_items rnd_i3 rnd_label3}
        {CLEAR_VARIABLE caravan_market_items}
        [if]
            {VARIABLE_CONDITIONAL reset_market boolean_equals yes}
            [then]
                [set_variables]
                    name=market.offered_items
                    mode=replace
                    {VALUE1 index $rnd_i1}
                    {VALUE1 index $rnd_i2}
                    {VALUE1 index $rnd_i3}
                [/set_variables]
                [for]
                    array=market.offered_items
                    reverse=yes
                    [do]
                        [if]
                            {VARIABLE_CONDITIONAL wf_market_items[$market.offered_items[$i].index].market numerical_equals 4}
                            [then]
                                # remove filler item
                                {CLEAR_VARIABLE market.offered_items[$i]}
                            [/then]
                        [/if]
                    [/do]
                [/for]
            [/then]
            [else]
                [set_variables]
                    name=market.offered_items
                    mode=append
                    {VALUE1 index $rnd_i1}
                    {VALUE1 index $rnd_i2}
                    {VALUE1 index $rnd_i3}
                [/set_variables]
            [/else]
        [/if]
        {CLEAR_VARIABLE reset_market}
        {CLEAR_VARIABLE wf_market_items}

        {RANDOM_VAR rnd_price1 "70..80"}
        {VARIABLE rnd_pay1 $rnd_price1}
        {VARIABLE_OP rnd_pay1 multiply -1}

        {RANDOM_VAR rnd_price2 "70..80"}
        {VARIABLE rnd_pay2 $rnd_price2}
        {VARIABLE_OP rnd_pay2 multiply -1}

        {RANDOM_VAR rnd_price3 "70..80"}
        {VARIABLE rnd_pay3 $rnd_price3}
        {VARIABLE_OP rnd_pay3 multiply -1}

        [message]
            speaker=unit
            message=_"May we interest you in one of these, milord.
$rnd_label1| for $rnd_price1| gold.
$rnd_label2| for $rnd_price2| gold.
$rnd_label3| for $rnd_price3| gold."
        [/message]

        [fire_event]
            name=wf_market
            [primary_unit]
                x=$unit.x
                y=$unit.y
            [/primary_unit]
            #[secondary_unit]
            #    x=$x2
            #    y=$y2
            #[/secondary_unit]
            [primary_attack]
                index1=$rnd_i1
                label1=$rnd_label1
                price1=$rnd_price1
                pay1=$rnd_pay1

                index2=$rnd_i2
                label2=$rnd_label2
                price2=$rnd_price2
                pay2=$rnd_pay2

                index3=$rnd_i3
                label3=$rnd_label3
                price3=$rnd_price3
                pay3=$rnd_pay3

                x=$x1
                y=$y1
            [/primary_attack]
        [/fire_event]
        [kill]
            side=9
            animate=no
            id=$unit.id
            fire_event=no
        [/kill]
        {CLEAR_VARIABLE rnd_i1}
        {CLEAR_VARIABLE rnd_price1}
        {CLEAR_VARIABLE rnd_pay1}
        {CLEAR_VARIABLE rnd_label1}

        {CLEAR_VARIABLE rnd_i2}
        {CLEAR_VARIABLE rnd_price2}
        {CLEAR_VARIABLE rnd_pay2}
        {CLEAR_VARIABLE rnd_label2}

        {CLEAR_VARIABLE rnd_i3}
        {CLEAR_VARIABLE rnd_price3}
        {CLEAR_VARIABLE rnd_pay3}
        {CLEAR_VARIABLE rnd_label3}
    [/event]
#enddef

#define COWARD_CARAVAN
    side=9
    ai_type=coward
    ca_id=coward_caravan
    ca_score=250000
    [filter]
        side=9
        type=Caravan
        [not]
            ability=frozen
        [/not]
        [not]
            ability=guard
        [/not]
        [not]
            ability=fallback
        [/not]
        [not]
            ability=coward
        [/not]
        [not]
            ability=tavern
        [/not]
    [/filter]
#enddef

#define GOTO_CARAVAN_FILTER
    [filter]
        side=9
        type=Caravan
        [not]
            ability=frozen
        [/not]
        [not]
            ability=guard
        [/not]
        [not]
            ability=fallback
        [/not]
        [not]
            ability=coward
        [/not]
        [not]
            ability=tavern
        [/not]
    [/filter]
    [filter_location]
        terrain=*^Wm
    [/filter_location]
#enddef

#define GOTO_CARAVAN
    side=9
    ai_type=wf_goto
    ca_id=goto_caravan
    ca_score=300000
    {GOTO_CARAVAN_FILTER}
    avoid_enemies=1
    remove_movement=no
#enddef
#define GOTO_CARAVAN_STRAIGHT
    side=9
    ai_type=goto
    ca_id=goto_caravan_straight
    ca_score=275000
    {GOTO_CARAVAN_FILTER}
    use_straight_line=yes
#enddef

#define MARKET_CARAVAN
    [event]
        name=prestart
        [micro_ai]
            action=add
            {GOTO_CARAVAN}
        [/micro_ai]
        [micro_ai]
            action=add
            {GOTO_CARAVAN_STRAIGHT}
        [/micro_ai]
        [micro_ai]
            action=add
            {COWARD_CARAVAN}
            distance=6
            attack_if_trapped=no
        [/micro_ai]
        {VARIABLE quota.caravan_dir -1}
    [/event]

    {MARKET_MOVETO}

    [event]
        name=side 9 turn 1 end
        id=market_caravan_turn
        first_time_only=yes

        [if]
            #[filter_condition]
            [have_location]
                terrain=*^Wm
                count=1
            [/have_location]
            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 1}
            #[have_unit]
            #    side=9
            #    type=Caravan
            #    search_recall_list=no
            #    count=0
            #[/have_unit]
            #[/filter_condition]
            [then]
                {FIRE_EVENT spawn_market_caravan}
                [if]
                    {VARIABLE_CONDITIONAL wf_vars.armor_caravan boolean_equals yes}
                    [then]
                        {FIRE_EVENT spawn_market_caravan}
                    [/then]
                [/if]
                #[remove_event]
                #    id=spawn_market_caravan
                #[/remove_event]
            [/then]
            #[else]
            #    [remove_event]
            #        id=spawn_market_caravan
            #    [/remove_event]
            #[/else]
        [/if]
    [/event]

    [event]
        name=spawn_market_caravan
        id=spawn_market_caravan
        first_time_only=no

        [switch]
            variable=quota.caravan_dir
            [case]
                value=0
                {RANDOM_VAR rnd_dir 1,2,3}	# 0=east, 1=north, 2=west, 3=south
            [/case]
            [case]
                value=1
                {RANDOM_VAR rnd_dir 0,2,3}	# 0=east, 1=north, 2=west, 3=south
            [/case]
            [case]
                value=2
                {RANDOM_VAR rnd_dir 0,1,3}	# 0=east, 1=north, 2=west, 3=south
            [/case]
            [case]
                value=3
                {RANDOM_VAR rnd_dir 0,1,2}	# 0=east, 1=north, 2=west, 3=south
            [/case]
            [else]
                {RANDOM_VAR rnd_dir 0,1,2,3}	# 0=east, 1=north, 2=west, 3=south
            [/else]
        [/switch]
        {VARIABLE quota.caravan_dir $rnd_dir}

        [switch]
            variable=rnd_dir
            [case]
                value=0
                {VARIABLE market_name "Eastern Goods"}
                {VARIABLE market_role "east_goods"}
            [/case]
            [case]
                value=1
                {VARIABLE market_name "Northern Goods"}
                {VARIABLE market_role "north_goods"}
            [/case]
            [case]
                value=2
                {VARIABLE market_name "Western Goods"}
                {VARIABLE market_role "west_goods"}
            [/case]
            [case]
                value=3
                {VARIABLE market_name "Southern Goods"}
                {VARIABLE market_role "south_goods"}
            [/case]
        [/switch]

        {FIND_NEAREST_HEX market_start $map_signs[$rnd_dir].x $map_signs[$rnd_dir].y (
            {NOT_FILTER}
            terrain=!,W*,*^Y*,*^V*,K*,C*
        ) }

        [unit]
            name=$market_name
            passable=yes
            placement=map
            random_traits=no
            role=$market_role
            side=9
            type=Caravan
            x=$market_start.x
            y=$market_start.y
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
            {IS_LOYAL}
            to_variable=market_unit
        [/unit]

        [unstore_unit]
            variable=market_unit
            find_vacant=yes
            check_passability=yes
            animate=yes
            text=$market_name
            # fire_event=yes
        [/unstore_unit]

        [if]
            {VARIABLE_CONDITIONAL wf_vars.armor_caravan boolean_equals yes}
            [then]
                [modify_unit]
                    [filter]
                        id=$market_unit.id
                    [/filter]
                    [object]
                        # TRAIT_RESILIENT
                        [effect]
                            apply_to=hitpoints
                            increase_total=4
                            heal_full=yes
                        [/effect]
                        [effect]
                            apply_to=new_ability
                            [abilities]
                                {ABILITY_REGENERATES}
                            [/abilities]
                        [/effect]
                        [effect]
                            apply_to=new_attack
                            name=sword
                            description=_"sword"
                            type=blade
                            range=melee
                            damage=10
                            number=4
                            [specials]
                                {WEAPON_SPECIAL_MAGICAL}
                            [/specials]
                            icon="attacks/sword-holy.png"
                        [/effect]
                        [effect]
                            apply_to=new_animation
                            [attack_anim]
                                [filter_attack]
                                    name=sword
                                [/filter_attack]
                                start_time=-200
                                horse_sound_start_time=-200
                                offset=0~0.6:200,0.6~0:200
                                [horse_sound_frame]
                                    sound=horse-canter.wav
                                [/horse_sound_frame]
                                {SOUND:HIT_AND_MISS {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS} -100}
                            [/attack_anim]
                        [/effect]
                        [effect]
                            apply_to=new_attack
                            name=bow
                            description=_"bow"
                            type=pierce
                            range=ranged
                            damage=10
                            number=4
                            [specials]
                                {WEAPON_SPECIAL_MAGICAL}
                            [/specials]
                            icon="attacks/bow-elven.png"
                        [/effect]
                        [effect]
                            apply_to=new_animation
                            [attack_anim]
                                [filter_attack]
                                    name=bow
                                [/filter_attack]
                                start_time=-250
                                missile_start_time=-150

                                [missile_frame]
                                    duration=150
                                    image="projectiles/missile-n.png"
                                    image_diagonal="projectiles/missile-ne.png"
                                [/missile_frame]
                                {SOUND:HIT_AND_MISS bow-puny.ogg bow-puny-miss.ogg -225}
                            [/attack_anim]
                        [/effect]
                    [/object]
                [/modify_unit]
            [/then]
        [/if]

        {WF_SCROLL_UNIT (id=$market_unit.id)}

        [message]
            speaker=$market_unit.id
            message=_"Pray grant us safe passage to your windmill, milord. For our cargo carries the finest imports."
        [/message]

        {CLEAR_VARIABLE market_start}
        {CLEAR_VARIABLE market_unit}
        {CLEAR_VARIABLE market_name}
        {CLEAR_VARIABLE market_role}
        {CLEAR_VARIABLE rnd_dir}
    [/event]

    {WF_MARKET_EVENTS}
#enddef

#define WF_MARKET_EVENTS
    [event]
        name=wf_market
        id=wf_market
        first_time_only=no
        # No effect in parent
        #delayed_variable_substitution=no

        [remove_event]
            id=moveto_sale_item_$weapon.x|_$weapon.y|
        [/remove_event]
        [remove_item]
            x,y=$weapon.x,$weapon.y
            image=items/chest-open.png
        [/remove_item]
        [item]
            x,y=$weapon.x,$weapon.y
            image=items/chest-open.png
        [/item]
        [label]
            x,y=$weapon.x,$weapon.y
            text="$weapon.label1|
$weapon.label2|
$weapon.label3|"
        [/label]

        # Freeze nearby caravans
        [store_unit]
            [filter]
                side=9
                [not]
                    ability=frozen
                    [or]
                        ability=guard
                    [/or]
                    [or]
                        ability=fallback
                    [/or]
                    [or]
                        ability=coward
                    [/or]
                    [or]
                        ability=tavern
                    [/or]
                [/not]
                type=Caravan
                [filter_location]
                    x,y=$weapon.x,$weapon.y
                    radius=5
                [/filter_location]
                [not]
                    x,y=$weapon.x,$weapon.y
                [/not]
            [/filter]
            variable=unit_market
            mode=always_clear
        [/store_unit]
        [foreach]
            array=unit_market
            [do]
                {FREEZE_UNIT $this_item.id $this_item.x $this_item.y}
                [message]
                    id=$this_item.id
                    message=_"Whoa, I'll halt right here."
                [/message]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE unit_market}

        {WF_MARKET_ITEMS}

        {RANDOM_VAR relic_id "1..99999"}
        [if]
            {VARIABLE_CONDITIONAL wf_market_items[$weapon.index1].object.length greater_than 0}
            [then]
                {VARIABLE wf_market_items[$weapon.index1].object[0].id "$wf_market_items[$weapon.index1].object[0].name $relic_id"}
            [/then]
        [/if]
        [if]
            {VARIABLE_CONDITIONAL wf_market_items[$weapon.index2].object.length greater_than 0}
            [then]
                {VARIABLE wf_market_items[$weapon.index2].object[0].id "$wf_market_items[$weapon.index2].object[0].name $relic_id"}
            [/then]
        [/if]
        [if]
            {VARIABLE_CONDITIONAL wf_market_items[$weapon.index3].object.length greater_than 0}
            [then]
                {VARIABLE wf_market_items[$weapon.index3].object[0].id "$wf_market_items[$weapon.index3].object[0].name $relic_id"}
            [/then]
        [/if]
        {CLEAR_VARIABLE relic_id}

        # start moveto {
        [event]
            name=moveto
            id=moveto_sale_item_$weapon.x|_$weapon.y|
            first_time_only=no
            delayed_variable_substitution=no
            [filter]
                side=1
                x,y=$weapon.x,$weapon.y
            [/filter]

            {WF_MARKET_ITEMS}

            {VARIABLE unit_has_item1 no}
            {VARIABLE unit_has_item2 no}
            {VARIABLE unit_has_item3 no}
            {VARIABLE sold no}

            [set_variables]
                name=exclude_object1
                mode=replace
                [split]
                    list=$wf_market_items[$weapon.index1].exclude_object
                    key=name
                    separator=,
                    remove_empty=yes
                [/split]
            [/set_variables]
            [if]
                {VARIABLE_CONDITIONAL wf_market_items[$weapon.index1].take_once not_equals no}
                [then]
                    [set_variables]
                        name=exclude_object1
                        mode=append
                        [value]
                            name=$wf_market_items[$weapon.index1].object.name
                        [/value]
                    [/set_variables]
                [/then]
            [/if]

            [set_variables]
                name=exclude_object2
                mode=replace
                [split]
                    list=$wf_market_items[$weapon.index2].exclude_object
                    key=name
                    separator=,
                    remove_empty=yes
                [/split]
            [/set_variables]
            [if]
                {VARIABLE_CONDITIONAL wf_market_items[$weapon.index2].take_once not_equals no}
                [then]
                    [set_variables]
                        name=exclude_object2
                        mode=append
                        [value]
                            name=$wf_market_items[$weapon.index2].object.name
                        [/value]
                    [/set_variables]
                [/then]
            [/if]

            [set_variables]
                name=exclude_object3
                mode=replace
                [split]
                    list=$wf_market_items[$weapon.index3].exclude_object
                    key=name
                    separator=,
                    remove_empty=yes
                [/split]
            [/set_variables]
            [if]
                {VARIABLE_CONDITIONAL wf_market_items[$weapon.index3].take_once not_equals no}
                [then]
                    [set_variables]
                        name=exclude_object3
                        mode=append
                        [value]
                            name=$wf_market_items[$weapon.index3].object.name
                        [/value]
                    [/set_variables]
                [/then]
            [/if]

            [foreach]
                array=unit.modifications.object
                [do]
                    [foreach]
                        array=exclude_object1
                        variable=inner_var
                        [do]
                            [if]
                                {VARIABLE_CONDITIONAL this_item.name equals $|inner_var.name}
                                [then]
                                    {VARIABLE unit_has_item1 yes}
                                [/then]
                            [/if]
                        [/do]
                    [/foreach]

                    [foreach]
                        array=exclude_object2
                        variable=inner_var
                        [do]
                            [if]
                                {VARIABLE_CONDITIONAL this_item.name equals $|inner_var.name}
                                [then]
                                    {VARIABLE unit_has_item2 yes}
                                [/then]
                            [/if]
                        [/do]
                    [/foreach]

                    [foreach]
                        array=exclude_object3
                        variable=inner_var
                        [do]
                            [if]
                                {VARIABLE_CONDITIONAL this_item.name equals $|inner_var.name}
                                [then]
                                    {VARIABLE unit_has_item3 yes}
                                [/then]
                            [/if]
                        [/do]
                    [/foreach]
                [/do]
            [/foreach]

            {CLEAR_VARIABLE exclude_object1}
            {CLEAR_VARIABLE exclude_object2}
            {CLEAR_VARIABLE exclude_object3}

            [if]
                {VARIABLE_CONDITIONAL wf_market_items[$weapon.index1].exclude_filter.length greater_than 0}
                [then]
                    [if]
                        [have_unit]
                            id=$|unit.id
                            x=$|x1
                            y=$|y1
                            [insert_tag]
                                name=and
                                variable=wf_market_items[$weapon.index1].exclude_filter
                            [/insert_tag]
                        [/have_unit]
                        [then]
                            {VARIABLE unit_has_item1 yes}
                        [/then]
                    [/if]
                [/then]
            [/if]

            [if]
                {VARIABLE_CONDITIONAL wf_market_items[$weapon.index2].exclude_filter.length greater_than 0}
                [then]
                    [if]
                        [have_unit]
                            id=$|unit.id
                            x=$|x1
                            y=$|y1
                            [insert_tag]
                                name=and
                                variable=wf_market_items[$weapon.index2].exclude_filter
                            [/insert_tag]
                        [/have_unit]
                        [then]
                            {VARIABLE unit_has_item2 yes}
                        [/then]
                    [/if]
                [/then]
            [/if]

            [if]
                {VARIABLE_CONDITIONAL wf_market_items[$weapon.index3].exclude_filter.length greater_than 0}
                [then]
                    [if]
                        [have_unit]
                            id=$|unit.id
                            x=$|x1
                            y=$|y1
                            [insert_tag]
                                name=and
                                variable=wf_market_items[$weapon.index3].exclude_filter
                            [/insert_tag]
                        [/have_unit]
                        [then]
                            {VARIABLE unit_has_item3 yes}
                        [/then]
                    [/if]
                [/then]
            [/if]

            [store_gold]
                side=1
                variable=wf_vars.side1_gold
            [/store_gold]

            [message]
                speaker=unit
                message=_"Take one of:"
                [option]
                    [show_if]
                        {VARIABLE_CONDITIONAL unit_has_item1 boolean_equals yes}
                        [or]
                            [variable]
                                name=wf_vars.side1_gold
                                less_than=$weapon.price1
                            [/variable]
                        [/or]
                    [/show_if]
                    label=_"<span color='#808080'>Buy '$wf_market_items[$weapon.index1].name|' for $weapon.price1| gold.</span>
<span color='#808080'>$wf_market_items[$weapon.index1].message</span>"
                    [command]
                    [/command]
                [/option]
                [option]
                    [show_if]
                        {VARIABLE_CONDITIONAL unit_has_item1 boolean_equals no}
                        [variable]
                            name=wf_vars.side1_gold
                            greater_than_equal_to=$weapon.price1
                        [/variable]
                    [/show_if]
                    label=_"Buy '$wf_market_items[$weapon.index1].name|' for $weapon.price1| gold.
$wf_market_items[$weapon.index1].message"
                    [command]
                        {VARIABLE sold yes}
                        [gold]
                            side=1
                            amount=$weapon.pay1
                        [/gold]

                        [if]
                            {VARIABLE_CONDITIONAL wf_market_items[$weapon.index1].object.length greater_than 0}
                            [then]
                                {VARIABLE give_overlay yes}
                                [store_unit]
                                    [filter]
                                        x,y=$weapon.x,$weapon.y
                                    [/filter]
                                    kill=no
                                    variable=unit_market
                                    mode=always_clear
                                [/store_unit]
                                [for]
                                    array=unit_market.modifications.object
                                    reverse=yes
                                    [do]
                                        [if]
                                            {VARIABLE_CONDITIONAL unit_market.modifications.object[$|i].id equals "pickable_overlay"}
                                            [then]
                                                {VARIABLE give_overlay no}
                                            [/then]
                                        [/if]
                                    [/do]
                                [/for]
                                {CLEAR_VARIABLE unit_market}
                                [if]
                                    {VARIABLE_CONDITIONAL give_overlay boolean_equals yes}
                                    [then]
                                        [object]
                                            id="pickable_overlay"
                                            take_only_once=no
                                            [effect]
                                                apply_to=overlay
                                                add=misc/pickable-overlay.png
                                            [/effect]
                                        [/object]
                                    [/then]
                                [/if]
                                {CLEAR_VARIABLE give_overlay}
                                [insert_tag]
                                    name=object
                                    variable=wf_market_items[$weapon.index1].object
                                [/insert_tag]
                            [/then]
                        [/if]

                        [if]
                            {VARIABLE_CONDITIONAL wf_market_items[$weapon.index1].event.length greater_than 0}
                            [then]
                                [insert_tag]
                                    name=event
                                    variable=wf_market_items[$weapon.index1].event
                                [/insert_tag]
                                [fire_event]
                                    name=$wf_market_items[$weapon.index1].event[0].name
                                    [primary_unit]
                                        x,y=$weapon.x,$weapon.y
                                    [/primary_unit]
                                [/fire_event]
                            [/then]
                        [/if]
                    [/command]
                [/option]
                [option]
                    [show_if]
                        {VARIABLE_CONDITIONAL unit_has_item2 boolean_equals yes}
                        [or]
                            [variable]
                                name=wf_vars.side1_gold
                                less_than=$weapon.price2
                            [/variable]
                        [/or]
                    [/show_if]
                    label=_"<span color='#808080'>Buy '$wf_market_items[$weapon.index2].name|' for $weapon.price2| gold.</span>
<span color='#808080'>$wf_market_items[$weapon.index2].message</span>"
                    [command]
                    [/command]
                [/option]
                [option]
                    [show_if]
                        {VARIABLE_CONDITIONAL unit_has_item2 boolean_equals no}
                        [variable]
                            name=wf_vars.side1_gold
                            greater_than_equal_to=$weapon.price2
                        [/variable]
                    [/show_if]
                    label=_"Buy '$wf_market_items[$weapon.index2].name|' for $weapon.price2| gold.
$wf_market_items[$weapon.index2].message"
                    [command]
                        {VARIABLE sold yes}
                        [gold]
                            side=1
                            amount=$weapon.pay2
                        [/gold]
                        [if]
                            {VARIABLE_CONDITIONAL wf_market_items[$weapon.index2].object.length greater_than 0}
                            [then]
                                {VARIABLE give_overlay yes}
                                [store_unit]
                                    [filter]
                                        x,y=$weapon.x,$weapon.y
                                    [/filter]
                                    kill=no
                                    variable=unit_market
                                    mode=always_clear
                                [/store_unit]
                                [for]
                                    array=unit_market.modifications.object
                                    reverse=yes
                                    [do]
                                        [if]
                                            {VARIABLE_CONDITIONAL unit_market.modifications.object[$|i].id equals "pickable_overlay"}
                                            [then]
                                                {VARIABLE give_overlay no}
                                            [/then]
                                        [/if]
                                    [/do]
                                [/for]
                                {CLEAR_VARIABLE unit_market}
                                [if]
                                    {VARIABLE_CONDITIONAL give_overlay boolean_equals yes}
                                    [then]
                                        [object]
                                            id="pickable_overlay"
                                            take_only_once=no
                                            [effect]
                                                apply_to=overlay
                                                add=misc/pickable-overlay.png
                                            [/effect]
                                        [/object]
                                    [/then]
                                [/if]
                                {CLEAR_VARIABLE give_overlay}
                                [insert_tag]
                                    name=object
                                    variable=wf_market_items[$weapon.index2].object
                                [/insert_tag]
                            [/then]
                        [/if]
                        [if]
                            {VARIABLE_CONDITIONAL wf_market_items[$weapon.index2].event.length greater_than 0}
                            [then]
                                [insert_tag]
                                    name=event
                                    variable=wf_market_items[$weapon.index2].event
                                [/insert_tag]
                                [fire_event]
                                    name=$wf_market_items[$weapon.index2].event[0].name
                                    [primary_unit]
                                        x,y=$weapon.x,$weapon.y
                                    [/primary_unit]
                                [/fire_event]
                            [/then]
                        [/if]
                    [/command]
                [/option]
                [option]
                    [show_if]
                        {VARIABLE_CONDITIONAL unit_has_item3 boolean_equals yes}
                        [or]
                            [variable]
                                name=wf_vars.side1_gold
                                less_than=$weapon.price3
                            [/variable]
                        [/or]
                    [/show_if]
                    label=_"<span color='#808080'>Buy '$wf_market_items[$weapon.index3].name|' for $weapon.price3| gold.</span>
<span color='#808080'>$wf_market_items[$weapon.index3].message</span>"
                    [command]
                    [/command]
                [/option]
                [option]
                    [show_if]
                        {VARIABLE_CONDITIONAL unit_has_item3 boolean_equals no}
                        [variable]
                            name=wf_vars.side1_gold
                            greater_than_equal_to=$weapon.price3
                        [/variable]
                    [/show_if]
                    label=_"Buy '$wf_market_items[$weapon.index3].name|' for $weapon.price3| gold.
$wf_market_items[$weapon.index3].message"
                    [command]
                        {VARIABLE sold yes}
                        [gold]
                            side=1
                            amount=$weapon.pay3
                        [/gold]
                        [if]
                            {VARIABLE_CONDITIONAL wf_market_items[$weapon.index3].object.length greater_than 0}
                            [then]
                                {VARIABLE give_overlay yes}
                                [store_unit]
                                    [filter]
                                        x,y=$weapon.x,$weapon.y
                                    [/filter]
                                    kill=no
                                    variable=unit_market
                                    mode=always_clear
                                [/store_unit]
                                [for]
                                    array=unit_market.modifications.object
                                    reverse=yes
                                    [do]
                                        [if]
                                            {VARIABLE_CONDITIONAL unit_market.modifications.object[$|i].id equals "pickable_overlay"}
                                            [then]
                                                {VARIABLE give_overlay no}
                                            [/then]
                                        [/if]
                                    [/do]
                                [/for]
                                {CLEAR_VARIABLE unit_market}
                                [if]
                                    {VARIABLE_CONDITIONAL give_overlay boolean_equals yes}
                                    [then]
                                        [object]
                                            id="pickable_overlay"
                                            take_only_once=no
                                            [effect]
                                                apply_to=overlay
                                                add=misc/pickable-overlay.png
                                            [/effect]
                                        [/object]
                                    [/then]
                                [/if]
                                {CLEAR_VARIABLE give_overlay}
                                [insert_tag]
                                    name=object
                                    variable=wf_market_items[$weapon.index3].object
                                [/insert_tag]
                            [/then]
                        [/if]
                        [if]
                            {VARIABLE_CONDITIONAL wf_market_items[$weapon.index3].event.length greater_than 0}
                            [then]
                                [insert_tag]
                                    name=event
                                    variable=wf_market_items[$weapon.index3].event
                                [/insert_tag]
                                [fire_event]
                                    name=$wf_market_items[$weapon.index3].event[0].name
                                    [primary_unit]
                                        x,y=$weapon.x,$weapon.y
                                    [/primary_unit]
                                [/fire_event]
                            [/then]
                        [/if]
                    [/command]
                [/option]
                [option]
                    label=_"Not now"
                    [command]
                    [/command]
                [/option]
            [/message]

            [if]
                {VARIABLE_CONDITIONAL sold boolean_equals yes}
                [then]
                    [sound]
                        name=gold.ogg
                    [/sound]
                    [store_gold]
                        side=1
                        variable=wf_vars.side1_gold
                    [/store_gold]
                    [if]
                        {VARIABLE_CONDITIONAL wf_vars.side1_gold less_than 100}
                        [then]
                            {FIRE_EVENT low_gold}
                        [/then]
                    [/if]
                    [remove_item]
                        x,y=$weapon.x,$weapon.y
                        image=items/chest-open.png
                    [/remove_item]
                    [label]
                        x,y=$weapon.x,$weapon.y
                        text=""
                    [/label]

                    # Un-Freeze nearby caravans
                    [store_unit]
                        [filter]
                            side=9
                            ability=frozen
                            type=Caravan
                            [filter_location]
                                x,y=$weapon.x,$weapon.y
                                radius=5
                            [/filter_location]
                        [/filter]
                        variable=unit_market
                        mode=always_clear
                    [/store_unit]
                    [foreach]
                        array=unit_market
                        [do]
                            {THAW_UNIT $|this_item.id $|this_item.x $|this_item.y}
                            [message]
                                id=$|this_item.id
                                message=_"Giddyup!"
                            [/message]
                        [/do]
                    [/foreach]
                    {CLEAR_VARIABLE unit_market}

                    [remove_event]
                        id=moveto_sale_item_$weapon.x|_$weapon.y|
                    [/remove_event]
                [/then]
            [/if]

            {CLEAR_VARIABLE sold}
            {CLEAR_VARIABLE unit_has_item1}
            {CLEAR_VARIABLE unit_has_item2}
            {CLEAR_VARIABLE unit_has_item3}
            {CLEAR_VARIABLE wf_market_items}
        [/event]
        # end moveto }
        {CLEAR_VARIABLE wf_market_items}
    [/event]
#enddef

#define WF_MARKET_ITEMS
    # Effects lifted from: Heroes
    #market=starting bonus 1 | caravan market 2 | disabled not for sale 3 | filler 4
    [set_variables]
        name=wf_market_items
        mode=replace
        [literal]
            name="Ring of Swiftness"
            message="This ring grants +2 movement points."
            market=2
            [object]
                name="Ring of Swiftness"
                image=items/ring-gold.png
                description=_"This ring grants +2 movement points."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=swift
                            name=_"swift"
                            female_name= _ "female^swift"
                            description=_"This unit's movement is increased by +2 points."
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=movement
                    increase=2
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Staff of Horror"
            message="Saps the life energy of nearby enemy and decreases their damage by 25%."
            market=1
            [object]
                name="Staff of Horror"
                image=items/staff.png
                description=_"Decreases the damage of nearby enemy units by 25%"
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [leadership]
                            id=magic sap
                            value=-25
                            cumulative=no
                            name= _ "magic sap"
                            female_name= _ "female^magic sap"
                            description= _ "This unit saps the life energy of nearby enemy units and decreases their damage by 25%."
                            affect_self=no
                            affect_enemies=yes
                            affect_allies=no
                            [affect_adjacent]
                                [filter]
                                [/filter]
                            [/affect_adjacent]
                        [/leadership]
                    [/abilities]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Heart of the Wose"
            message="This item grants +8 regeneration and curing ability."
            market=1
            [exclude_filter]
                ability=healing,regenerates,curing
            [/exclude_filter]
            [object]
                name="Heart of the Wose"
                image=items/ball-green.png
                description=_"The Heart of the Wose grants +8 regeneration and curing ability."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_REGENERATES}
                        {ABILITY_CURES}
                    [/abilities]
                [/effect]
                #[effect]
                #    apply_to=halo
                #    halo=halo/elven/elven-shield-halo-100pct.png
                #[/effect]
            [/object]
        [/literal]
        [literal]
            name="Armor of the Thane"
            message="This item inspires nearby units to increase the damage by +25%."
            market=1
            [object]
                name="Armor of the Thane"
                image=items/armor-golden.png
                description=_"Increases the damage of nearby units by +25%"
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [leadership]
                            id=inspire
                            value=25
                            cumulative=yes
                            name= _ "inspire"
                            description= _ "This unit can inspire adjacent friendly units, making them do 25% more damage."
                            affect_self=no
                            affect_enemies=no
                            affect_allies=yes
                            [affect_adjacent]
                                [filter]
                                [/filter]
                            [/affect_adjacent]
                        [/leadership]
                    [/abilities]
                [/effect]
                #[effect]
                #    apply_to=halo
                #    halo=halo/elven/elven-shield-halo-100pct.png
                #[/effect]
            [/object]
        [/literal]
        [literal]
            name="Winged Circlet"
            message="The bearer of the Winged Circlet needs 25% less experience to advance."
            market=2
            take_once=no
            [object]
                name="Winged Circlet"
                image=icons/circlet_winged.png
                description=_"The bearer of the Winged Circlet needs 25% less experience to advance."
                take_only_once=no
                [effect]
                    apply_to=max_experience
                    increase=-25%
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Rusty Arrows"
            message="This modifier grants the poison special to ranged pierce attacks."
            market=2
            [exclude_filter]
                [not]
                    [has_attack]
                        range=ranged
                        type=pierce
                    [/has_attack]
                [/not]
                [or]
                    [has_attack]
                        special=poison
                    [/has_attack]
                [/or]
            [/exclude_filter]
            [object]
                name="Rusty Arrows"
                image=items/potion-poison.png
                description=_"Grants the poison special to ranged pierce attacks."
                take_only_once=no
                [effect]
                    apply_to=attack
                    range=ranged
                    type=pierce
                    [set_specials]
                        mode=append
                        {WEAPON_SPECIAL_POISON}
                    [/set_specials]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Poison Vial"
            message="This modifier grants the poison special to melee blade or pierce attacks."
            market=2
            [exclude_filter]
                [not]
                    [has_attack]
                        range=melee
                        type=pierce,blade
                    [/has_attack]
                [/not]
                [or]
                    [has_attack]
                        special=poison
                    [/has_attack]
                [/or]
            [/exclude_filter]
            [object]
                name="Poison Vial"
                image=items/potion-poison.png
                description=_"Grants the poison special to melee blade or pierce attacks."
                take_only_once=no
                [effect]
                    apply_to=attack
                    range=melee
                    type=pierce
                    [set_specials]
                        mode=append
                        {WEAPON_SPECIAL_POISON}
                    [/set_specials]
                [/effect]
                [effect]
                    apply_to=attack
                    range=melee
                    type=blade
                    [set_specials]
                        mode=append
                        {WEAPON_SPECIAL_POISON}
                    [/set_specials]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Eye of the Dragon"
            message="Grants another attack per turn."
            market=2
            [object]
                name="Eye of the Dragon"
                image=items/ball-blue.png
                description=_"Grants another attack per turn."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=eod
                            name=_"EoD"
                            female_name= _ "female^EoD"
                            description=_"This unit gets another attack per turn."
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=max_attacks
                    increase=1
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Green Cloak"
            message="This cloak grants the ambush ability."
            market=2
            [exclude_filter]
                ability=ambush
            [/exclude_filter]
            [object]
                name="Green Cloak"
                image=items/cloak-green.png
                description=_"This cloak grants the ambush ability."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_AMBUSH}
                    [/abilities]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Black Cloak"
            message="This cloak grants the nightstalk ability."
            market=2
            [exclude_filter]
                ability=nightstalk
            [/exclude_filter]
            [object]
                name="Black Cloak"
                image=items/cloak-green.png
                description=_"This cloak grants the nightstalk ability."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_NIGHTSTALK}
                    [/abilities]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="White Cloak"
            message="This cloak grants the concealment ability."
            market=2
            [exclude_filter]
                ability=concealment
            [/exclude_filter]
            [object]
                name="White Cloak"
                image=items/cloak-green.png
                description=_"This cloak grants the concealment ability."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_CONCEALMENT}
                    [/abilities]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Red Cloak"
            message="This cloak grants the skirmisher ability."
            market=2
            [exclude_filter]
                ability=skirmisher
            [/exclude_filter]
            [object]
                name="Red Cloak"
                image=items/cloak-green.png
                description=_"This cloak grants the skirmisher ability."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_SKIRMISHER}
                    [/abilities]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Notes of War XI"
            message="This book grants the leadership ability."
            market=1
            [exclude_filter]
                ability=leadership
            [/exclude_filter]
            [object]
                name="Notes of War XI"
                image=items/book4.png
                description=_"This book grants the leadership ability."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_LEADERSHIP}
                    [/abilities]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Chain Armor"
            message="This armor increases the attack parry bonus by 10%."
            market=2
            [object]
                name="Chain Armor"
                image=icons/armor-chain.png
                description=_"Increases the attack parry bonus by 10%"
                take_only_once=no
                [effect]
                    apply_to=attack
                    increase_parry=10%
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Breastplate"
            message="This item grants +30 hitpoints."
            market=2
            take_once=no
            [object]
                name="Breastplate"
                image=icons/breastplate.png
                description=_"Grants +30 hitpoints"
                take_only_once=no
                [effect]
                    apply_to=hitpoints
                    increase_total=30
                    heal_full=yes
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Bidhander"
            message="This modifier increases the damage of melee blade type attacks by +2 and grants the slow special."
            market=1
            [exclude_filter]
                [not]
                    [has_attack]
                        range=melee
                        type=blade
                    [/has_attack]
                [/not]
                [or]
                    [has_attack]
                        special=slow
                    [/has_attack]
                [/or]
            [/exclude_filter]
            [object]
                name="Bidhander"
                image=items/sword.png
                description=_"Increases the attack damage of melee blade type attacks by +2 and grants the slow special."
                take_only_once=no
                [effect]
                    apply_to=attack
                    range=melee
                    type=blade
                    increase_damage=2
                    #increase_attacks=1
                    #set_description=bidhander
                [/effect]
                [effect]
                    apply_to=attack
                    type=blade
                    range=melee
                    [set_specials]
                        mode=append
                        {WEAPON_SPECIAL_SLOW}
                    [/set_specials]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Spear of Gobo"
            message="This modifier increases the damage of melee pierce type attacks by +2 and grants the slow special."
            market=2
            [exclude_filter]
                [not]
                    [has_attack]
                        range=melee
                        type=pierce
                    [/has_attack]
                [/not]
                [or]
                    [has_attack]
                        special=slow
                    [/has_attack]
                [/or]
            [/exclude_filter]
            [object]
                name="Spear of Gobo"
                image=items/spear-fancy.png
                description=_"Increases the attack damage of melee pierce type attacks by +2 and grants the slow special."
                take_only_once=no
                [effect]
                    apply_to=attack
                    range=melee
                    type=pierce
                    increase_damage=2
                    #increase_attacks=1
                    #set_description=gobo spear
                [/effect]
                [effect]
                    apply_to=attack
                    type=pierce
                    range=melee
                    [set_specials]
                        mode=append
                        {WEAPON_SPECIAL_SLOW}
                    [/set_specials]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Staff of Alduin"
            message="This modifier increases the damage of ranged arcane type attacks by +2 and grants the slow special."
            market=2
            [exclude_filter]
                [not]
                    [has_attack]
                        range=ranged
                        type=arcane
                    [/has_attack]
                [/not]
                [or]
                    [has_attack]
                        special=slow
                    [/has_attack]
                [/or]
            [/exclude_filter]
            [object]
                name="Staff of Alduin"
                image=items/staff.png
                description=_"Increases the attack damage of ranged arcane type attacks by +2 and grants the slow special."
                take_only_once=no
                [effect]
                    apply_to=attack
                    type=arcane
                    range=ranged
                    increase_damage=2
                    #increase_attacks=1
                [/effect]
                [effect]
                    apply_to=attack
                    type=arcane
                    range=ranged
                    [set_specials]
                        mode=append
                        {WEAPON_SPECIAL_SLOW}
                    [/set_specials]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Staff of Freezing Death"
            message="This staff grants a new melee slowing cold attack."
            market=2
            [object]
                name="Staff of Freezing Death"
                image=items/staff-magic.png
                description=_"Grants a melee slowing cold attack"
                take_only_once=no
                [effect]
                    apply_to=new_attack
                    name=staff_of_freezing_death
                    description=_"staff of freezing death"
                    type=cold
                    damage=8
                    number=3
                    range=melee
                    [specials]
                        {WEAPON_SPECIAL_SLOW}
                    [/specials]
                    icon=attacks/staff-magic.png
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=staff_of_freezing_death
                        [/filter_attack]
                        start_time=-200
                        offset=0~0.6:200,0.6~0:200
                        {SOUND:HIT_AND_MISS staff.ogg staff-miss.ogg -125}
                    [/attack_anim]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Storm Trident"
            message="This trident grants a new ranged fire attack."
            market=2
            [object]
                name="Storm Trident"
                image=items/storm-trident.png
                description=_"Grants a ranged fire attack"
                take_only_once=no
                [effect]
                    apply_to=new_attack
                    name="storm trident"
                    description= _ "storm trident"
                    icon=attacks/lightning.png
                    type=fire
                    range=ranged
                    [specials]
                        {WEAPON_SPECIAL_MAGICAL}
                    [/specials]
                    damage=14
                    number=2
                [/effect]
                {LIGHTNING_ANIMATION "storm trident" 1}
                {LIGHTNING_ANIMATION "storm trident" 2}
                {LIGHTNING_ANIMATION "storm trident" 3}
            [/object]
        [/literal]
        [literal]
            name="Crystal Hammer"
            message="This modifier increases the damage of melee impact type attacks by +2 and grants the slow special."
            market=2
            [exclude_filter]
                [not]
                    [has_attack]
                        type=impact
                        range=melee
                    [/has_attack]
                [/not]
                [or]
                    [has_attack]
                        special=slow
                    [/has_attack]
                [/or]
            [/exclude_filter]
            [object]
                name="Crystal Hammer"
                image=items/hammer-runic.png
                description=_"Increases the attack damage of melee impact type attacks by +2 and grants the slow special."
                take_only_once=no
                [effect]
                    apply_to=attack
                    type=impact
                    range=melee
                    increase_damage=2
                    #increase_attacks=1
                [/effect]
                [effect]
                    apply_to=attack
                    type=impact
                    range=melee
                    [set_specials]
                        mode=append
                        {WEAPON_SPECIAL_SLOW}
                    [/set_specials]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Crystal Bow"
            message="This modifier increases the damage of ranged pierce type attacks by +2 and grants the slow special."
            market=1
            [exclude_filter]
                [not]
                    [has_attack]
                        type=pierce
                        range=ranged
                    [/has_attack]
                [/not]
                [or]
                    [has_attack]
                        special=slow
                    [/has_attack]
                [/or]
            [/exclude_filter]
            [object]
                name="Crystal Bow"
                image=items/bow-crystal.png
                description=_"Increases the attack damage of ranged pierce type attacks by +2 and grants the slow special."
                take_only_once=no
                [effect]
                    apply_to=attack
                    type=pierce
                    range=ranged
                    increase_damage=2
                    #increase_attacks=1
                [/effect]
                [effect]
                    apply_to=attack
                    range=ranged
                    type=pierce
                    [set_specials]
                        mode=append
                        {WEAPON_SPECIAL_SLOW}
                    [/set_specials]
                [/effect]
            [/object]
        [/literal]
        #CotF
        [literal]
            name="Ring of Major Resistance"
            message="This ring increases all of the wearer's resistance by 20%."
            market=2
            take_once=no
            [object]
                name="Ring of Major Resistance"
                image=icons/ring_gold.png
                description=_"This ring increases all of the wearer's resistance by 20%."
                take_only_once=no
                #[effect]
                #    apply_to=new_ability
                #    [abilities]
                #        [dummy]
                #            id=major_resistance
                #            name=_"major resistance"
                #            female_name= _ "female^major resistance"
                #            description=_"This unit's resistances are all increased by 20% from their base values."
                #        [/dummy]
                #    [/abilities]
                #[/effect]
                [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                        blade=-20
                        pierce=-20
                        impact=-20
                        fire=-20
                        cold=-20
                        arcane=-20
                    [/resistance]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Ring of Blade Resistance"
            message="This ring increases the wearer's blade resistance by 10%."
            market=2
            take_once=no
            [object]
                name="Ring of Blade Resistance"
                image=icons/ring_gold.png
                description=_"This ring increases the wearer's blade resistance by 10%."
                take_only_once=no
                [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                        blade=-10
                    [/resistance]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Ring of Impact Resistance"
            message="This ring increases the wearer's impact resistance by 10%."
            market=2
            take_once=no
            [object]
                name="Ring of Impact Resistance"
                image=icons/ring_gold.png
                description=_"Ring of Impact Resistance: This ring increases the wearer's impact resistance by 10%."
                take_only_once=no
                [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                        impact=-10
                    [/resistance]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Ring of Pierce Resistance"
            message="This ring increases the wearer's pierce resistance by 10%."
            market=2
            take_once=no
            [object]
                name="Ring of Pierce Resistance"
                image=icons/ring_gold.png
                description=_"This ring increases the wearer's pierce resistance by 10%."
                take_only_once=no
                [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                        pierce=-10
                    [/resistance]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Ring of Weather Resistance"
            message="This ring increases the wearer's fire and cold resistances by 10%."
            market=2
            take_once=no
            [object]
                name="Ring of Weather Resistance"
                image=icons/ring_gold.png
                description=_"This ring increases the wearer's fire and cold resistances by 10%."
                take_only_once=no
                [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                        fire=-10
                        cold=-10
                    [/resistance]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Ring of Arcane Resistance"
            message="This ring increases the wearer's arcane resistance by 10%."
            market=2
            take_once=no
            [object]
                name="Ring of Arcane Resistance"
                image=icons/ring_gold.png
                description=_"This ring increases the wearer's arcane resistance by 10%."
                take_only_once=no
                [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                        arcane=-10
                    [/resistance]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Ring of Regeneration"
            message="This ring heals the wearer a little each turn."
            market=2
            [exclude_filter]
                ability=regenerates
            [/exclude_filter]
            [object]
                name="Ring of Regeneration"
                image=icons/ring_gold.png
                description=_"This ring heals the wearer a little each turn."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_REGENERATES}
                    [/abilities]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Ring of Regrowth"
            message="This ring heals the wearer as well as those nearby."
            market=2
            [exclude_filter]
                ability=healing,regenerates
            [/exclude_filter]
            [object]
                name="Ring of Regrowth"
                image=icons/ring_gold.png
                description=_"This ring heals the wearer as well as those nearby."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_REGENERATES}
                        {ABILITY_HEALS}
                    [/abilities]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Ring of Magnetism"
            message="This ring greatly increases the wearer's accuracy."
            market=2
            [object]
                name="Ring of Magnetism"
                image=icons/ring_gold.png
                description=_"This ring greatly increases the wearer's accuracy."
                take_only_once=no
                [effect]
                    apply_to=attack
                    remove_specials=magical,marksman,magnetic_cursed,truestrike
                [/effect]
                #[effect]
                #    apply_to=remove_ability
                #    [abilities]
                #        [dummy]
                #            id=truestrike
                #        [/dummy]
                #    [/abilities]
                #[/effect]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=magnetic
                            name=_"magnetic"
                            female_name=_"female^magnetic"
                            description=_"All of this unit's attacks have an extremely high chance to hit."
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=attack
                    [set_specials]
                        mode=append
                        [chance_to_hit]
                            id=magnetic
                            name=_"magnetic"
                            description=_"This attack always has a 90% chance to hit regardless of the defensive ability of the unit being attacked."
                            value=90
                            cumulative=no
                        [/chance_to_hit]
                    [/set_specials]
                [/effect]
            [/object]
            [event]
                name=cleanup_ability
                [modify_unit]
                    [filter]
                        x,y=$|unit.x,$|unit.y
                    [/filter]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            [dummy]
                                id=truestrike
                            [/dummy]
                        [/abilities]
                    [/effect]
                [/modify_unit]
            [/event]
        [/literal]
        [literal]
            name="Potion of Strength"
            message="This potion grants the drinker incredible strength."
            market=2
            [object]
                name="Potion of Strength"
                image=icons/potion_green_medium.png
                description=_"This potion grants the drinker incredible strength."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=strength
                            name=_"strength"
                            female_name= _ "female^strength"
                            description=_"This unit has incredible strength."
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=attack
                    increase_damage=2
                [/effect]
                [effect]
                    apply_to=hitpoints
                    increase_total=5
                    heal_full=yes
                [/effect]
            [/object]
            [event]
                name=superman
                {UNIT_SAYS _"I feel incredibly powerful! Where is the nearest orc? I shall disembowel him!"}
            [/event]
        [/literal]
        [literal]
            name="Potion of Dexterity"
            message="This potion grants the drinker extra strikes."
            market=2
            [object]
                name="Potion of Dexterity"
                image=icons/potion_green_medium.png
                description=_"This potion grants the drinker extra strikes."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=dexterous
                            name=_"dexterous"
                            female_name= _ "female^dexterous"
                            description=_"This unit has extra strikes."
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=attack
                    increase_attacks=2
                [/effect]
                [effect]
                    apply_to=hitpoints
                    increase_total=5
                    heal_full=yes
                [/effect]
            [/object]
            [event]
                name=superman
                {UNIT_SAYS _"I feel incredibly flexible! I am ready to pounce!"}
            [/event]
        [/literal]
        [literal]
            name="Potion of Illumination"
            message="This potion causes drinker to glow with a warm inner light."
            market=2
            exclude_object=Potion of Gloom
            [exclude_filter]
                ability=illumination
            [/exclude_filter]
            [object]
                name="Potion of Illumination"
                image=icons/potion_green_medium.png
                description=_"This potion causes drinker to glow with a warm inner light."
                take_only_once=no
                #[effect]
                #    apply_to=remove_ability
                #    [abilities]
                #        [illuminates]
                #            id=darkens
                #        [/illuminates]
                #    [/abilities]
                #[/effect]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_ILLUMINATES}
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=halo
                    halo=halo/illuminates-aura.png
                [/effect]
            [/object]
            [event]
                name=shining_light
                [modify_unit]
                    [filter]
                        x,y=$|unit.x,$|unit.y
                    [/filter]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            [illuminates]
                                id=darkens
                            [/illuminates]
                        [/abilities]
                    [/effect]
                [/modify_unit]
                {UNIT_SAYS _"I'm. . . I'm. . . I'm glowing!"}
                {UNIT_SAYS _"Hmmm. . . I guess this means no more covert nighttime rendezvous for me."}
            [/event]
        [/literal]
        [literal]
            name="Potion of Gloom"
            message="This potion casts a dark gloom over the drinker."
            market=2
            exclude_object=Potion of Illumination
            [object]
                name="Potion of Gloom"
                image=icons/potion_green_medium.png
                description=_"This potion casts a dark gloom over the drinker."
                take_only_once=no
                #[effect]
                #    apply_to=remove_ability
                #    [abilities]
                #        [illuminates]
                #            id=illumination
                #        [/illuminates]
                #    [/abilities]
                #[/effect]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [illuminates]
                            id=darkens
                            value=-25
                            min_value=-25
                            cumulative=no
                            name=_"darkens"
                            female_name=_"female^darkens"
                            description=_"This unit darkens the surrounding area, making lawful units fight worse, and chaotic units fight better."
                            affect_self=yes
                        [/illuminates]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=halo
                    halo=halo/darkens-aura.png
                [/effect]
            [/object]
            [event]
                name=hello_darkness
                [modify_unit]
                    [filter]
                        x,y=$|unit.x,$|unit.y
                    [/filter]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            [illuminates]
                                id=illumination
                            [/illuminates]
                        [/abilities]
                    [/effect]
                [/modify_unit]
                {UNIT_SAYS _"Hello darkness, my old friend..."}
            [/event]
        [/literal]
        [literal]
            name="Potion of Stoneskin"
            message="This potion hardens the drinker's skin, but greatly reduces movement."
            market=2
            [object]
                name="Potion of Stoneskin"
                image=icons/potion_green_medium.png
                description=_"This potion hardens the drinker's skin, but greatly reduces movement."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=stoneskin
                            name=_"stoneskin"
                            female_name= _ "female^stoneskin"
                            description=_"This unit is highly resistant to all forms of attack, but its hardened skin makes movement difficult."
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=resistance
                    replace=yes
                    [resistance]
                        blade=20
                        pierce=20
                        impact=20
                        fire=20
                        cold=20
                        arcane=80
                    [/resistance]
                [/effect]
                [effect]
                    apply_to=movement
                    set=4
                [/effect]
                [effect]
                    apply_to=movement_costs
                    replace=yes
                    [movement_costs]
                        shallow_water=2
                        reef=2
                        swamp_water=2
                        flat=1
                        sand=2
                        forest=2
                        hills=2
                        mountains=1
                        village=1
                        castle=1
                        cave=2
                        frozen=2
                        fungus=2
                    [/movement_costs]
                [/effect]
                [effect]
                    apply_to=defense
                    replace=yes
                    [defense]
                        shallow_water=90
                        reef=90
                        swamp_water=90
                        flat=80
                        sand=80
                        forest=70
                        hills=70
                        mountains=70
                        village=60
                        castle=60
                        cave=70
                        frozen=90
                        fungus=80
                    [/defense]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Potion of Flight"
            message="This potion causes the drinker to levitate a cubit or so above the ground."
            market=2
            [object]
                name="Potion of Flight"
                image=icons/potion_green_medium.png
                description=_"This potion causes the drinker to levitate a cubit or so above the ground."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=levitates
                            name=_"levitates"
                            female_name=_"female^levitates"
                            description=_"This unit can levitate, greatly reducing its movement costs over rough terrain."
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=movement_costs
                    replace=yes
                    [movement_costs]
                        shallow_water=1
                        reef=1
                        swamp_water=1
                        flat=1
                        sand=1
                        forest=1
                        hills=1
                        mountains=1
                        village=1
                        castle=1
                        cave=1
                        frozen=1
                        fungus=1
                        unwalkable=1
                    [/movement_costs]
                [/effect]
            [/object]
            #[event]
            #    name=flying_man
            #    [store_unit]
            #        variable=unit_to_levitate
            #        [filter]
            #            x,y=$|unit.x,$|unit.y
            #        [/filter]
            #    [/store_unit]
            #    {VARIABLE unit_to_levitate.flying yes}
            #    [unstore_unit]
            #        variable=unit_to_levitate
            #        find_vacant=no
            #    [/unstore_unit]
            #    {CLEAR_VARIABLE unit_to_levitate}
            #[/event]
        [/literal]
        [literal]
            name="Potion of Animal Nature"
            message="This potion reveals the drinker's hidden animal nature."
            market=1
            [object]
                name="Potion of Animal Nature"
                image=icons/potion_green_medium.png
                description=_"This potion reveals the drinker's hidden animal nature."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=animal
                            name=_"animal"
                            female_name=_"female^animal"
                            description=_"This unit gains several powerful attacks, at the cost of his or her humanity."
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=status
                    add=feral
                [/effect]
                [effect]
                    apply_to=new_attack
                    name=claws
                    description=_"claws"
                    type=blade
                    range=melee
                    damage=14
                    number=2
                    icon="attacks/claws-animal.png"
                    [specials]
                        {WEAPON_SPECIAL_POISON}
                    [/specials]
                [/effect]
                [effect]
                    apply_to=new_attack
                    name=fangs
                    description=_"fangs"
                    type=blade
                    range=melee
                    damage=14
                    number=2
                    icon="attacks/fangs-animal.png"
                    [specials]
                        {WEAPON_SPECIAL_DRAIN}
                    [/specials]
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=claws
                        [/filter_attack]
                        start_time=-200
                        offset=0~0.6:200,0.6~0:200
                        {SOUND:HIT_AND_MISS claws.ogg {SOUND_LIST:MISS} -100}
                    [/attack_anim]
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=fangs
                        [/filter_attack]
                        start_time=-200
                        offset=0~0.6:200,0.6~0:200
                        {SOUND:HIT_AND_MISS bite-small.ogg {SOUND_LIST:MISS} -100}
                    [/attack_anim]
                [/effect]
            [/object]
            [event]
                name=hear_me_meow
                [modify_unit]
                    [filter]
                        x,y=$|unit.x,$|unit.y
                    [/filter]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            [dummy]
                                id=stench
                            [/dummy]
                        [/abilities]
                    [/effect]
                [/modify_unit]
                {NARRATOR_SAYS _"The soldier's shoulders and chest begin to swell. Dark fur sprouts and teeth grown into razor-sharp fangs."}
                {UNIT_SAYS _"Raaaawwwwwwwrrrrrrrr!"}
                {HERO_SAYS ( {WHISPER _"trembles"} _" Is that still you in there?")}
                {UNIT_SAYS _"Aye, it is still me, milord, just a bit stronger than I used to be!"}
            [/event]
        [/literal]
        [literal]
            name="Staff of Plague"
            message="This staff grants a new melee plaguing impact attack."
            market=2
            [exclude_filter]
                [has_attack]
                    special=plague
                [/has_attack]
            [/exclude_filter]
            [object]
                name="Staff of Plague"
                image=items/staff.png
                description=_"Grants a melee plaguing impact attack"
                take_only_once=no
                [effect]
                    apply_to=new_attack
                    name=staff_of_plague
                    description=_"staff of plague"
                    icon=attacks/staff-plague.png
                    type=impact
                    range=melee
                    damage=6
                    number=3
                    [specials]
                        {WEAPON_SPECIAL_PLAGUE}
                    [/specials]
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=staff_of_plague
                        [/filter_attack]
                        start_time=-200
                        offset=0~0.6:200,0.6~0:200
                        {SOUND:HIT_AND_MISS staff.ogg staff-miss.ogg -125}
                    [/attack_anim]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Sword of Flame"
            message="A blade constructed from pure fire."
            market=2
            [object]
                name="Sword of Flame"
                image=items/flame-sword.png
                description=_"A blade constructed from pure fire."
                take_only_once=no
                [effect]
                    apply_to=new_attack
                    name=sword_of_flame
                    description=_"sword of flame"
                    type=fire
                    range=melee
                    damage=10
                    number=4
                    icon="attacks/longsword.png"
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=sword_of_flame
                        [/filter_attack]
                        start_time=-200
                        offset=0~0.6:200,0.6~0:200
                        {SOUND:HIT_AND_MISS {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS} -100}
                    [/attack_anim]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Axe of Ice"
            message="A short-handled axe crafted from enchanted ice."
            market=2
            [object]
                name="Axe of Ice"
                image=items/axe.png
                description=_"A short-handled axe crafted from enchanted ice."
                take_only_once=no
                [effect]
                    apply_to=new_attack
                    name=axe_of_ice
                    description=_"axe of ice"
                    type=cold
                    range=melee
                    damage=14
                    number=3
                    icon="attacks/battleaxe.png"
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=axe_of_ice
                        [/filter_attack]
                        start_time=-200
                        offset=0~0.6:200,0.6~0:200
                        {SOUND:HIT_AND_MISS axe.ogg {SOUND_LIST:MISS} -50}
                    [/attack_anim]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Arcane Bow"
            message="A bow that fires bolts of magical energy."
            market=2
            [object]
                name="Arcane Bow"
                image=items/bow-crystal.png
                description=_"A bow that fires bolts of magical energy."
                take_only_once=no
                [effect]
                    apply_to=new_attack
                    name=arcane_bow
                    description=_"arcane bow"
                    type=arcane
                    range=ranged
                    damage=9
                    number=3
                    [specials]
                        {WEAPON_SPECIAL_MAGICAL}
                    [/specials]
                    icon="attacks/bow-elven-magic.png"
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=arcane_bow
                        [/filter_attack]
                        start_time=-250
                        missile_start_time=-150

                        [missile_frame]
                            duration=150
                            image="projectiles/missile-n.png"
                            image_diagonal="projectiles/missile-ne.png"
                        [/missile_frame]

                        {SOUND:HIT_AND_MISS bow-puny.ogg bow-puny-miss.ogg -225}
                    [/attack_anim]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Marksman Bow"
            message="A bow that fires bolts with high accuracy."
            market=2
            [object]
                name="Marksman Bow"
                image=items/bow-elven.png
                description=_"A bow that fires bolts with high accuracy."
                take_only_once=no
                [effect]
                    apply_to=new_attack
                    name=marksman_bow
                    description=_"marksman bow"
                    type=pierce
                    range=ranged
                    damage=9
                    number=3
                    [specials]
                        {WEAPON_SPECIAL_MARKSMAN}
                    [/specials]
                    icon="attacks/bow-elven.png"
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=marksman_bow
                        [/filter_attack]
                        start_time=-250
                        missile_start_time=-150

                        [missile_frame]
                            duration=150
                            image="projectiles/missile-n.png"
                            image_diagonal="projectiles/missile-ne.png"
                        [/missile_frame]

                        {SOUND:HIT_AND_MISS bow-puny.ogg bow-puny-miss.ogg -225}
                    [/attack_anim]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Fire Bow"
            message="A bow that fires bolts of fire energy."
            market=2
            [object]
                name="Fire Bow"
                image=items/bow-crystal.png
                description=_"A bow that fires bolts of fire energy."
                take_only_once=no
                [effect]
                    apply_to=new_attack
                    name=fire_bow
                    description=_"fire bow"
                    type=fire
                    range=ranged
                    damage=9
                    number=3
                    [specials]
                        {WEAPON_SPECIAL_MAGICAL}
                    [/specials]
                    icon="attacks/bow-elven-magic.png"
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=fire_bow
                        [/filter_attack]
                        start_time=-250
                        missile_start_time=-150

                        [missile_frame]
                            duration=150
                            image="projectiles/missile-n.png"
                            image_diagonal="projectiles/missile-ne.png"
                        [/missile_frame]

                        {SOUND:HIT_AND_MISS bow-puny.ogg bow-puny-miss.ogg -225}
                    [/attack_anim]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Cold Bow"
            message="A bow that fires bolts of cold energy."
            market=2
            [object]
                name="Cold Bow"
                image=items/bow-crystal.png
                description=_"A bow that fires bolts of cold energy."
                take_only_once=no
                [effect]
                    apply_to=new_attack
                    name=cold_bow
                    description=_"cold bow"
                    type=cold
                    range=ranged
                    damage=9
                    number=3
                    [specials]
                        {WEAPON_SPECIAL_MAGICAL}
                    [/specials]
                    icon="attacks/bow-elven-magic.png"
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=cold_bow
                        [/filter_attack]
                        start_time=-250
                        missile_start_time=-150

                        [missile_frame]
                            duration=150
                            image="projectiles/missile-n.png"
                            image_diagonal="projectiles/missile-ne.png"
                        [/missile_frame]

                        {SOUND:HIT_AND_MISS bow-puny.ogg bow-puny-miss.ogg -225}
                    [/attack_anim]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Arcane Sword"
            message="A blade with magical energy."
            market=2
            [object]
                name="Arcane Sword"
                image=items/sword.png
                description=_"A blade with magical energy."
                take_only_once=no
                [effect]
                    apply_to=new_attack
                    name=arcane_sword
                    description=_"arcane sword"
                    type=arcane
                    range=melee
                    damage=10
                    number=4
                    [specials]
                        {WEAPON_SPECIAL_MAGICAL}
                    [/specials]
                    icon="attacks/sword-holy.png"
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=arcane_sword
                        [/filter_attack]
                        start_time=-200
                        offset=0~0.6:200,0.6~0:200
                        {SOUND:HIT_AND_MISS {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS} -100}
                    [/attack_anim]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Holy Water"
            message="Sprinkling this water on melee blade weapons grants them the <i>arcane</i> damage type."
            market=2
            [exclude_filter]
                [not]
                    [has_attack]
                        range=melee
                        type=blade
                    [/has_attack]
                [/not]
                [or]
                    [has_attack]
                        type=arcane
                    [/has_attack]
                [/or]
            [/exclude_filter]
            [object]
                name="Holy Water"
                image=items/holy-water.png
                description=_"Sprinkling this water on melee blade weapons grants them the <i>arcane</i> damage type."
                take_only_once=no
                [effect]
                    apply_to=attack
                    range=melee
                    type=blade
                    set_type=arcane
                [/effect]
            [/object]
            [event]
                name=haaaa
                [sound]
                    name={SOUND_LIST:HOLY}
                [/sound]
            [/event]
        [/literal]
        [literal]
            name="Sceptre of Fire"
            message="This sceptre grants a new ranged fire attack."
            market=1
            [object]
                name="Sceptre of Fire"
                image=items/sceptre-of-fire.png
                description=_"Grants a ranged fire attack"
                take_only_once=no
                {SCEPTRE_OF_FIRE_EFFECT}
            [/object]
        [/literal]
        [literal]
            name="Orb of Steadfast"
            message="This orb doubles the resistance, up to a maximum of 50%, when defending."
            market=2
            [exclude_filter]
                ability=steadfast
            [/exclude_filter]
            [object]
                name="Orb of Steadfast"
                image=items/ball-magenta.png
                description=_"This orb doubles the resistance, up to a maximum of 50%, when defending."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_STEADFAST}
                    [/abilities]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Orb of Teleport"
            message="This orb teleports the carrier between any two empty villages."
            market=2
            [exclude_filter]
                ability=teleport
            [/exclude_filter]
            [object]
                name="Orb of Teleport"
                image=items/ball-magenta.png
                description=_"This orb teleports the carrier between any two empty villages."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_TELEPORT}
                    [/abilities]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="The Prince"
            message="This modifier grants the backstab special to melee blade attacks."
            market=2
            [exclude_filter]
                [not]
                    [has_attack]
                        range=melee
                        type=blade
                    [/has_attack]
                [/not]
                [or]
                    [has_attack]
                        special=backstab
                    [/has_attack]
                [/or]
            [/exclude_filter]
            [object]
                name="The Prince"
                image=items/book4.png
                description=_"This modifier grants the backstab special to melee blade attacks."
                take_only_once=no
                [effect]
                    apply_to=attack
                    range=melee
                    type=blade
                    [set_specials]
                        mode=append
                        {WEAPON_SPECIAL_BACKSTAB}
                    [/set_specials]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Ogre Perfume"
            message="This scent will attract Ogres."
            market=2
            exclude_object=Potion of Animal Nature
            [object]
                name="Ogre Perfume"
                image=icons/potion_green_medium.png
                description=_"This scent will attract Ogres."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=stench
                            name=_"ogre stench"
                            female_name=_"female^ogre stench"
                            description=_"This unit smells bad."
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=status
                    add=feral
                [/effect]
            [/object]
            [event]
                name=need_shower
                {UNIT_SAYS _"Yuck! This smells like ogre undergarments."}
            [/event]
        [/literal]
        [literal]
            name="Sheep Clothing"
            message="These skins will attract Wolves."
            market=2
            [object]
                name="Sheep Clothing"
                image=icons/potion_green_medium.png
                description=_"These skins will attract Wolves."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=sheepish
                            name=_"sheepish"
                            female_name=_"female^sheepish"
                            description=_"This unit looks like a sheep."
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=status
                    add=sheepish
                [/effect]
            [/object]
            [event]
                name=hunter
                {UNIT_SAYS _"Look at me wolfie! Prancing and grazing."}
            [/event]
        [/literal]
        [literal]
            name="Pinetree Medallion"
            message="This medallion will attract Woses."
            market=2
            [object]
                name="Pinetree Medallion"
                image=icons/potion_green_medium.png
                description=_"This medallion will attract Woses."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=pinetree
                            name=_"pinetree"
                            female_name=_"female^pinetree"
                            description=_"This unit smells like pinetrees."
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=status
                    add=pinetree
                [/effect]
            [/object]
            [event]
                name=cart_freshner
                {UNIT_SAYS _"I love brand new cart smell."}
            [/event]
        [/literal]
        [literal]
            name="Truffle"
            message="This truffle will attract Tuskers."
            market=2
            [object]
                name="Truffle"
                image=icons/potion_green_medium.png
                description=_"This truffle will attract Tuskers."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=piggie
                            name=_"piggie"
                            female_name=_"female^piggie"
                            description=_"This unit carries truffles."
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=status
                    add=piggie
                [/effect]
            [/object]
            [event]
                name=pig_feed
                {UNIT_SAYS _"Here piggie, piggie."}
            [/event]
        [/literal]
        [literal]
            name="Wose Sense"
            message="This item will uncover hiding woses."
            market=2
            [object]
                name="Wose Sense"
                image=icons/potion_green_medium.png
                description=_"This item will uncover hiding woses."
                take_only_once=no
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=wose_sense
                            name=_"wose sense"
                            female_name=_"female^wose sense"
                            description=_"This unit uncovers woses."
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=status
                    add=wose_sense
                [/effect]
            [/object]
            [event]
                name=woses_cannot_hide
                {UNIT_SAYS _"Woses can't hide from me!"}
                {FIRE_EVENT uncover_woses}
            [/event]
        [/literal]
        [literal]
            name="True Strike"
            message="This weapon modifier will make offensive damage depend on the defenses of the enemy."
            market=3
            [object]
                name="True Strike"
                image=icons/ring_gold.png
                description=_"This ring will make the wearer offensive strike hard and true."
                take_only_once=no
                [effect]
                    apply_to=attack
                    remove_specials=magical,marksman,magnetic,magnetic_cursed
                [/effect]
                [effect]
                    apply_to=remove_ability
                    [abilities]
                        [dummy]
                            id=magnetic
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=truestrike
                            name=_"true strike"
                            female_name=_"female^true strike"
                            description=_"This unit's strikes are true."
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=attack
                    [set_specials]
                        mode=append
                        [chance_to_hit]
                            id=magnetic
                            value=100
                            apply_to=self
                            cumulative=no
                        [/chance_to_hit]
                        [damage]
                            id=truestrike
                            name= _ "true strike"
                            description= _ "Strike hard and true."
                            multiply="( 1 - ( 0.01 * defense_on( defender, defender.loc )))"
                            apply_to=attacker
                            active_on=offense
                            cumulative=yes
                        [/damage]
                    [/set_specials]
                [/effect]
            [/object]
        [/literal]
        [literal]
            name="Gold"
            message="Return on investment."
            market=3
            take_once=no
            #[object]
            #    name="Gold"
            #    image=icons/coins_copper.png
            #    description=_"Some gold."
            #    take_only_once=no
            #    duration=turn
            #[/object]
            [event]
                name=free_gold
                {UNIT_SAYS _"We made a profit!"}
                [sound]
                    name=gold.ogg
                [/sound]
                [gold]
                    side=$|unit.side
                    amount=100
                [/gold]
            [/event]
        [/literal]
        [literal]
            name="Potion of Experience"
            message="This potion gives the drinker +20 XP."
            market=4
            take_once=no
            #[object]
            #    name="XP"
            #    image=icons/potion_green_medium.png
            #    description=_"Some XP."
            #    take_only_once=no
            #    duration=turn
            #[/object]
            [event]
                name=free_xp
                {UNIT_SAYS _"Bottoms up!"}
                [sound]
                    name=potion.ogg
                [/sound]
                [floating_text]
                    x,y=$|unit.x,$|unit.y
                    text=_"+20 XP"
                [/floating_text]
                [delay]
                    time=400
                [/delay]
                [modify_unit]
                    [filter]
                        id = $|unit.id
                    [/filter]
                    [effect]
                        apply_to=experience
                        increase=20
                    [/effect]
                [/modify_unit]
            [/event]
        [/literal]
    [/set_variables]
#enddef

#define WF_MARKET_ITEMS_INDEX
    [for]
        array=wf_market_items
        [do]
            {VARIABLE wf_market_items[$i].index $i}
        [/do]
    [/for]
#enddef

#define WF_MARKET_ITEMS_APPEND VAR INDEX
    [set_variables]
        name={VAR}
        mode=append
        to_variable=wf_market_items[{INDEX}]
    [/set_variables]
#enddef

#define WF_MARKET_ITEMS_APPEND_MARKET VAR MARKET
    [for]
        array=wf_market_items
        [do]
            [if]
                {VARIABLE_CONDITIONAL wf_market_items[$i].market numerical_equals {MARKET}}
                [then]
                    {VARIABLE wf_market_items[$i].index $i}
                    {WF_MARKET_ITEMS_APPEND {VAR} $i}
                [/then]
            [/if]
        [/do]
    [/for]
#enddef

#define WF_MARKET_ITEMS_RANDOM_INDEX VAR INDEX LABEL
    {RANDOM_VAR rnd_mi 0.."$(${VAR}.length-1)"}
    {VARIABLE {INDEX} ${VAR}[$rnd_mi].index}
    {VARIABLE {LABEL} ${VAR}[$rnd_mi].name}
    {CLEAR_VARIABLE {VAR}[$rnd_mi]}
    {CLEAR_VARIABLE rnd_mi}
#enddef
