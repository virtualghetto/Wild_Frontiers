#textdomain wesnoth-Wild_Frontiers
# This file sets all of the right-click menus. Utility macros used in
# creating these menus are at the end of the file. Some additional utility
# macros used here are defined in workers.cfg.

# ----- Project menu items -----------------------------------------------
#define SET_BUILD_MENUS
    # This macro is called from the macro WORKERS_CAN_WORK
    # are allowed to build structures. It adds the right-click menu item and
    # options menus.
    # ----- Structures -----
    [set_menu_item]
        id=build_menu
        description=_ "Get to work..."
        image="build_icon.png"
        [show_if]
            # Project status
            [have_unit]
                x,y=$x1,$y1
                side=1
                {FILTER_FOR_WORKER}
            [/have_unit]
            [or]
                # Peasant Workers
                {HAVE_IDLE_WORKERS $x1 $y1}
            [/or]
            [or]
                # Mages
                {HAVE_IDLE_CASTERS $x1 $y1}
            [/or]
            [or]
                # Mages
                {HAVE_IDLE_DESTROYERS $x1 $y1}
            [/or]
            [or]
                # Mages
                {HAVE_IDLE_RAISERS $x1 $y1}
            [/or]
            [or]
                # Lighthouse
                [have_unit]
                    type=WF_Lighthouse,WF_Lighthouse_Off
                    side=1
                    x,y=$x1,$y1
                [/have_unit]
            [/or]
            [or]
                # Allies side 9
                [have_unit]
                    side=9
                    x,y=$x1,$y1
                [/have_unit]
            [/or]
            [or]
                # Hero, canrecruit
                [have_unit]
                    #id=Hero
                    canrecruit=yes
                    side=1
                    x,y=$x1,$y1
                [/have_unit]
                [have_location]
                    x,y=$x1,$y1
                    terrain=*^Yu*
                [/have_location]
            [/or]
            [or]
                # Hero on main keep
                [have_unit]
                    id=Hero
                    canrecruit=yes
                    side=1
                    x,y=$x1,$y1
                [/have_unit]
                [have_location]
                    x,y=$x1,$y1
                    #terrain=K*^*
                    terrain=K*^Yk
                [/have_location]
            [/or]
        [/show_if]
        [command]
            {STORE_GOLD}
            {VARIABLE village_count 0}
            [store_villages]
                variable=owned_villages
                owner_side=1
            [/store_villages]
            {VARIABLE_OP village_count add $owned_villages.length}
            {CLEAR_VARIABLE owned_villages}
            {VILLAGE_PROJECT_COUNT village_count}
            # Project status start {
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    side=1
                    {FILTER_FOR_WORKER}
                [/have_unit]
                [then]
                    [for]
                        array=projects.proj_list
                        reverse=yes
                        [do]
                            [if]
                                [and]
                                    {VARIABLE_CONDITIONAL projects.proj_list[$i].x numerical_equals $x1}
                                    {VARIABLE_CONDITIONAL projects.proj_list[$i].y numerical_equals $y1}
                                [/and]
                                [then]	# this *should* only happen once
                                    {VARIABLE i_this $i}
                                [/then]
                            [/if]
                        [/do]
                    [/for]
                    [message]
                        speaker=unit
                        message=_"We've got $projects.proj_list[$i_this].turns work shifts left until this $projects.proj_list[$i_this].do $projects.proj_list[$i_this].goal project is complete, milord."
                        [option]
                            label=_"Okay."
                            [command][/command]
                        [/option]
                        [option]
                            label=_"Stop working on this project."
                            [command]
                                # This is not the most efficient way to do this, but
                                # it makes the macros simpler
                                {STOP_PROJECT $x1 $y1}
                                {UNIT_SAYS _"'ave it your way, milord. We should be able ta recover most of the materials."}
                                {UNIT_SAYS _"Time ta pack it up, boys!."}
                            [/command]
                        [/option]
                    [/message]
                    {CLEAR_VARIABLE i_this}
                [/then]
            [/if]
            # Project status end }
            [if]
                {HAVE_IDLE_WORKERS $x1 $y1}
                #{HAVE_WORKERS_AND_LOCATION {BUILDABLE_TERRAIN} $x1 $y1}
                [then]
                    [message]
                        speaker=unit
                        message=_"What structure would yer like ter build, milord?"
                        [option]
                            label=_"Paved road - {PAVED_COST} gold, {PAVED_TURNS} work shifts"
                            image = "terrain/flat/road.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain={BUILDABLE_TERRAIN}
                                [/have_location]
                                [not]
                                    [have_location]
                                        terrain=Rr
                                        x,y=$x1,$y1
                                    [/have_location]
                                [/not]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "road" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Stone castle - {CASTLE_COST} gold, {CASTLE_TURNS} work shifts"
                            image = "terrain/castle/castle-tile.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=Ce,Cea
                                [/have_location]
                                {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 1}
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "castle" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Wooden keep - {CASTLE_COST} gold, {CASTLE_TURNS} work shifts"
                            image = "terrain/castle/encampment/tall-keep-tile.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=Ce,Cea
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "wooden keep" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Stone keep - {KEEP_COST} gold, {KEEP_TURNS} work shifts"
                            image = "terrain/castle/keep-tile.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=Ke^Yk,Kea^Yk
                                [/have_location]
                                {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 1}
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "stone keep" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Wooden encampment - {FORT_COST} gold, {FORT_TURNS} work shifts"
                            image = "terrain/castle/encampment/regular-tile.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain={BUILDABLE_TERRAIN}
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "fort" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Farm (village) - {FARM_COST} gold, {FARM_TURNS} work shifts"
                            image = "terrain/village/human-tile.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain={BUILDABLE_TERRAIN}
                                [/have_location]
                                {VARIABLE_CONDITIONAL wf_vars.village_limit greater_than $village_count}
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "farm" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Farm yield - {YIELD_COST} gold, {YIELD_TURNS} work shifts"
                            image = "terrain/grass/green.png~BLIT(items/straw-bale1.png)~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=*^Gvs
                                    [filter_adjacent_location]
                                        terrain=*^Vh,*^Vha
                                    [/filter_adjacent_location]
                                    [filter_adjacent_location]
                                        terrain=*^Ygy,*^Ygb
                                        count=0
                                    [/filter_adjacent_location]
                                [/have_location]
                                {VARIABLE_CONDITIONAL wf_vars.village_limit greater_than $village_count}
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "yield" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Mushroom farm - {MUSHROOM_COST} gold, {MUSHROOM_TURNS} work shifts"
                            image = "terrain/grass/green.png~BLIT(terrain/forest/mushrooms-tile.png)~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=*^Gvs
                                    [filter_adjacent_location]
                                        terrain=*^Vh,*^Vha
                                    [/filter_adjacent_location]
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "mushroom farm" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Mushroom grove - {PAVED_COST} gold, {PAVED_TURNS} work shifts"
                            image = "terrain/grass/green.png~BLIT(terrain/embellishments/mushroom3.png)~SCALE(36,36)"
                            [show_if]
                                {VARIABLE_CONDITIONAL wf_vars.fungi_book greater_than 0}
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain={BUILDABLE_TERRAIN}
                                [/have_location]
                                [not]
                                    [have_location]
                                        terrain=*^Em
                                        x,y=$x1,$y1
                                    [/have_location]
                                [/not]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "mushroom grove" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Plant trees - {FOREST_COST} gold, {FOREST_TURNS} work shifts"
                            image = "terrain/grass/green.png~BLIT(terrain/forest/mixed-summer-tile.png)~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain={BUILDABLE_TERRAIN}
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "plant trees" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Cut down trees - {FOREST_COST} gold, {FOREST_TURNS} work shifts"
                            image = "terrain/grass/green.png~BLIT(terrain/forest/deciduous-summer-tile.png)~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=*^F*
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "cut forest" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Earth mound - {HILL_COST} gold, {HILL_TURNS} work shifts"
                            image = "terrain/hills/dry.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain={BUILDABLE_TERRAIN}
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "mound" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Flatten hills - {HILL_COST} gold, {HILL_TURNS} work shifts"
                            image = "terrain/hills/regular.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=!,*^F*,!,H*,H*^E*
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "flatten hills" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Plant hill trees - {FOREST_COST} gold, {FOREST_TURNS} work shifts"
                            image = "terrain/hills/regular.png~BLIT(terrain/forest/mixed-summer-tile.png)~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=!,*^F*,!,H*,H*^E*
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "plant hill trees" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Hill village - {VILLAGE_COST} gold, {VILLAGE_TURNS} work shifts"
                            image = "terrain/village/human-hills-tile.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=!,*^F*,!,H*,H*^E*
                                [/have_location]
                                {VARIABLE_CONDITIONAL wf_vars.village_limit greater_than $village_count}
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "hill village" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Drain swamp - {SWAMP_COST} gold, {SWAMP_TURNS} work shifts"
                            image = "terrain/swamp/water-tile.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=S*,S*^E*
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "drain swamp" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Mud moat - {SWAMP_COST} gold, {SWAMP_TURNS} work shifts"
                            image = "terrain/swamp/mud-tile.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=W*,W*^E*
                                    [filter_adjacent_location]
                                        terrain=!,W*,W*^E*,W*^Bw|,W*^Bw/,W*^Bw\
                                        count=1-6
                                    [/filter_adjacent_location]
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "mud moat" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Divert stream - {STREAM_COST} gold, {STREAM_TURNS} work shifts"
                            image = "terrain/water/coast-tile.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain={BUILDABLE_TERRAIN}	# anything already flat and unforested
                                    [filter_adjacent_location]
                                        # must be a stream to divert!
                                        terrain=W*,W*^E*,W*^Bw|,W*^Bw/,W*^Bw\,*^Yws,Yww,W*^Vm
                                    [/filter_adjacent_location]
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "divert stream" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Build bridge - {BRIDGE_COST} gold, {BRIDGE_TURNS} work shifts"
                            image = "terrain/water/coast-tile.png~BLIT(terrain/bridge/wood-ne-sw.png)~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=W*,W*^E*,S*,S*^E*	# any water
                                    #[filter_adjacent_location]
                                    # need land (or another bridge) to anchor the
                                    # bridge to (i.e. not in the middle of a lake)
                                    #terrain=!,*^V*,*^Y*,!,*^F*,*^Gvs,G*,G*^E*,R*,R*^E*,C*,K*^Yk,H*,H*^E*,M*,M*^E*,*^Bw*
                                    #[/filter_adjacent_location]
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "bridge" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Water village - {VILLAGE_COST} gold, {VILLAGE_TURNS} work shifts"
                            image = "terrain/village/coast-tile.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=W*,W*^E*
                                [/have_location]
                                {VARIABLE_CONDITIONAL wf_vars.village_limit greater_than $village_count}
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "water village" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Swamp village - {VILLAGE_COST} gold, {VILLAGE_TURNS} work shifts"
                            image = "terrain/village/swampwater-tile.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=S*,S*^E*
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "swamp village" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Tavern - {TAVERN_COST} gold, {TAVERN_TURNS} work shifts"
                            image = "terrain/village/log-cabin-tile.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain={BUILDABLE_TERRAIN}
                                [/have_location]
                                [not]
                                    [have_location]
                                        terrain=*^Yt
                                        #count=1-99999
                                    [/have_location]
                                [/not]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "tavern" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            #label=_"Windmill (allows trade) - {WINDMILL_COST} gold, {WINDMILL_TURNS} work shifts"
                            label=_"Windmill - {WINDMILL_COST} gold, {WINDMILL_TURNS} work shifts"
                            image = "terrain/misc/windmill-tile.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain={BUILDABLE_TERRAIN}
                                [/have_location]
                                [have_location]
                                    terrain=*^Wm
                                    count=0
                                    #count=1-99999
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "windmill" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        # Start Lighthouse, Traps or Tunnels {
                        [option]
                            label=_"Lighthouse, traps and tunnels ..."
                            image = "terrain/grass/green.png~BLIT(scenery/lighthouse.png)~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain={BUILDABLE_TERRAIN}
                                [/have_location]
                                #[and]
                                #    [not]
                                #        [have_location]
                                #            find_in=traps.slow
                                #            [or]
                                #                find_in=traps.spikes
                                #            [/or]
                                #            x,y=$x1,$y1
                                #        [/have_location]
                                #    [/not]
                                #[/and]
                            [/show_if]
                            [command]
                                # Start Lighthouse, Trap or Tunnels Build {
                                [message]
                                    speaker=unit
                                    message=_"What will it be, milord?"

                                    # ---- Spike trap ----
                                    [option]
                                        label=_"Spike trap - {PAVED_COST} gold, {PAVED_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(items/burial.png)~SCALE(36,36)"
                                        #[show_if]
                                        #    [have_location]
                                        #        x,y=$x1,$y1
                                        #        terrain={BUILDABLE_TERRAIN}
                                        #    [/have_location]
                                        #[/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "spike trap" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]
                                    # ---- Slow trap ----
                                    [option]
                                        label=_"Slow trap - {PAVED_COST} gold, {PAVED_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(projectiles/web.png)~SCALE(36,36)"
                                        #[show_if]
                                        #    [have_location]
                                        #        x,y=$x1,$y1
                                        #        terrain={BUILDABLE_TERRAIN}
                                        #    [/have_location]
                                        #[/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "slow trap" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]

                                    # ---- Lighthouse ----
                                    [option]
                                        #label=_"Lighthouse (clears fog, summons allied help) - {LIGHTHOUSE_COST} gold, {LIGHTHOUSE_TURNS} work shifts"
                                        label=_"Lighthouse - {LIGHTHOUSE_COST} gold, {LIGHTHOUSE_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(scenery/lighthouse.png)~SCALE(36,36)"
                                        #[show_if]
                                        #    [have_location]
                                        #        x,y=$x1,$y1
                                        #        terrain={BUILDABLE_TERRAIN}
                                        #    [/have_location]
                                        #[/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "lighthouse" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]

                                    # ---- Entrance tunnel ----
                                    [option]
                                        label=_"Tunnel entrance - {TUNNEL_COST} gold, {TUNNEL_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(scenery/trapdoor-open.png)~SCALE(36,36)"
                                        [show_if]
                                            #    [have_location]
                                            #        x,y=$x1,$y1
                                            #        terrain={BUILDABLE_TERRAIN}
                                            #    [/have_location]
                                            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 1}
                                            {VARIABLE_CONDITIONAL wf_vars.bidirectional_tunnel boolean_not_equals yes}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "tunnel entrance" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]
                                    # ---- Exit tunnel ----
                                    [option]
                                        label=_"Tunnel exit - {TUNNEL_COST} gold, {TUNNEL_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(scenery/trapdoor-closed.png)~SCALE(36,36)"
                                        [show_if]
                                            #    [have_location]
                                            #        x,y=$x1,$y1
                                            #        terrain={BUILDABLE_TERRAIN}
                                            #    [/have_location]
                                            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 1}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "tunnel exit" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]

                                    # ---- Well ----
                                    [option]
                                        label=_"Well - {WELL_COST} gold, {WELL_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(scenery/well.png)~SCALE(36,36)"
                                        [show_if]
                                            #[have_location]
                                            #    x,y=$x1,$y1
                                            #    terrain={BUILDABLE_TERRAIN}
                                            #[/have_location]
                                            [have_location]
                                                terrain=*^Yws
                                                count=3-99999
                                            [/have_location]
                                            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 3}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "well" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]

                                    # ---- Nevermind ----
                                    [option]
                                        label=_"Nevermind"
                                        image = "terrain/void/void.png~SCALE(36,36)"
                                        [command] [/command]
                                    [/option]
                                [/message]
                                # End   Lighthouse, Trap or Tunnels Build }
                            [/command]
                        [/option]
                        # End Lighthouse, Traps or Tunnels }
                        # Start Remove Traps {
                        [option]
                            label=_"Remove slow trap"
                            image = "terrain/grass/green.png~BLIT(projectiles/web.png)~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=Ywt
                                    find_in=traps.slow
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "slow trap" do,x,y="burn",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Remove spike trap"
                            image = "terrain/grass/green.png~BLIT(items/burial.png)~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=Ywt
                                    find_in=traps.spike
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "spike trap" do,x,y="burn",$x1,$y1}
                            [/command]
                        [/option]
                        # End Remove Traps }
                        [option]
                            label=_"Recruiting buildings ..."
                            image = "terrain/flat/dirt-dark.png~BLIT(units/human-loyalists/heavyinfantry.png)~SCALE(36,36)"
                            # Start Show if Recruiting Buildings {
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain={BUILDABLE_TERRAIN}
                                [/have_location]
                                [and]
                                    [not]
                                        [have_location]
                                            terrain=*^Yb
                                            #count=1-99999
                                        [/have_location]
                                    [/not]
                                    [or]
                                        [not]
                                            [have_location]
                                                terrain=*^Ya
                                                count=2-99999
                                            [/have_location]
                                        [/not]
                                    [/or]
                                    [or]
                                        [not]
                                            [have_location]
                                                terrain=*^Yf
                                                count=2-99999
                                            [/have_location]
                                        [/not]
                                    [/or]
                                    [or]
                                        [not]
                                            [have_location]
                                                terrain=*^Ys
                                                count=2-99999
                                            [/have_location]
                                        [/not]
                                    [/or]
                                    [or]
                                        [not]
                                            [have_location]
                                                terrain=*^Yu
                                                count=3-99999
                                            [/have_location]
                                        [/not]
                                    [/or]
                                    [or]
                                        [not]
                                            [have_location]
                                                terrain=*^Yws
                                                count=3-99999
                                            [/have_location]
                                        [/not]
                                    [/or]
                                [/and]
                            [/show_if]
                            # End   Show if Recruiting Buildings }
                            [command]
                                # Start Recruiting Buildings {
                                [message]
                                    speaker=unit
                                    message=_"What building would yer like ter build, milord?"

                                    # ---- Armorer ----

                                    # Armorer 1
                                    [option]
                                        label=_"Armorer - {ARMORER_COST} gold, {ARMORER_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(units/human-loyalists/heavyinfantry.png)~SCALE(36,36)"
                                        [show_if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                terrain={BUILDABLE_TERRAIN}
                                            [/have_location]
                                            [have_location]
                                                terrain=*^Ya
                                                count=0
                                            [/have_location]
                                            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 2}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "armorer" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]
                                    # Armorer 2
                                    [option]
                                        label=_"Armorer - {ARMORER_COST} gold, {ARMORER_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(units/human-loyalists/sergeant.png)~SCALE(36,36)"
                                        [show_if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                terrain={BUILDABLE_TERRAIN}
                                            [/have_location]
                                            [have_location]
                                                terrain=*^Ya
                                                count=1
                                            [/have_location]
                                            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 3}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "armorer" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]

                                    # ---- Blacksmith ----

                                    # Blacksmith 1
                                    [option]
                                        label=_"Blacksmith - {FORGE_COST} gold, {FORGE_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(units/human-loyalists/spearman.png)~SCALE(36,36)"
                                        [show_if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                terrain={BUILDABLE_TERRAIN}
                                            [/have_location]
                                            [have_location]
                                                terrain=*^Yf
                                                count=0
                                            [/have_location]
                                            #{VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 0}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "blacksmith" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]
                                    # Blacksmith 2
                                    [option]
                                        label=_"Blacksmith - {FORGE_COST} gold, {FORGE_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(units/human-loyalists/fencer.png)~SCALE(36,36)"
                                        [show_if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                terrain={BUILDABLE_TERRAIN}
                                            [/have_location]
                                            [have_location]
                                                terrain=*^Yf
                                                count=1
                                            [/have_location]
                                            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 1}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "blacksmith" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]

                                    # ---- Bowyer ----

                                    # Bowyer 1
                                    [option]
                                        label=_"Bowyer - {BOWYER_COST} gold, {BOWYER_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(units/human-loyalists/bowman.png)~SCALE(36,36)"
                                        [show_if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                terrain={BUILDABLE_TERRAIN}
                                            [/have_location]
                                            [have_location]
                                                terrain=*^Yb
                                                count=0
                                            [/have_location]
                                            #{VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 0}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "bowyer" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]

                                    # ---- Library ----

                                    # Library 1
                                    [option]
                                        label=_"Library - {LIBRARY_COST} gold, {LIBRARY_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(units/human-magi/mage.png)~SCALE(36,36)"
                                        [show_if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                terrain={BUILDABLE_TERRAIN}
                                            [/have_location]
                                            [have_location]
                                                terrain=*^Yu
                                                count=0
                                            [/have_location]
                                            #{VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 0}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "library" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]
                                    # Library 2
                                    [option]
                                        label=_"Library - {LIBRARY_COST} gold, {LIBRARY_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(units/human-outlaws/rogue-mage.png)~SCALE(36,36)"
                                        [show_if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                terrain={BUILDABLE_TERRAIN}
                                            [/have_location]
                                            [have_location]
                                                terrain=*^Yu
                                                count=1
                                            [/have_location]
                                            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 2}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "library" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]
                                    # Library 3
                                    [option]
                                        label=_"Library - {LIBRARY_COST} gold, {LIBRARY_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(units/undead-necromancers/adept.png)~SCALE(36,36)"
                                        [show_if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                terrain={BUILDABLE_TERRAIN}
                                            [/have_location]
                                            [have_location]
                                                terrain=*^Yu
                                                count=2
                                            [/have_location]
                                            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 3}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "library" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]

                                    # ---- Stables ----

                                    # Stables 1
                                    [option]
                                        label=_"Stables - {STABLE_COST} gold, {STABLE_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(units/human-loyalists/cavalryman/cavalryman.png)~SCALE(36,36)"
                                        [show_if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                terrain={BUILDABLE_TERRAIN}
                                            [/have_location]
                                            [have_location]
                                                terrain=*^Ys
                                                count=0
                                            [/have_location]
                                            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 1}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "stables" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]
                                    # Stables 2
                                    [option]
                                        label=_"Stables - {STABLE_COST} gold, {STABLE_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(units/human-loyalists/horseman/horseman.png)~SCALE(36,36)"
                                        [show_if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                terrain={BUILDABLE_TERRAIN}
                                            [/have_location]
                                            [have_location]
                                                terrain=*^Ys
                                                count=1
                                            [/have_location]
                                            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 2}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "stables" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]

                                    # ---- Well ----

                                    # Well 1
                                    [option]
                                        label=_"Well - {WELL_COST} gold, {WELL_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(units/merfolk/fighter.png)~SCALE(36,36)"
                                        [show_if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                terrain={BUILDABLE_TERRAIN}
                                            [/have_location]
                                            [have_location]
                                                terrain=*^Yws
                                                count=0
                                            [/have_location]
                                            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 1}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "well" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]

                                    # Well 2
                                    [option]
                                        label=_"Well - {WELL_COST} gold, {WELL_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(units/merfolk/hunter.png)~SCALE(36,36)"
                                        [show_if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                terrain={BUILDABLE_TERRAIN}
                                            [/have_location]
                                            [have_location]
                                                terrain=*^Yws
                                                count=1
                                            [/have_location]
                                            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 2}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "well" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]

                                    # Well 3
                                    [option]
                                        label=_"Well - {WELL_COST} gold, {WELL_TURNS} work shifts"
                                        image = "terrain/grass/green.png~BLIT(units/merfolk/initiate.png)~SCALE(36,36)"
                                        [show_if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                terrain={BUILDABLE_TERRAIN}
                                            [/have_location]
                                            [have_location]
                                                terrain=*^Yws
                                                count=2
                                            [/have_location]
                                            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 3}
                                        [/show_if]
                                        [command]
                                            {WF_CALL_FUNCTION "well" do,x,y="start",$x1,$y1}
                                        [/command]
                                    [/option]

                                    # ---- Nevermind ----
                                    [option]
                                        label=_"Nevermind"
                                        image = "terrain/void/void.png~SCALE(36,36)"
                                        [command]
                                            [if]
                                                {VARIABLE_CONDITIONAL wf_vars.expand_rank less_than 4}
                                                [then]
                                                    [message]
                                                        speaker=unit
                                                        message=_"Milord, you need to expand the city capacity to allow for more building projects."
                                                    [/message]
                                                    {TUTORIAL increase_rank _"To increase the city rank, move Lord $wf_vars.hero_name| to the keep, right-click on him, and select 'Get to work...'."}
                                                [/then]
                                            [/if]
                                        [/command]
                                    [/option]
                                [/message]
                                # End   Recruiting Buildings }
                            [/command]
                        [/option]
                        [option]
                            label=_"Plow snow"
                            image = "terrain/flat/dirt-dark.png~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    x,y=$x1,$y1
                                    terrain=Aa,Aa^E*
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "plow snow" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Nevermind"
                            #image = "terrain/void/void.png~SCALE(36,36)"
                            [command] [/command]
                        [/option]
                    [/message]
                [/then]
            [/if]
            [if]
                {HAVE_IDLE_CASTERS $x1 $y1}
                [or]
                    {HAVE_IDLE_DESTROYERS $x1 $y1}
                [/or]
                [or]
                    {HAVE_IDLE_RAISERS $x1 $y1}
                [/or]
                [then]
                    [message]
                        speaker=unit
                        message=_"What would you like me to do, milord?"
                        [option]
                            label=_"Cast rune - {RUNE_COST} gold, {RUNE_TURNS} work shifts"
                            image = "terrain/void/void.png~BLIT(scenery/rune5.png)~SCALE(36,36)"
                            [show_if]
                                {HAVE_CASTER_AND_LOCATION (!,*^Ybb,!,*^V*,*^Y*,*^F*,*^Gvs,*^Bw*,*^E*,*^Wm,A*,C*,K*,G*,H*,M*,R*,S*,W*,Yw,Ywt,Ds) $x1 $y1}
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "rune" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Raise a mountain - {HILL_COST} gold, {HILL_TURNS} work shifts"
                            image = "terrain/mountains/basic-tile.png~SCALE(36,36)"
                            [show_if]
                                {HAVE_RAISER_AND_LOCATION (!,*^F*,!,H*,H*^E*) $x1 $y1}
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "mountain" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Sacrificial altar - {ALTAR_COST} gold, {ALTAR_TURNS} work shifts"
                            image = "terrain/grass/green.png~BLIT(items/altar-evil.png)~SCALE(36,36)"
                            [show_if]
                                {HAVE_DESTROYER_AND_LOCATION ({BUILDABLE_TERRAIN}) $x1 $y1}
                                [have_location]
                                    terrain=*^Yga
                                    count=0
                                [/have_location]
                            [/show_if]
                            [command]
                                {WF_CALL_FUNCTION "altar" do,x,y="start",$x1,$y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Destroy structure..."
                            image = "terrain/flat/dirt-dark.png~BLIT(terrain/misc/rubble-tile.png)~SCALE(36,36)"
                            [show_if]
                                {HAVE_DESTROYER_AND_LOCATION (*^Bw*,Rr,*^Vm,*^Vhs,*^Vhh,*^Vhha,*^Wm,*^Yf,*^Yfo,*^Yb,*^Ybo,*^Ys,*^Yso,*^Yu,*^Yuo,*^Yt,*^Yto,*^Ya,*^Yao,*^Yws,*^Yga,*^Yge,*^Ygx,*^Ygy,*^Ymb,*^Ymc,*^Ymd,Ce,Cea,Ch,Cha,Chr,Chw,Ket,Kvr,*^Vh,*^Vha,M*,M*^E*,Ywt) $x1 $y1}
                            [/show_if]
                            [command]
                                [store_locations]	# This has base and overlay in it
                                    variable=burn_location_full
                                    x,y=$x1,$y1
                                [/store_locations]
                                # This is kind of an ugly hack, but I'm not sure how to make it cleaner
                                [set_variables]
                                    name=burn_location
                                    mode=replace
                                    [split]
                                        list=$burn_location_full.terrain
                                        key=layer
                                        separator="^"
                                    [/split]
                                [/set_variables]
                                [switch]	# switch on base terrain
                                    variable=burn_location[0].layer
                                    [case]	# Wooden encampments
                                        value=Ce,Cea
                                        {CHECK_AND_DESTROY_ZERO "fort" $x1 $y1 (_"Are you sure you want to destroy this fort, milord?")}
                                    [/case]
                                    [case]	# Wooden keep
                                        value=Ket
                                        {CHECK_AND_DESTROY_ZERO "wooden keep" $x1 $y1 (_"Are you sure you want to destroy this wooden keep, milord?")}
                                    [/case]
                                    [case]	# Stone Castle
                                        value=Ch,Cha,Chr,Chw,Kvr
                                        {CHECK_AND_DESTROY "castle" $x1 $y1 (_"Are you sure you want to destroy this castle, milord?")}
                                    [/case]
                                    [case]	# Road
                                        value=Rr
                                        {CHECK_AND_DESTROY_ZERO "road" $x1 $y1 (_"Are you sure you want to destroy this road, milord?")}
                                    [/case]
                                    [case]	# Mountain
                                        value=Mm,Md,Ms
                                        {CHECK_AND_DESTROY "mountain" $x1 $y1 (_"Are you sure you want to destroy this mountain, milord?")}
                                    [/case]
                                    [case]	# Traps
                                        value=Ywt
                                        [if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                find_in=traps.slow
                                            [/have_location]
                                            [then]
                                                {CHECK_AND_DESTROY_ZERO "slow trap" $x1 $y1 (_"Are you sure you want to destroy this slow trap, milord?")}
                                            [/then]
                                        [/if]
                                        [if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                find_in=traps.spike
                                            [/have_location]
                                            [then]
                                                {CHECK_AND_DESTROY_ZERO "spike trap" $x1 $y1 (_"Are you sure you want to destroy this spike trap, milord?")}
                                            [/then]
                                        [/if]
                                    [/case]
                                [/switch]
                                [switch]	# switch on overlay terrain
                                    # I'd like to make this more building type-agnostic, but that's difficult
                                    variable=burn_location[1].layer
                                    [case]	# Armorer
                                        value=Ya,Yao
                                        {CHECK_AND_DESTROY "armorer" $x1 $y1 (_"Are you sure you want to destroy this armorer, milord?")}
                                    [/case]
                                    [case]	# Blacksmith
                                        value=Yf,Yfo
                                        {CHECK_AND_DESTROY "blacksmith" $x1 $y1 (_"Are you sure you want to destroy this forge, milord?")}
                                    [/case]
                                    [case]	# Bowyer
                                        value=Yb,Ybo
                                        {CHECK_AND_DESTROY "bowyer" $x1 $y1 (_"Are you sure you want to destroy this bowyer, milord?")}
                                    [/case]
                                    [case]	# Library
                                        value=Yu,Yuo
                                        {CHECK_AND_DESTROY "library" $x1 $y1 (_"Are you sure you want to destroy this library, milord?")}
                                    [/case]
                                    [case]	# Stables
                                        value=Ys,Yso
                                        {CHECK_AND_DESTROY "stables" $x1 $y1 (_"Are you sure you want to destroy this stable, milord?")}
                                    [/case]
                                    [case]	# Tavern
                                        value=Yt,Yto
                                        {CHECK_AND_DESTROY "tavern" $x1 $y1 (_"Are you sure you want to destroy this tavern, milord?")}
                                    [/case]
                                    [case]	# Windmill
                                        value=Wm
                                        {CHECK_AND_DESTROY "windmill" $x1 $y1 (_"Are you sure you want to destroy this windmill, milord?")}
                                    [/case]
                                    [case]	# Well
                                        value=Yws
                                        {CHECK_AND_DESTROY "well" $x1 $y1 (_"Are you sure you want to destroy this well, milord?")}
                                    [/case]
                                    [case]	# Altar
                                        value=Yga
                                        {CHECK_AND_DESTROY "altar" $x1 $y1 (_"Are you sure you want to destroy this altar, milord?")}
                                    [/case]
                                    [case]	# Entrance Tunnel
                                        value=Yge
                                        {CHECK_AND_DESTROY "tunnel entrance" $x1 $y1 (_"Are you sure you want to destroy this tunnel entrance, milord?")}
                                    [/case]
                                    [case]	# Exit Tunnel
                                        value=Ygx
                                        {CHECK_AND_DESTROY "tunnel exit" $x1 $y1 (_"Are you sure you want to destroy this tunnel exit, milord?")}
                                    [/case]
                                    [case]	# Yield
                                        value=Ygy
                                        {CHECK_AND_DESTROY_ZERO "yield" $x1 $y1 (_"Are you sure you want to destroy this farm yield, milord?")}
                                    [/case]
                                    [case]	# Mushroom farm
                                        value=Ymb,Ymc,Ymd
                                        {CHECK_AND_DESTROY_ZERO "mushroom farm" $x1 $y1 (_"Are you sure you want to destroy this mushroom farm, milord?")}
                                    [/case]
                                    [case]	# Village
                                        value=Vh,Vha
                                        {CHECK_AND_DESTROY "farm" $x1 $y1 (_"Are you sure you want to destroy this farm, milord?")}
                                    [/case]
                                    [case]	# Bridge
                                        value=Bw|,Bw/,Bw\
                                        {CHECK_AND_DESTROY_ZERO "bridge" $x1 $y1 (_"Are you sure you want to destroy this bridge, milord?")}
                                    [/case]
                                    [case]	# Water village
                                        value=Vm
                                        {CHECK_AND_DESTROY_ZERO "water village" $x1 $y1 (_"Are you sure you want to destroy this water village, milord?")}
                                    [/case]
                                    [case]	# Swamp village
                                        value=Vhs
                                        {CHECK_AND_DESTROY_ZERO "swamp village" $x1 $y1 (_"Are you sure you want to destroy this swamp village, milord?")}
                                    [/case]
                                    [case]	# Hill village
                                        value=Vhh,Vhha
                                        {CHECK_AND_DESTROY "hill village" $x1 $y1 (_"Are you sure you want to destroy this hill village, milord?")}
                                    [/case]
                                [/switch]
                                {CLEAR_VARIABLE burn_location_full}
                                {CLEAR_VARIABLE burn_location}
                            [/command]
                        [/option]
                        [option]
                            label=_"Nevermind"
                            image = "terrain/void/void.png~SCALE(36,36)"
                            [command] [/command]
                        [/option]
                    [/message]
                [/then]
            [/if]
            # Lighthouse start {
            [if]
                [have_unit]
                    type=WF_Lighthouse,WF_Lighthouse_Off
                    side=1
                    x,y=$x1,$y1
                [/have_unit]
                [then]
                    [message]
                        speaker=unit
                        message=_"What would you like me to do, milord?"
                        [option]
                            label=_"Command allies..."
                            image = "terrain/grass/green.png~BLIT(units/human-loyalists/marshal-leading.png)~SCALE(36,36)"
                            [show_if]
                                [have_unit]
                                    side=9
                                    [not]
                                        status=pilgrim
                                    [/not]
                                    [not]
                                        type=Caravan
                                    [/not]
                                [/have_unit]
                            [/show_if]
                            [command]
                                #[delay]
                                #    time=600
                                #[/delay]
                                [while]
                                    [true][/true]
                                    [do]
                                        [message]
                                            speaker=unit
                                            message=_"Command allies to ..."
                                            [option]
                                                label=_"Nevermind"
                                                image = "terrain/void/void.png~SCALE(36,36)"
                                                default=yes
                                                [command]
                                                    [break][/break]
                                                [/command]
                                            [/option]
                                            [option]
                                                label=_"Resume guardian duties"
                                                image = "terrain/grass/green.png~BLIT(units/human-loyalists/royalguard.png)~SCALE(36,36)"
                                                [show_if]
                                                    [have_unit]
                                                        side=9
                                                        [and]
                                                            ability=frozen
                                                            [or]
                                                                ability=fallback
                                                            [/or]
                                                            [or]
                                                                ability=coward
                                                            [/or]
                                                            [or]
                                                                ability=tavern
                                                            [/or]
                                                        [/and]
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                    [/have_unit]
                                                [/show_if]
                                                [command]
                                                    [store_unit]
                                                        [filter]
                                                            side=9
                                                            [and]
                                                                ability=frozen
                                                                [or]
                                                                    ability=fallback
                                                                [/or]
                                                                [or]
                                                                    ability=coward
                                                                [/or]
                                                                [or]
                                                                    ability=tavern
                                                                [/or]
                                                            [/and]
                                                            [not]
                                                                type=Caravan
                                                            [/not]
                                                            [not]
                                                                status=pilgrim
                                                            [/not]
                                                        [/filter]
                                                        variable=unit_store
                                                        mode=always_clear
                                                    [/store_unit]
                                                    [foreach]
                                                        array=unit_store
                                                        [do]
                                                            {SOBER_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {BRAVE_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {FALLIN_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {THAW_UNIT $this_item.id $this_item.x $this_item.y}
                                                        [/do]
                                                    [/foreach]
                                                    {CLEAR_VARIABLE unit_store}
                                                    [message]
                                                        side=9
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        message=_"We'll resume guardian duties, milord."
                                                    [/message]
                                                [/command]
                                            [/option]
                                            [option]
                                                label=_"Sentry their positions"
                                                image = "terrain/grass/green.png~BLIT(units/human-loyalists/siegetrooper.png)~SCALE(36,36)"
                                                [show_if]
                                                    [have_unit]
                                                        side=9
                                                        [not]
                                                            ability=frozen
                                                        [/not]
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                    [/have_unit]
                                                [/show_if]
                                                [command]
                                                    [store_unit]
                                                        [filter]
                                                            side=9
                                                            [not]
                                                                ability=frozen
                                                            [/not]
                                                            [not]
                                                                type=Caravan
                                                            [/not]
                                                            [not]
                                                                status=pilgrim
                                                            [/not]
                                                        [/filter]
                                                        variable=unit_store
                                                        mode=always_clear
                                                    [/store_unit]
                                                    [foreach]
                                                        array=unit_store
                                                        [do]
                                                            {SOBER_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {BRAVE_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {FALLIN_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {FREEZE_UNIT $this_item.id $this_item.x $this_item.y}
                                                        [/do]
                                                    [/foreach]
                                                    {CLEAR_VARIABLE unit_store}
                                                    [message]
                                                        side=9
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        message=_"We'll hold our positions, milord."
                                                    [/message]
                                                [/command]
                                            [/option]
                                            [option]
                                                label=_"Fallback"
                                                image = "terrain/grass/green.png~BLIT(units/human-loyalists/javelineer.png)~SCALE(36,36)"
                                                [show_if]
                                                    [have_unit]
                                                        side=9
                                                        [not]
                                                            ability=fallback
                                                        [/not]
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                    [/have_unit]
                                                [/show_if]
                                                [command]
                                                    [store_unit]
                                                        [filter]
                                                            side=9
                                                            [not]
                                                                ability=fallback
                                                            [/not]
                                                            [not]
                                                                type=Caravan
                                                            [/not]
                                                            [not]
                                                                status=pilgrim
                                                            [/not]
                                                        [/filter]
                                                        variable=unit_store
                                                        mode=always_clear
                                                    [/store_unit]
                                                    [foreach]
                                                        array=unit_store
                                                        [do]
                                                            {SOBER_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {BRAVE_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {THAW_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {FALLBACK_UNIT $this_item.id $this_item.x $this_item.y}
                                                        [/do]
                                                    [/foreach]
                                                    {CLEAR_VARIABLE unit_store}
                                                    [message]
                                                        side=9
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                        message=_"We'll assume defensive tactics, milord."
                                                    [/message]
                                                [/command]
                                            [/option]
                                            [option]
                                                label=_"Craven retreat"
                                                image = "terrain/grass/green.png~BLIT(units/monsters/giant-rat.png)~SCALE(36,36)"
                                                [show_if]
                                                    [have_unit]
                                                        side=9
                                                        [not]
                                                            ability=coward
                                                        [/not]
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                    [/have_unit]
                                                [/show_if]
                                                [command]
                                                    [store_unit]
                                                        [filter]
                                                            side=9
                                                            [not]
                                                                ability=coward
                                                            [/not]
                                                            [not]
                                                                type=Caravan
                                                            [/not]
                                                            [not]
                                                                status=pilgrim
                                                            [/not]
                                                        [/filter]
                                                        variable=unit_store
                                                        mode=always_clear
                                                    [/store_unit]
                                                    [foreach]
                                                        array=unit_store
                                                        [do]
                                                            {SOBER_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {FALLIN_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {THAW_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {CRAVEN_UNIT $this_item.id $this_item.x $this_item.y}
                                                        [/do]
                                                    [/foreach]
                                                    {CLEAR_VARIABLE unit_store}
                                                    [message]
                                                        side=9
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                        message=_"We'll disengage from the fight, milord."
                                                    [/message]
                                                [/command]
                                            [/option]
                                            [option]
                                                label=_"Craven retreat injured only"
                                                image = "terrain/grass/green.png~BLIT(units/monsters/giant-rat.png)~SCALE(36,36)"
                                                [show_if]
                                                    [have_unit]
                                                        side=9
                                                        [not]
                                                            ability=coward
                                                        [/not]
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                        formula="self.hitpoints < self.max_hitpoints"
                                                    [/have_unit]
                                                [/show_if]
                                                [command]
                                                    [store_unit]
                                                        [filter]
                                                            side=9
                                                            [not]
                                                                ability=coward
                                                            [/not]
                                                            [not]
                                                                type=Caravan
                                                            [/not]
                                                            [not]
                                                                status=pilgrim
                                                            [/not]
                                                            formula="self.hitpoints < self.max_hitpoints"
                                                        [/filter]
                                                        variable=unit_store
                                                        mode=always_clear
                                                    [/store_unit]
                                                    [foreach]
                                                        array=unit_store
                                                        [do]
                                                            {SOBER_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {FALLIN_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {THAW_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {CRAVEN_UNIT $this_item.id $this_item.x $this_item.y}
                                                        [/do]
                                                    [/foreach]
                                                    {CLEAR_VARIABLE unit_store}
                                                    [message]
                                                        side=9
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                        formula="self.hitpoints < self.max_hitpoints"
                                                        message=_"We'll disengage the injured from the fight, milord."
                                                    [/message]
                                                [/command]
                                            [/option]
                                            [option]
                                                label=_"Craven retreat poisoned only"
                                                image = "terrain/grass/green.png~BLIT(units/monsters/giant-rat.png)~SCALE(36,36)"
                                                [show_if]
                                                    [have_unit]
                                                        side=9
                                                        [not]
                                                            ability=coward
                                                        [/not]
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                        status=poisoned
                                                    [/have_unit]
                                                [/show_if]
                                                [command]
                                                    [store_unit]
                                                        [filter]
                                                            side=9
                                                            [not]
                                                                ability=coward
                                                            [/not]
                                                            [not]
                                                                type=Caravan
                                                            [/not]
                                                            [not]
                                                                status=pilgrim
                                                            [/not]
                                                            status=poisoned
                                                        [/filter]
                                                        variable=unit_store
                                                        mode=always_clear
                                                    [/store_unit]
                                                    [foreach]
                                                        array=unit_store
                                                        [do]
                                                            {SOBER_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {FALLIN_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {THAW_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {CRAVEN_UNIT $this_item.id $this_item.x $this_item.y}
                                                        [/do]
                                                    [/foreach]
                                                    {CLEAR_VARIABLE unit_store}
                                                    [message]
                                                        side=9
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                        status=poisoned
                                                        message=_"We'll disengage the poisoned from the fight, milord."
                                                    [/message]
                                                [/command]
                                            [/option]
                                            [option]
                                                label=_"Rendezvous at tavern"
                                                image = "terrain/village/log-cabin-tile.png~SCALE(36,36)"
                                                [show_if]
                                                    [have_unit]
                                                        side=9
                                                        [not]
                                                            ability=tavern
                                                        [/not]
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                    [/have_unit]
                                                [/show_if]
                                                [command]
                                                    [store_unit]
                                                        [filter]
                                                            side=9
                                                            [not]
                                                                ability=tavern
                                                            [/not]
                                                            [not]
                                                                type=Caravan
                                                            [/not]
                                                            [not]
                                                                status=pilgrim
                                                            [/not]
                                                        [/filter]
                                                        variable=unit_store
                                                        mode=always_clear
                                                    [/store_unit]
                                                    [foreach]
                                                        array=unit_store
                                                        [do]
                                                            {BRAVE_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {FALLIN_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {THAW_UNIT $this_item.id $this_item.x $this_item.y}
                                                            {DRUNK_UNIT $this_item.id $this_item.x $this_item.y}
                                                        [/do]
                                                    [/foreach]
                                                    {CLEAR_VARIABLE unit_store}
                                                    [message]
                                                        side=9
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                        message=_"We'll regroup at the tavern, milord."
                                                    [/message]
                                                [/command]
                                            [/option]
                                            [option]
                                                label=_"Disperse"
                                                image = "terrain/grass/green.png~BLIT(units/human-loyalists/marshal-leading.png)~SCALE(36,36)"
                                                [show_if]
                                                    {VARIABLE_CONDITIONAL wf_vars.disperse_troops boolean_not_equals yes}
                                                    [have_unit]
                                                        side=9
                                                        [not]
                                                            ability=frozen
                                                        [/not]
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                    [/have_unit]
                                                [/show_if]
                                                [command]
                                                    {VARIABLE wf_vars.disperse_troops yes}
                                                    [message]
                                                        side=9
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                        message=_"We'll disperse right away, milord."
                                                    [/message]
                                                [/command]
                                            [/option]
                                            [option]
                                                label=_"Attack wild animals"
                                                image = "terrain/grass/green.png~BLIT(units/monsters/wolf.png)~SCALE(36,36)"
                                                [show_if]
                                                    {VARIABLE_CONDITIONAL wf_vars.attack_animals boolean_not_equals yes}
                                                    [have_unit]
                                                        side=9
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                    [/have_unit]
                                                [/show_if]
                                                [command]
                                                    {VARIABLE wf_vars.attack_animals yes}
                                                    [modify_side]
                                                        side=9
                                                        team_name=settlers
                                                    [/modify_side]
                                                    [message]
                                                        side=9
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                        message=_"We'll hunt down the wild animals for you, milord."
                                                    [/message]
                                                [/command]
                                            [/option]
                                            [option]
                                                label=_"Don't attack wild animals"
                                                image = "terrain/grass/green.png~BLIT(units/monsters/wolf.png)~SCALE(36,36)"
                                                [show_if]
                                                    {VARIABLE_CONDITIONAL wf_vars.attack_animals boolean_equals yes}
                                                    [have_unit]
                                                        side=9
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                    [/have_unit]
                                                [/show_if]
                                                [command]
                                                    {VARIABLE wf_vars.attack_animals no}
                                                    [modify_side]
                                                        side=9
                                                        team_name=settlers,wild_animals
                                                    [/modify_side]
                                                    [message]
                                                        side=9
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                        message=_"We'll stop hunting down the wild animals, milord."
                                                    [/message]
                                                [/command]
                                            [/option]
                                            [option]
                                                label=_"Retire/Dismiss"
                                                image = "terrain/grass/green.png~SCALE(36,36)"
                                                [show_if]
                                                    [have_unit]
                                                        side=9
                                                        [not]
                                                            type=Caravan
                                                        [/not]
                                                        [not]
                                                            status=pilgrim
                                                        [/not]
                                                    [/have_unit]
                                                [/show_if]
                                                [command]
                                                    [deselect]
                                                    [/deselect]
                                                    [store_unit]
                                                        [filter]
                                                            side=9
                                                            [not]
                                                                type=Caravan
                                                            [/not]
                                                            [not]
                                                                status=pilgrim
                                                            [/not]
                                                        [/filter]
                                                        variable=unit_store
                                                        mode=always_clear
                                                    [/store_unit]
                                                    [foreach]
                                                        array=unit_store
                                                        [do]
                                                            {WF_SCROLL_UNIT (id=$this_item.id)}
                                                            [message]
                                                                speaker=$this_item.id
                                                                message=_"Are you sure you want to dismiss me, milord?"
                                                                [option]
                                                                    label=_"No"
                                                                    default=yes
                                                                    [command]
                                                                    [/command]
                                                                [/option]
                                                                [option]
                                                                    label=_"Yes"
                                                                    [command]
                                                                        [kill]
                                                                            x=$this_item.x
                                                                            y=$this_item.y
                                                                            id=$this_item.id
                                                                            side=9
                                                                            animate=no
                                                                            fire_event=no
                                                                        [/kill]
                                                                    [/command]
                                                                [/option]
                                                            [/message]
                                                        [/do]
                                                    [/foreach]
                                                    {CLEAR_VARIABLE unit_store}
                                                    #[break][/break]
                                                [/command]
                                            [/option]
                                        [/message]
                                    [/do]
                                [/while]
                            [/command]
                        [/option]
                        [option]
                            label=_"Put out the light"
                            image = "terrain/void/void.png~BLIT(scenery/lighthouse.png)~SCALE(36,36)"
                            [show_if]
                                [have_unit]
                                    type=WF_Lighthouse
                                    side=1
                                    x=$x1
                                    y=$y1
                                [/have_unit]
                            [/show_if]
                            [command]
                                [sound]
                                    name="hiss.wav"
                                [/sound]
                                [transform_unit]
                                    side=1
                                    x=$x1
                                    y=$y1
                                    type=WF_Lighthouse
                                    transform_to=WF_Lighthouse_Off
                                [/transform_unit]
                            [/command]
                        [/option]
                        [option]
                            label=_"Fire up the light"
                            image = "terrain/grass/green.png~BLIT(scenery/lighthouse.png)~SCALE(36,36)"
                            [show_if]
                                [have_unit]
                                    type=WF_Lighthouse_Off
                                    side=1
                                    x,y=$x1,$y1
                                [/have_unit]
                            [/show_if]
                            [command]
                                [sound]
                                    name="torch.ogg"
                                [/sound]
                                [transform_unit]
                                    side=1
                                    x=$x1
                                    y=$y1
                                    type=WF_Lighthouse_Off
                                    transform_to=WF_Lighthouse
                                [/transform_unit]
                            [/command]
                        [/option]
                        [option]
                            label=_"Summon allied help"
                            image = "terrain/grass/green.png~BLIT(units/human-loyalists/royal-warrior.png)~SCALE(36,36)"
                            [show_if]
                                [variable]
                                    name=wf_vars.king_troops
                                    boolean_equals=no
                                [/variable]
                                {HAVE_SIDE9_COUNT}
                            [/show_if]
                            [command]
                                {VARIABLE king_cost {KING_COST}}
                                [if]
                                    [have_unit]
                                        side=1
                                        [and]
                                            race=undead
                                            [or]
                                                type_adv_tree=Dark Adept
                                            [/or]
                                        [/and]
                                        search_recall_list=no
                                    [/have_unit]
                                    {VARIABLE_CONDITIONAL diplomacy.ally equals "loyalists"}
                                    [then]
                                        {VARIABLE_OP king_cost add 100}
                                    [/then]
                                [/if]

                                [if]
                                    [have_unit]
                                        side=9
                                        role=ally_leader
                                    [/have_unit]
                                    [then]
                                        [store_unit]
                                            [filter]
                                                side=9
                                                role=ally_leader
                                            [/filter]
                                            variable=ally_store
                                            mode=always_clear
                                            kill=no
                                        [/store_unit]
                                        {VARIABLE_OP king_cost add "$(75 * $ally_store.length)"}
                                        {CLEAR_VARIABLE ally_store}
                                    [/then]
                                [/if]

                                [message]
                                    speaker=unit
                                    message=_"Calling for the $diplomacy.ally| will cost $king_cost| in fees, milord. Do you want me to call for them?"
                                    [option]
                                        label=_"Yes"
                                        [command]
                                            {STORE_GOLD}
                                            [if]
                                                {CHECK_GOLD $king_cost}
                                                [then]
                                                    {PAY_GOLD $king_cost}
                                                    {VARIABLE wf_vars.king_troops yes}
                                                    {RANDOM_VAR proj_turns.king 1..3}
                                                    [if]
                                                        {VARIABLE_CONDITIONAL wf_vars.extra_guardian greater_than 0}
                                                        [then]
                                                            {VARIABLE proj_turns.king 1}
                                                        [/then]
                                                    [/if]
                                                    [message]
                                                        speaker=unit
                                                        message=_"Milord, we have summoned for the $diplomacy.ally| to assist us. They will arrive in $proj_turns.king| turns."
                                                    [/message]
                                                    [sound]
                                                        name="horn-signals/horn-2.ogg"
                                                    [/sound]
                                                [/then]
                                                [else]
                                                    {UNIT_SAYS _"But milord, we need $king_cost| gold for fees, and yer treasury don't 'ave that much!"}
                                                [/else]
                                            [/if]
                                        [/command]
                                    [/option]
                                    [option]
                                        label=_"No"
                                        [command] [/command]
                                    [/option]
                                [/message]
                                {CLEAR_VARIABLE king_cost}
                            [/command]
                        [/option]
                        [option]
                            label=_"Hurry up allied help"
                            image = "terrain/grass/green.png~BLIT(units/human-loyalists/royal-warrior.png)~SCALE(36,36)"
                            [show_if]
                                [variable]
                                    name=wf_vars.king_troops
                                    boolean_equals=yes
                                [/variable]
                            [/show_if]
                            [command]
                                [message]
                                    speaker=unit
                                    message=_"The $diplomacy.ally| will arrive in $proj_turns.king| turns. We can hurry them for $wf_vars.gold_cost| gold?"
                                    # 0=east, 1=north, 2=west, 3=south
                                    [option]
                                        label=_"Hurry them from the North"
                                        [show_if]
                                            {VARIABLE_CONDITIONAL quota.allied_dir not_equals 1}
                                        [/show_if]
                                        [command]
                                            {STORE_GOLD}
                                            [if]
                                                {CHECK_GOLD $wf_vars.gold_cost}
                                                [then]
                                                    {PAY_GOLD $wf_vars.gold_cost}
                                                    {VARIABLE quota.allied_dir 1}
                                                    {VARIABLE proj_turns.king 1}
                                                    [message]
                                                        speaker=unit
                                                        message=_"Milord, the $diplomacy.ally| will arrive in $proj_turns.king| turns from the North."
                                                    [/message]
                                                    [sound]
                                                        name="horn-signals/horn-2.ogg"
                                                    [/sound]
                                                [/then]
                                                [else]
                                                    {UNIT_SAYS _"But milord, we need $wf_vars.gold_cost| gold for fees, and yer treasury don't 'ave that much!"}
                                                [/else]
                                            [/if]
                                        [/command]
                                    [/option]
                                    # 0=east, 1=north, 2=west, 3=south
                                    [option]
                                        label=_"Hurry them from the South"
                                        [show_if]
                                            {VARIABLE_CONDITIONAL quota.allied_dir not_equals 3}
                                        [/show_if]
                                        [command]
                                            {STORE_GOLD}
                                            [if]
                                                {CHECK_GOLD $wf_vars.gold_cost}
                                                [then]
                                                    {PAY_GOLD $wf_vars.gold_cost}
                                                    {VARIABLE quota.allied_dir 3}
                                                    {VARIABLE proj_turns.king 1}
                                                    [message]
                                                        speaker=unit
                                                        message=_"Milord, the $diplomacy.ally| will arrive in $proj_turns.king| turns from the South."
                                                    [/message]
                                                    [sound]
                                                        name="horn-signals/horn-2.ogg"
                                                    [/sound]
                                                [/then]
                                                [else]
                                                    {UNIT_SAYS _"But milord, we need $wf_vars.gold_cost| gold for fees, and yer treasury don't 'ave that much!"}
                                                [/else]
                                            [/if]
                                        [/command]
                                    [/option]
                                    # 0=east, 1=north, 2=west, 3=south
                                    [option]
                                        label=_"Hurry them from the East"
                                        [show_if]
                                            {VARIABLE_CONDITIONAL quota.allied_dir not_equals 0}
                                        [/show_if]
                                        [command]
                                            {STORE_GOLD}
                                            [if]
                                                {CHECK_GOLD $wf_vars.gold_cost}
                                                [then]
                                                    {PAY_GOLD $wf_vars.gold_cost}
                                                    {VARIABLE quota.allied_dir 0}
                                                    {VARIABLE proj_turns.king 1}
                                                    [message]
                                                        speaker=unit
                                                        message=_"Milord, the $diplomacy.ally| will arrive in $proj_turns.king| turns from the East."
                                                    [/message]
                                                    [sound]
                                                        name="horn-signals/horn-2.ogg"
                                                    [/sound]
                                                [/then]
                                                [else]
                                                    {UNIT_SAYS _"But milord, we need $wf_vars.gold_cost| gold for fees, and yer treasury don't 'ave that much!"}
                                                [/else]
                                            [/if]
                                        [/command]
                                    [/option]
                                    # 0=east, 1=north, 2=west, 3=south
                                    [option]
                                        label=_"Hurry them from the West"
                                        [show_if]
                                            {VARIABLE_CONDITIONAL quota.allied_dir not_equals 2}
                                        [/show_if]
                                        [command]
                                            {STORE_GOLD}
                                            [if]
                                                {CHECK_GOLD $wf_vars.gold_cost}
                                                [then]
                                                    {PAY_GOLD $wf_vars.gold_cost}
                                                    {VARIABLE quota.allied_dir 2}
                                                    {VARIABLE proj_turns.king 1}
                                                    [message]
                                                        speaker=unit
                                                        message=_"Milord, the $diplomacy.ally| will arrive in $proj_turns.king| turns from the West."
                                                    [/message]
                                                    [sound]
                                                        name="horn-signals/horn-2.ogg"
                                                    [/sound]
                                                [/then]
                                                [else]
                                                    {UNIT_SAYS _"But milord, we need $wf_vars.gold_cost| gold for fees, and yer treasury don't 'ave that much!"}
                                                [/else]
                                            [/if]
                                        [/command]
                                    [/option]
                                    [option]
                                        label=_"Nevermind"
                                        [command] [/command]
                                    [/option]
                                [/message]
                            [/command]
                        [/option]
                        [option]
                            label=_"Sponsor a market caravan trip"
                            image = "terrain/grass/green.png~BLIT(units/caravan.png)~SCALE(36,36)"
                            [show_if]
                                [have_location]
                                    terrain=*^Wm
                                    count=1
                                [/have_location]
                                [have_unit]
                                    side=9
                                    type=Caravan
                                    count=0
                                [/have_unit]
                                {VARIABLE_CONDITIONAL turn_number greater_than 1}
                                {VARIABLE_CONDITIONAL quota.market_siren boolean_not_equals yes}
                                {VARIABLE_CONDITIONAL wf_vars.side1_gold greater_than_equal_to $wf_vars.gold_cost}
                            [/show_if]
                            [command]
                                {STORE_GOLD}
                                [if]
                                    {VARIABLE_CONDITIONAL wf_vars.side1_gold greater_than_equal_to $wf_vars.gold_cost}
                                    [then]
                                        [message]
                                            speaker=unit
                                            message=_"Do you want to sponsor a new caravan trip?"
                                            [option]
                                                label=_"Yes, pay $wf_vars.gold_cost| gold."
                                                [command]
                                                    {VARIABLE quota.market_siren yes}
                                                    {PAY_GOLD $wf_vars.gold_cost}
                                                    {UNIT_SAYS _"<i>(Signaling for a market caravan)</i>"}
                                                    [sound]
                                                        name="horn-signals/horn-2.ogg"
                                                    [/sound]
                                                    [event]
                                                        name=side 9 turn end
                                                        id=taunt_9m
                                                        {VARIABLE quota.market_siren no}
                                                        {FIRE_EVENT spawn_market_caravan}
                                                        [unhide_unit]
                                                        [/unhide_unit]
                                                    [/event]
                                                [/command]
                                            [/option]
                                            [option]
                                                label=_"No"
                                                [command]
                                                [/command]
                                            [/option]
                                        [/message]
                                    [/then]
                                    [else]
                                        [message]
                                            speaker=unit
                                            message=_"We lack $wf_vars.gold_cost| gold. Try again later."
                                        [/message]
                                    [/else]
                                [/if]
                            [/command]
                        [/option]
                        [option]
                            label=_"Blow siren"
                            image = "terrain/grass/green.png~BLIT(units/monsters/wolf.png)~SCALE(36,36)"
                            [show_if]
                                {VARIABLE_CONDITIONAL quota.animal_siren boolean_not_equals yes}
                            [/show_if]
                            [command]
                                [message]
                                    speaker=unit
                                    message=_"Blowing the siren will irk the wild beasts. Are you sure you want to do it?"
                                    [option]
                                        label=_"Yes"
                                        [command]
                                            {UNIT_SAYS _"Brace yourself, all of the wild beasts will move in on us for the rest of the season!"}
                                            [sound]
                                                name="horn-signals/horn-7.ogg"
                                            [/sound]
                                            {ANIMAL_SIREN}
                                        [/command]
                                    [/option]
                                    [option]
                                        label=_"No"
                                        [command] [/command]
                                    [/option]
                                [/message]
                            [/command]
                        [/option]
                        [option]
                            label=_"Antagonize the enemy"
                            image = "terrain/grass/green.png~BLIT(units/monsters/wolf.png)~SCALE(36,36)"
                            [show_if]
                                {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 1}
                            [/show_if]
                            [command]
                                [message]
                                    speaker=unit
                                    message="Which enemy would you like to taunt?"
                                    [option]
                                        label="Wild animals ($quota.taunt_2a| left)"
                                        [show_if]
                                            {VARIABLE_CONDITIONAL quota.taunt_2a greater_than 0}
                                        [/show_if]
                                        [command]
                                            {UNIT_SAYS _"<i>(Taunting wild animals)</i>"}
                                            [sound]
                                                name="horn-signals/horn-2.ogg"
                                            [/sound]
                                            {VARIABLE_OP quota.taunt_2a sub 1}
                                            [event]
                                                name=side 2 turn end
                                                #id=taunt_2a
                                                {FIRE_EVENT new_random_animal}
                                                {FIRE_EVENT new_random_animal}
                                                {FIRE_EVENT new_random_animal}
                                                [unhide_unit]
                                                [/unhide_unit]
                                            [/event]
                                        [/command]
                                    [/option]
                                    [option]
                                        label="Wild guardians ($quota.taunt_2g| left)"
                                        [show_if]
                                            {VARIABLE_CONDITIONAL quota.taunt_2g greater_than 0}
                                        [/show_if]
                                        [command]
                                            {UNIT_SAYS _"<i>(Taunting wild guardians)</i>"}
                                            [sound]
                                                name="horn-signals/horn-2.ogg"
                                            [/sound]
                                            {VARIABLE_OP quota.taunt_2g sub 1}
                                            [event]
                                                name=side 2 turn end
                                                #id=taunt_2g
                                                {FIRE_EVENT new_animal_guardian}
                                                [unhide_unit]
                                                [/unhide_unit]
                                            [/event]
                                        [/command]
                                    [/option]
                                    [option]
                                        label="Outlaws ($quota.taunt_3| left)"
                                        [show_if]
                                            {VARIABLE_CONDITIONAL quota.taunt_3 greater_than 0}
                                        [/show_if]
                                        [command]
                                            {UNIT_SAYS _"<i>(Taunting outlaws)</i>"}
                                            [sound]
                                                name="horn-signals/horn-2.ogg"
                                            [/sound]
                                            {VARIABLE_OP quota.taunt_3 sub 1}
                                            [event]
                                                name=side 3 turn end
                                                #id=taunt_3
                                                {FIRE_EVENT new_outlaws_raid}
                                                [unhide_unit]
                                                [/unhide_unit]
                                            [/event]
                                        [/command]
                                    [/option]
                                    [option]
                                        label="Bandits ($quota.taunt_4| left)"
                                        [show_if]
                                            {VARIABLE_CONDITIONAL quota.taunt_4 greater_than 0}
                                        [/show_if]
                                        [command]
                                            {UNIT_SAYS _"<i>(Taunting bandits)</i>"}
                                            [sound]
                                                name="horn-signals/horn-2.ogg"
                                            [/sound]
                                            {VARIABLE_OP quota.taunt_4 sub 1}
                                            [event]
                                                name=side 4 turn end
                                                #id=taunt_4
                                                {FIRE_EVENT new_bandits_raid}
                                                [unhide_unit]
                                                [/unhide_unit]
                                            [/event]
                                        [/command]
                                    [/option]
                                    [option]
                                        label="Orcs ($quota.taunt_5| left)"
                                        [show_if]
                                            {VARIABLE_CONDITIONAL quota.taunt_5 greater_than 0}
                                        [/show_if]
                                        [command]
                                            {UNIT_SAYS _"<i>(Taunting orcs)</i>"}
                                            [sound]
                                                name="horn-signals/horn-2.ogg"
                                            [/sound]
                                            {VARIABLE_OP quota.taunt_5 sub 1}
                                            [event]
                                                name=side 5 turn end
                                                #id=taunt_5
                                                {FIRE_EVENT new_orc_raid}
                                                [unhide_unit]
                                                [/unhide_unit]
                                            [/event]
                                        [/command]
                                    [/option]
                                    [option]
                                        label="Elves ($quota.taunt_6e| left)"
                                        [show_if]
                                            {VARIABLE_CONDITIONAL quota.taunt_6e greater_than 0}
                                        [/show_if]
                                        [command]
                                            {UNIT_SAYS _"<i>(Taunting elves)</i>"}
                                            [sound]
                                                name="horn-signals/horn-2.ogg"
                                            [/sound]
                                            {VARIABLE_OP quota.taunt_6e sub 1}
                                            [event]
                                                name=side 6 turn end
                                                #id=taunt_6e
                                                {FIRE_EVENT new_elves_raid}
                                                [unhide_unit]
                                                [/unhide_unit]
                                            [/event]
                                        [/command]
                                    [/option]
                                    [option]
                                        label="Dwarves ($quota.taunt_6d| left)"
                                        [show_if]
                                            {VARIABLE_CONDITIONAL quota.taunt_6d greater_than 0}
                                        [/show_if]
                                        [command]
                                            {UNIT_SAYS _"<i>(Taunting dwarves)</i>"}
                                            [sound]
                                                name="horn-signals/horn-2.ogg"
                                            [/sound]
                                            {VARIABLE_OP quota.taunt_6d sub 1}
                                            [event]
                                                name=side 6 turn end
                                                #id=taunt_6d
                                                {FIRE_EVENT new_dwarves_raid}
                                                [unhide_unit]
                                                [/unhide_unit]
                                            [/event]
                                        [/command]
                                    [/option]
                                    [option]
                                        label="Undead ($quota.taunt_7| left)"
                                        [show_if]
                                            {VARIABLE_CONDITIONAL quota.taunt_7 greater_than 0}
                                        [/show_if]
                                        [command]
                                            {UNIT_SAYS _"<i>(Taunting undead)</i>"}
                                            [sound]
                                                name="horn-signals/horn-2.ogg"
                                            [/sound]
                                            {VARIABLE_OP quota.taunt_7 sub 1}
                                            [event]
                                                name=side 7 turn end
                                                #id=taunt_7
                                                {FIRE_EVENT new_undead_raid}
                                                [unhide_unit]
                                                [/unhide_unit]
                                            [/event]
                                        [/command]
                                    [/option]
                                    [option]
                                        label="Nevermind"
                                        [command]
                                        [/command]
                                    [/option]
                                [/message]
                            [/command]
                        [/option]
                        [option]
                            label=_"Destroy lighthouse"
                            image = "terrain/flat/dirt-dark.png~BLIT(terrain/misc/rubble-tile.png)~SCALE(36,36)"
                            [show_if]
                                [have_unit]
                                    type=WF_Lighthouse,WF_Lighthouse_Off
                                    side=1
                                    x,y=$x1,$y1
                                    [filter_adjacent]
                                        side=1
                                        type_adv_tree={DESTROYER_LIST}
                                    [/filter_adjacent]
                                [/have_unit]
                            [/show_if]
                            [command]
                                {CHECK_AND_DESTROY_ZERO "lighthouse" $x1 $y1 (_"Are you sure you want to destroy this lighthouse, milord?")}
                            [/command]
                        [/option]
                        [option]
                            label=_"Nevermind"
                            image = "terrain/void/void.png~SCALE(36,36)"
                            [command] [/command]
                        [/option]
                    [/message]
                [/then]
            [/if]
            # Lighthouse end }
            # Allies side 9 start {
            [if]
                [have_unit]
                    side=9
                    x,y=$x1,$y1
                [/have_unit]
                [then]
                    [message]
                        speaker=unit
                        message=_"What would you like me to do, milord?"
                        [option]
                            label=_"Resume guardian duties"
                            image = "terrain/grass/green.png~BLIT(units/human-loyalists/royalguard.png)~SCALE(36,36)"
                            [show_if]
                                [have_unit]
                                    x,y=$x1,$y1
                                    side=9
                                    [and]
                                        ability=frozen
                                        [or]
                                            ability=fallback
                                        [/or]
                                        [or]
                                            ability=coward
                                        [/or]
                                        [or]
                                            ability=tavern
                                        [/or]
                                    [/and]
                                [/have_unit]
                            [/show_if]
                            [command]
                                {SOBER_UNIT $unit.id $x1 $y1}
                                {BRAVE_UNIT $unit.id $x1 $y1}
                                {FALLIN_UNIT $unit.id $x1 $y1}
                                {THAW_UNIT $unit.id $x1 $y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Sentry position"
                            image = "terrain/grass/green.png~BLIT(units/human-loyalists/siegetrooper.png)~SCALE(36,36)"
                            [show_if]
                                [have_unit]
                                    x,y=$x1,$y1
                                    side=9
                                    [not]
                                        ability=frozen
                                    [/not]
                                [/have_unit]
                            [/show_if]
                            [command]
                                {SOBER_UNIT $unit.id $x1 $y1}
                                {BRAVE_UNIT $unit.id $x1 $y1}
                                {FALLIN_UNIT $unit.id $x1 $y1}
                                {FREEZE_UNIT $unit.id $x1 $y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Defensive fallback"
                            image = "terrain/grass/green.png~BLIT(units/human-loyalists/javelineer.png)~SCALE(36,36)"
                            [show_if]
                                [have_unit]
                                    x,y=$x1,$y1
                                    side=9
                                    [not]
                                        ability=fallback
                                    [/not]
                                [/have_unit]
                            [/show_if]
                            [command]
                                {SOBER_UNIT $unit.id $x1 $y1}
                                {BRAVE_UNIT $unit.id $x1 $y1}
                                {THAW_UNIT $unit.id $x1 $y1}
                                {FALLBACK_UNIT $unit.id $x1 $y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Craven retreat"
                            image = "terrain/grass/green.png~BLIT(units/monsters/giant-rat.png)~SCALE(36,36)"
                            [show_if]
                                [have_unit]
                                    x,y=$x1,$y1
                                    side=9
                                    [not]
                                        ability=coward
                                    [/not]
                                [/have_unit]
                            [/show_if]
                            [command]
                                {SOBER_UNIT $unit.id $x1 $y1}
                                {FALLIN_UNIT $unit.id $x1 $y1}
                                {THAW_UNIT $unit.id $x1 $y1}
                                {CRAVEN_UNIT $unit.id $x1 $y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Rendezvous at tavern"
                            image = "terrain/village/log-cabin-tile.png~SCALE(36,36)"
                            [show_if]
                                [have_unit]
                                    x,y=$x1,$y1
                                    side=9
                                    [not]
                                        ability=tavern
                                    [/not]
                                [/have_unit]
                            [/show_if]
                            [command]
                                {BRAVE_UNIT $unit.id $x1 $y1}
                                {FALLIN_UNIT $unit.id $x1 $y1}
                                {THAW_UNIT $unit.id $x1 $y1}
                                {DRUNK_UNIT $unit.id $x1 $y1}
                            [/command]
                        [/option]
                        [option]
                            label=_"Disperse troops"
                            image = "terrain/grass/green.png~BLIT(units/human-loyalists/marshal-leading.png)~SCALE(36,36)"
                            [show_if]
                                {VARIABLE_CONDITIONAL wf_vars.disperse_troops boolean_not_equals yes}
                                [have_unit]
                                    side=9
                                    x,y=$x1,$y1
                                    [not]
                                        ability=frozen
                                    [/not]
                                    [not]
                                        type=Caravan
                                    [/not]
                                    [not]
                                        status=pilgrim
                                    [/not]
                                [/have_unit]
                                #[have_location]
                                #	x,y=$x1,$y1
                                #	terrain=*^Yt,*^Yto
                                #[/have_location]
                            [/show_if]
                            [command]
                                [message]
                                    speaker=unit
                                    message=_"We'll disperse right away, milord."
                                [/message]
                                {VARIABLE wf_vars.disperse_troops yes}
                            [/command]
                        [/option]
                        [option]
                            label=_"Attack wild animals"
                            image = "terrain/grass/green.png~BLIT(units/monsters/wolf.png)~SCALE(36,36)"
                            [show_if]
                                {VARIABLE_CONDITIONAL wf_vars.attack_animals boolean_not_equals yes}
                                [have_unit]
                                    side=9
                                    x,y=$x1,$y1
                                    [not]
                                        type=Caravan
                                    [/not]
                                    [not]
                                        status=pilgrim
                                    [/not]
                                [/have_unit]
                            [/show_if]
                            [command]
                                {VARIABLE wf_vars.attack_animals yes}
                                [modify_side]
                                    side=9
                                    team_name=settlers
                                [/modify_side]
                                [message]
                                    speaker=unit
                                    message=_"We'll hunt down the wild animals for you, milord."
                                [/message]
                            [/command]
                        [/option]
                        [option]
                            label=_"Don't attack wild animals"
                            image = "terrain/grass/green.png~BLIT(units/monsters/wolf.png)~SCALE(36,36)"
                            [show_if]
                                {VARIABLE_CONDITIONAL wf_vars.attack_animals boolean_equals yes}
                                [have_unit]
                                    side=9
                                    x,y=$x1,$y1
                                    [not]
                                        type=Caravan
                                    [/not]
                                    [not]
                                        status=pilgrim
                                    [/not]
                                [/have_unit]
                            [/show_if]
                            [command]
                                {VARIABLE wf_vars.attack_animals no}
                                [modify_side]
                                    side=9
                                    team_name=settlers,wild_animals
                                [/modify_side]
                                [message]
                                    speaker=unit
                                    message=_"We'll stop hunting down the wild animals, milord."
                                [/message]
                            [/command]
                        [/option]
                        [option]
                            label=_"Retire"
                            image = "terrain/grass/green.png~SCALE(36,36)"
                            [show_if]
                                [have_unit]
                                    side=9
                                    x,y=$x1,$y1
                                    [not]
                                        type=Caravan
                                    [/not]
                                    [not]
                                        status=pilgrim
                                    [/not]
                                [/have_unit]
                                #[have_location]
                                #	x,y=$x1,$y1
                                #	terrain=*^Yt,*^Yto
                                #[/have_location]
                            [/show_if]
                            [command]
                                [message]
                                    speaker=unit
                                    message=_"Are you sure you want to dismiss me, milord?"
                                    [option]
                                        label=_"No"
                                        default=yes
                                        [command]
                                        [/command]
                                    [/option]
                                    [option]
                                        label=_"Yes"
                                        [command]
                                            [kill]
                                                x,y=$x1,$y1
                                                id=$unit.id
                                                side=9
                                                animate=no
                                                fire_event=no
                                            [/kill]
                                        [/command]
                                    [/option]
                                [/message]
                            [/command]
                        [/option]
                        [option]
                            label=_"Nevermind"
                            image = "terrain/void/void.png~SCALE(36,36)"
                            [command] [/command]
                        [/option]
                    [/message]
                [/then]
            [/if]
            # Allies side 9 end }
            # Hero, canrecruit
            [if]
                [have_unit]
                    #id=Hero
                    canrecruit=yes
                    side=1
                    x,y=$x1,$y1
                [/have_unit]
                [have_location]
                    x,y=$x1,$y1
                    terrain=*^Yu*
                [/have_location]
                [then]
                    {WF_DIPLOMACY_MENU}
                [/then]
            [/if]
            [if]
                [have_unit]
                    id=Hero
                    canrecruit=yes
                    side=1
                    x,y=$x1,$y1
                [/have_unit]
                [have_location]
                    x,y=$x1,$y1
                    #terrain=K*^*
                    terrain=K*^Yk
                [/have_location]
                [then]
                    [message]
                        speaker=unit
                        message=_"Do what?"
                        [option]
                            label=_"Increase city rank. (Current rank: $wf_vars.expand_rank|)"
                            [command]
                                [if]
                                    {CHECK_GOLD $wf_vars.expand_cost}
                                    [then]
                                        [message]
                                            speaker=unit
                                            message=_"The current city capacity is $wf_vars.village_limit|. Should I pay $wf_vars.expand_cost| gold to expand it further?"
                                            [option]
                                                label=_"Yes"
                                                [command]
                                                    {PAY_GOLD $wf_vars.expand_cost}
                                                    {VARIABLE_OP wf_vars.expand_rank add 1}
                                                    {VARIABLE_OP wf_vars.village_limit add 20}
                                                    [if]
                                                        {VARIABLE_CONDITIONAL wf_vars.expand_rank less_than 5}
                                                        [then]
                                                            {VARIABLE_OP wf_vars.expand_cost add $wf_vars.expand_cost_add}
                                                            {DELFADOR_SAYS _"Increasing the rank further unlocks new features."}
                                                        [/then]
                                                    [/if]
                                                [/command]
                                            [/option]
                                            [option]
                                                label=_"No"
                                                [command] [/command]
                                            [/option]
                                        [/message]
                                    [/then]
                                    [else]
                                        [message]
                                            speaker=unit
                                            message=_"The current city capacity is $wf_vars.village_limit|. I need to raise $wf_vars.expand_cost gold to expand it further."
                                        [/message]
                                    [/else]
                                [/if]
                            [/command]
                        [/option]
                        [option]
                            label=_"Tweak recruit list"
                            [command]
                                [wf_sort_array]
                                    name=recruit_array.list
                                    first_key=label
                                    second_key=type
                                [/wf_sort_array]
                                [for]
                                    array=recruit_array.list
                                    [do]
                                        [set_variables]
                                            name=tmp_recruit
                                            mode=append
                                            [value]
                                                label="<span color='#808080'>Show $recruit_array.list[$i].label|</span>"
                                                image="terrain/void/void.png~BLIT($recruit_array.list[$i].image|)~SCALE(36,36)"
                                                [show_if]
                                                    {VARIABLE_CONDITIONAL recruit_array.list[$i].allow equals yes}
                                                    {VARIABLE_CONDITIONAL recruit_array.list[$i].enable equals no}
                                                [/show_if]
                                                [command]
                                                    {VARIABLE recruit_array.list[$i].enable yes}
                                                [/command]
                                            [/value]
                                        [/set_variables]
                                        [set_variables]
                                            name=tmp_recruit
                                            mode=append
                                            [value]
                                                label="Hide $recruit_array.list[$i].label|"
                                                image="terrain/grass/green.png~BLIT($recruit_array.list[$i].image|)~SCALE(36,36)"
                                                [show_if]
                                                    {VARIABLE_CONDITIONAL recruit_array.list[$i].allow equals yes}
                                                    {VARIABLE_CONDITIONAL recruit_array.list[$i].enable equals yes}
                                                [/show_if]
                                                [command]
                                                    {VARIABLE recruit_array.list[$i].enable no}
                                                [/command]
                                            [/value]
                                        [/set_variables]
                                    [/do]
                                [/for]

                                {VARIABLE finished no}
                                [while]
                                    [variable]
                                        name=finished
                                        boolean_equals=no
                                    [/variable]
                                    [do]
                                        [message]
                                            speaker=unit
                                            message=_"Show/hide types in the recruit menu"
                                            [option]
                                                label=_"Done"
                                                image="terrain/void/void.png~SCALE(36,36)"
                                                [command]
                                                    {VARIABLE finished yes}
                                                [/command]
                                            [/option]
                                            [option]
                                                label=_"Hide all"
                                                image="terrain/void/void.png~SCALE(36,36)"
                                                [command]
                                                    [for]
                                                        array=recruit_array.list
                                                        [do]
                                                            {VARIABLE recruit_array.list[$i].enable no}
                                                        [/do]
                                                    [/for]
                                                [/command]
                                            [/option]
                                            [option]
                                                label=_"Show all"
                                                image="terrain/grass/green.png~SCALE(36,36)"
                                                [command]
                                                    [for]
                                                        array=recruit_array.list
                                                        [do]
                                                            {VARIABLE recruit_array.list[$i].enable yes}
                                                        [/do]
                                                    [/for]
                                                [/command]
                                            [/option]
                                            [insert_tag]
                                                name=option
                                                variable=tmp_recruit
                                            [/insert_tag]
                                        [/message]
                                    [/do]
                                [/while]
                                {CLEAR_VARIABLE finished}
                                {CLEAR_VARIABLE tmp_recruit}

                                [foreach]
                                    array=recruit_array.list
                                    [do]
                                        [if]
                                            {VARIABLE_CONDITIONAL this_item.allow equals yes}
                                            {VARIABLE_CONDITIONAL this_item.enable equals yes}
                                            [then]
                                                [set_variables]
                                                    name=tmp_recruit_arr
                                                    mode=append
                                                    [value]
                                                        type=$this_item.type
                                                    [/value]
                                                [/set_variables]
                                            [/then]
                                        [/if]
                                    [/do]
                                [/foreach]
                                [set_variable]
                                    name=tmp_recruit
                                    [join]
                                        variable=tmp_recruit_arr
                                        key=type
                                        separator=,
                                        remove_empty=yes
                                    [/join]
                                [/set_variable]
                                [set_recruit]
                                    side=1
                                    recruit=$tmp_recruit
                                [/set_recruit]

                                {CLEAR_VARIABLE tmp_recruit_arr}
                                {CLEAR_VARIABLE tmp_recruit}
                            [/command]
                        [/option]
                        # ---- Nevermind ----
                        [option]
                            label=_"Nevermind"
                            [command] [/command]
                        [/option]
                    [/message]
                [/then]
            [/if]
            {CLEAR_VARIABLE village_count}
        [/command]
    [/set_menu_item]

    # ----- Label farm -----
    [set_menu_item]
        id=label_farm
        description=_ "Christen town..."
        image="build_icon.png"
        [show_if]
            [have_unit]
                side=1
                canrecruit=yes
                x,y=$x1,$y1
            [/have_unit]
            [have_location]
                x,y=$x1,$y1
                terrain=*^V*
            [/have_location]
        [/show_if]
        [command]
            [message]
                speaker=unit
                message=_"I hereby christen thee ..."
                [text_input]
                    label=_"Name:"
                    variable=town_name
                    max_length=16
                [/text_input]
            [/message]
            {CLEAR_MAP_LABEL $x1 $y1}
            [if]
                {VARIABLE_CONDITIONAL town_name not_equals ""}
                [then]
                    {ADD_MAP_LABEL $x1 $y1 $town_name}
                [/then]
                [else]
                    [label]
                        x,y=$x1,$y1
                        text=""
                    [/label]
                [/else]
            [/if]
            {CLEAR_VARIABLE town_name}
        [/command]
    [/set_menu_item]

    # ----- Relocate wooden keep -----
    [set_menu_item]
        id=relocate_keep_hero
        description=_ "Relocate wooden keep"
        image="tent_icon.png"
        [show_if]
            [and]
                [have_location]
                    terrain=Ke^Yk,Kea^Yk
                    count=1
                [/have_location]
                [have_location]
                    terrain={BUILDABLE_TERRAIN},Ce,Cea
                    x,y=$x1,$y1
                [/have_location]
                [have_unit]
                    id=Hero
                    x=$x1
                    y=$y1
                [/have_unit]
            [/and]
        [/show_if]
        [command]
            {RELOCATE_KEEP_1}
            [message]
                {RELOCATE_KEEP_2}
                [text_input]
                    label=_"Name:"
                    variable=town_name
                    text=$wf_vars.hero_name
                    max_length=16
                [/text_input]
            [/message]
            [if]
                {VARIABLE_CONDITIONAL town_name equals $wf_vars.hero_name}
                [then]
                    {RELOCATE_KEEP_3}
                [/then]
            [/if]
            {MODIFY_UNIT id=Hero moves 0}
            [store_locations]
                variable=old_keep
                terrain=Ke^Yk,Kea^Yk
            [/store_locations]
            {CLEAR_MAP_LABEL $old_keep.x $old_keep.y}
            {REMOVE_IMAGE_BURN $x1 $y1}
            {MODIFY_TERRAIN "Ce" $old_keep.x $old_keep.y}
            {MODIFY_TERRAIN "Ke^Yk" $x1 $y1}
            [if]
                {VARIABLE_CONDITIONAL town_name not_equals ""}
                [then]
                    {VARIABLE wf_vars.town_name $town_name}
                    {ADD_MAP_LABEL $x1 $y1 $town_name}
                [/then]
                [else]
                    {VARIABLE wf_vars.town_name _"Town center"}
                    {ADD_MAP_LABEL $x1 $y1 _"Town center"}
                [/else]
            [/if]
            [remove_item]
                x,y=$old_keep.x,$old_keep.y
                image=items/gohere.png
            [/remove_item]
            [if]
                {VARIABLE_CONDITIONAL notify_indoor boolean_equals yes}
                [then]
                    [item]
                        x,y=$x1,$y1
                        image=items/gohere.png
                        visible_in_fog=yes
                    [/item]
                [/then]
            [/if]
            {CLEAR_VARIABLE old_keep}
            {CLEAR_VARIABLE town_name}
            [clear_menu_item]
                id=relocate_keep_hero
            [/clear_menu_item]
        [/command]
    [/set_menu_item]

    # ----- Sacrifice altar -----
    [set_menu_item]
        id=sacrifice_unit
        description=_"Sacrifice unit..."
        image="terrain/void/void.png~BLIT(items/altar-evil.png)~SCALE(18,18)"
        [show_if]
            [have_unit]
                side=1
                x,y=$x1,$y1
                formula="self.level>1"
                [not]
                    id=Hero
                [/not]
                [not]
                    type=Caravan
                [/not]
            [/have_unit]
            [have_location]
                x,y=$x1,$y1
                terrain=*^Yga
            [/have_location]
        [/show_if]
        [command]
            [message]
                speaker=unit
                message=_"Are you sure you want to sacrifice me at this altar?"
                [option]
                    label=_"Yes"
                    [command]
                        [message]
                            speaker=unit
                            message=_"You brute!"
                        [/message]
                        {WF_CALL_FUNCTION "altar" do,x,y="burn",$x1,$y1}
                        [harm_unit]
                            [filter]
                                side=1
                                x,y=$x1,$y1
                            [/filter]
                            amount=$unit.max_hitpoints
                            fire_event=yes
                            kill=yes
                            animate=yes
                        [/harm_unit]
                        #[kill]
                        #    side=1
                        #    x,y=$x1,$y1
                        #    animate=yes
                        #    fire_event=yes
                        #[/kill]
                        [modify_unit]
                            [filter]
                                side=2,3,4,5,6,7,8
                                [and]
                                    [not]
                                        status=slowed
                                    [/not]
                                    [or]
                                        [not]
                                            status=uncovered
                                        [/not]
                                    [/or]
                                [/and]
                            [/filter]
                            [effect]
                                apply_to=status
                                add=uncovered
                            [/effect]
                            [effect]
                                apply_to=status
                                add=slowed
                            [/effect]
                        [/modify_unit]
                        [switch]
                            variable=wf_vars.season_str
                            [case]
                                value="spring"
                                {VARIABLE_OP farm_income.spring add 1}
                                #{VARIABLE_OP farm_support.spring add 1}
                                [modify_side]
                                    side=1
                                    village_gold=$farm_income.spring
                                    #village_support=$farm_support.spring
                                [/modify_side]
                            [/case]
                            [case]
                                value="summer"
                                {VARIABLE_OP farm_income.summer add 1}
                                #{VARIABLE_OP farm_support.summer add 1}
                                [modify_side]
                                    side=1
                                    village_gold=$farm_income.summer
                                    #village_support=$farm_support.summer
                                [/modify_side]
                            [/case]
                            [case]
                                value="autumn"
                                {VARIABLE_OP farm_income.autumn add 1}
                                #{VARIABLE_OP farm_support.autumn add 1}
                                [modify_side]
                                    side=1
                                    village_gold=$farm_income.autumn
                                    #village_support=$farm_support.autumn
                                [/modify_side]
                            [/case]
                            [case]
                                value="winter"
                                {VARIABLE_OP farm_income.winter add 1}
                                #{VARIABLE_OP farm_support.winter add 1}
                                [modify_side]
                                    side=1
                                    village_gold=$farm_income.winter
                                    #village_support=$farm_support.winter
                                [/modify_side]
                            [/case]
                        [/switch]
                        #{PUSHBACK_ENEMY_SPAWN}
                        # No burning
                        {REMOVE_EVENT burn_buildings}
                        {REMOVE_EVENT burn_lighthouse}
                        {REMOVE_EVENT burn_farms}
                        {REMOVE_EVENT refresh_slow_trap}
                        [event]
                            name=turn refresh
                            id=slow_everyone
                            first_time_only=no

                            [modify_unit]
                                [filter]
                                    side=2,3,4,5,6,7,8
                                    [and]
                                        [not]
                                            status=slowed
                                        [/not]
                                        [or]
                                            [not]
                                                status=uncovered
                                            [/not]
                                        [/or]
                                    [/and]
                                [/filter]
                                [effect]
                                    apply_to=status
                                    add=uncovered
                                [/effect]
                                [effect]
                                    apply_to=status
                                    add=slowed
                                [/effect]
                            [/modify_unit]
                        [/event]
                    [/command]
                [/option]
                [option]
                    label=_"No"
                    [command]
                        [message]
                            speaker=unit
                            message=_"Phew!"
                        [/message]
                    [/command]
                [/option]
            [/message]
        [/command]
    [/set_menu_item]

    # ----- Eat mushrooms -----
    [set_menu_item]
        id=eat_mushrooms
        description=_ "Eat mushrooms"
        [show_if]
            [have_unit]
                side=1,9
                x,y=$x1,$y1
            [/have_unit]
            [have_location]
                x,y=$x1,$y1
                terrain=*^Em,*^Ymd
            [/have_location]
        [/show_if]
        [command]
            [if]
                [have_unit]
                    side=1
                    x,y=$x1,$y1
                [/have_unit]
                [have_location]
                    x,y=$x1,$y1
                    terrain=*^Em,*^Ymd
                [/have_location]
                [then]
                    [if]
                        {VARIABLE_CONDITIONAL wf_vars.fungi_book greater_than 0}
                        {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 4}
                        [then]
                            {VARIABLE wf_vars.eating_cost 0}
                        [/then]
                    [/if]

                    {STORE_GOLD}
                    [if]
                        {CHECK_GOLD $wf_vars.eating_cost}
                        [then]
                            [message]
                                speaker=unit
                                message=_"Creating a healing potion out of these mushrooms will cost $wf_vars.eating_cost| gold."
                                [option]
                                    label=_"Okay"
                                    default=yes
                                    [command]
                                        {PAY_GOLD $wf_vars.eating_cost}
                                        [sound]
                                            name=dagger-swish.wav
                                        [/sound]
                                        [if]
                                            [have_location]
                                                x,y=$x1,$y1
                                                terrain=*^Ymd
                                            [/have_location]
                                            [then]
                                                [terrain]
                                                    terrain=^Ymb
                                                    layer=overlay
                                                    [and]
                                                        terrain=*^Ymd
                                                        x,y=$x1,$y1
                                                    [/and]
                                                [/terrain]
                                            [/then]
                                            [else]
                                                [terrain]
                                                    terrain=^
                                                    layer=overlay
                                                    [and]
                                                        terrain=*^Em
                                                        x,y=$x1,$y1
                                                    [/and]
                                                [/terrain]
                                            [/else]
                                        [/if]
                                        [if]
                                            {VARIABLE_CONDITIONAL wf_vars.fungi_book greater_than 0}
                                            [then]
                                                [heal_unit]
                                                    [filter]
                                                        side=1
                                                        x,y=$x1,$y1
                                                    [/filter]
                                                    animate=yes
                                                    moves=full
                                                    restore_attacks=yes
                                                    restore_statuses=yes
                                                    amount="$(($wf_vars.fungi_book + $unit.level + 1) * 2)"
                                                [/heal_unit]
                                            [/then]
                                            [else]
                                                [heal_unit]
                                                    [filter]
                                                        side=1
                                                        x,y=$x1,$y1
                                                    [/filter]
                                                    animate=yes
                                                    restore_statuses=no
                                                    amount="$(($unit.level + 1) * 2)"
                                                [/heal_unit]
                                            [/else]
                                        [/if]
                                        {CLEAR_VARIABLE heal_amount}
                                        {FIRE_EVENT eat_mushrooms1}
                                    [/command]
                                [/option]
                                [option]
                                    label=_"Nevermind"
                                    [command] [/command]
                                [/option]
                            [/message]
                        [/then]
                        [else]
                            [message]
                                speaker=unit
                                message=_"I can't afford creating a healing potion."
                            [/message]
                        [/else]
                    [/if]
                [/then]
                [else]
                    # Side 9
                    [sound]
                        name=dagger-swish.wav
                    [/sound]
                    [if]
                        [have_location]
                            x,y=$x1,$y1
                            terrain=*^Ymd
                        [/have_location]
                        [then]
                            [terrain]
                                terrain=^Ymb
                                layer=overlay
                                [and]
                                    terrain=*^Ymd
                                    x,y=$x1,$y1
                                [/and]
                            [/terrain]
                        [/then]
                        [else]
                            [terrain]
                                terrain=^
                                layer=overlay
                                [and]
                                    terrain=*^Em
                                    x,y=$x1,$y1
                                [/and]
                            [/terrain]
                        [/else]
                    [/if]
                    [heal_unit]
                        [filter]
                            side=9
                            x,y=$x1,$y1
                        [/filter]
                        animate=yes
                        restore_statuses=yes
                        amount="$(($unit.level + 5) * 2)"
                    [/heal_unit]
                    {CLEAR_VARIABLE heal_amount}
                [/else]
            [/if]
        [/command]
    [/set_menu_item]

    # ----- Disable unit training -----
    [set_menu_item]
        id=disable_unit_training
        description=_ "Drop out training"
        [show_if]
            {VARIABLE_CONDITIONAL wf_vars.enable_training boolean_equals yes}
            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 2}
            #{VARIABLE_CONDITIONAL wf_vars.season_str not_equals "winter"}
            [have_unit]
                side=1
                x,y=$x1,$y1
                [not]
                    type=Caravan,Peasant_no_Advance,Woodsman_no_Advance,Ruffian_no_Advance
                [/not]
                status=training
            [/have_unit]
            [have_location]
                x,y=$x1,$y1
                terrain=*^Yf,*^Yfo,*^Yb,*^Ybo,*^Ys,*^Yso,*^Yu,*^Yuo,*^Ya,*^Yao
            [/have_location]
        [/show_if]
        [command]
            [modify_unit]
                [filter]
                    x,y=$x1,$y1
                [/filter]
                [effect]
                    apply_to=status
                    remove=training
                [/effect]
            [/modify_unit]
        [/command]
    [/set_menu_item]

    # ----- Enable unit training -----
    [set_menu_item]
        id=enable_unit_training
        description=_ "Enroll for training"
        [show_if]
            {VARIABLE_CONDITIONAL wf_vars.enable_training boolean_equals yes}
            {VARIABLE_CONDITIONAL wf_vars.expand_rank greater_than 2}
            #{VARIABLE_CONDITIONAL wf_vars.season_str not_equals "winter"}
            [have_unit]
                side=1
                x,y=$x1,$y1
                [not]
                    type=Caravan,Peasant_no_Advance,Woodsman_no_Advance,Ruffian_no_Advance
                [/not]
                [not]
                    status=training
                [/not]
            [/have_unit]
            [have_location]
                x,y=$x1,$y1
                terrain=*^Yf,*^Yfo,*^Yb,*^Ybo,*^Ys,*^Yso,*^Yu,*^Yuo,*^Ya,*^Yao
            [/have_location]
        [/show_if]
        [command]
            [modify_unit]
                [filter]
                    x,y=$x1,$y1
                [/filter]
                [effect]
                    apply_to=status
                    add=training
                [/effect]
            [/modify_unit]
        [/command]
    [/set_menu_item]

    # ----- Remove artifact -----
    [set_menu_item]
        id=remove_artifact
        description=_ "Remove artifact"
        [show_if]
            [have_unit]
                side=1
                x,y=$x1,$y1
                [not]
                    type=Caravan
                [/not]
            [/have_unit]
            [have_location]
                x,y=$x1,$y1
                terrain=*^Wm
            [/have_location]
        [/show_if]
        [command]
            [store_unit]
                [filter]
                    x,y=$x1,$y1
                [/filter]
                kill=no
                variable=unit_store
                mode=always_clear
            [/store_unit]

            {VARIABLE strip_artifact -1}

            [set_variables]
                name=tmp_artifact
                mode=replace
                [value]
                    label="Nevermind"
                    [command]
                        {VARIABLE strip_artifact -1}
                    [/command]
                [/value]
            [/set_variables]

            [for]
                array=unit_store.modifications.object
                reverse=yes
                [do]
                    [if]
                        {VARIABLE_CONDITIONAL unit_store.modifications.object[$i].name not_equals $null}
                        [then]
                            [set_variables]
                                name=tmp_artifact
                                mode=append
                                [value]
                                    label=$unit_store.modifications.object[$i].name
                                    description=$unit_store.modifications.object[$i].description
                                    [command]
                                        {VARIABLE strip_artifact $i}
                                    [/command]
                                [/value]
                            [/set_variables]
                        [/then]
                    [/if]
                [/do]
            [/for]

            [message]
                speaker=narrator
                message=_"Select artifact to remove:"
                [insert_tag]
                    name=option
                    variable=tmp_artifact
                [/insert_tag]
            [/message]
            {CLEAR_VARIABLE tmp_artifact}

            [if]
                {VARIABLE_CONDITIONAL strip_artifact greater_than -1}
                [then]
                    [remove_object]
                        x,y=$x1,$y1
                        #object_id="overlay_misc/pickable-overlay.png"
                        object_id="pickable_overlay"
                    [/remove_object]
#ifver WESNOTH_VERSION < 1.15.0
                    [remove_unit_overlay]
                        x,y=$x1,$y1
                        image=misc/pickable-overlay.png
                    [/remove_unit_overlay]
#endif

                    [remove_object]
                        x,y=$x1,$y1
                        object_id=$unit_store.modifications.object[$strip_artifact].id
                    [/remove_object]

                    [for]
                        array=unit_store.modifications.object
                        reverse=yes
                        [do]
                            [if]
                                {VARIABLE_CONDITIONAL i numerical_equals $strip_artifact}
                                [then]
                                    {CLEAR_VARIABLE unit_store.modifications.object[$i]}
                                [/then]
                            [/if]
                        [/do]
                    [/for]
                [/then]
            [/if]
            {CLEAR_VARIABLE strip_artifact}

            {VARIABLE give_overlay no}
            [for]
                array=unit_store.modifications.object
                reverse=yes
                [do]
                    [if]
                        {VARIABLE_CONDITIONAL unit_store.modifications.object[$i].name not_equals $null}
                        [then]
                            {VARIABLE give_overlay yes}
                            [break][/break]
                        [/then]
                    [/if]
                [/do]
            [/for]
            {CLEAR_VARIABLE unit_store}

            [if]
                {VARIABLE_CONDITIONAL give_overlay boolean_equals yes}
                [then]
                    #[unit_overlay]
                    #    x,y=$x1,$y1
                    #    image=misc/pickable-overlay.png
                    #    # object_id={ID}
                    #[/unit_overlay]
                    [object]
                        id="pickable_overlay"
                        take_only_once=no
                        [effect]
                            apply_to=overlay
                            add=misc/pickable-overlay.png
                        [/effect]
                    [/object]
                [/then]
            [/if]
            {CLEAR_VARIABLE give_overlay}
            [fire_event]
                name=amla_extra_event
                [primary_unit]
                    x,y=$x1,$y1
                [/primary_unit]
            [/fire_event]
        [/command]
    [/set_menu_item]
#enddef

# ----- Macros used in build menu items ----------------------------------
#define HAVE_WORKERS_AND_LOCATION TERRAIN X Y
    [and]
        {HAVE_IDLE_WORKERS {X} {Y}}
        [have_location]
            x,y={X},{Y}
            terrain={TERRAIN}
        [/have_location]
    [/and]
#enddef

#define HAVE_DESTROYER_AND_LOCATION TERRAIN X Y
    [and]
        {HAVE_IDLE_DESTROYERS {X} {Y}}
        [have_location]
            x,y={X},{Y}
            terrain={TERRAIN}
        [/have_location]
    [/and]
#enddef

#define HAVE_CASTER_AND_LOCATION TERRAIN X Y
    [and]
        {HAVE_IDLE_CASTERS {X} {Y}}
        [have_location]
            x,y={X},{Y}
            terrain={TERRAIN}
        [/have_location]
    [/and]
#enddef

#define HAVE_RAISER_AND_LOCATION TERRAIN X Y
    [and]
        {HAVE_IDLE_RAISERS {X} {Y}}
        [have_location]
            x,y={X},{Y}
            terrain={TERRAIN}
        [/have_location]
    [/and]
#enddef

#define CHECK_AND_DESTROY PROJ_NAME X Y QUESTION
    [message]
        speaker=unit
        message={QUESTION}
        [option]
            label=_"Yes (1 turn)"
            [command]
                [set_variables]
                    name=projects.proj_list
                    mode=append
                    [value]
                        x={X}
                        y={Y}
                        turns=1
                        goal={PROJ_NAME}
                        custom=none
                        do=burn
                        cost=0
                    [/value]
                [/set_variables]
                {START_WORKING {X} {Y}}
            [/command]
        [/option]
        [option]
            label=_"No"
            [command] [/command]
        [/option]
    [/message]
#enddef

#define CHECK_AND_DESTROY_ZERO PROJ_NAME X Y QUESTION
    [message]
        speaker=unit
        message={QUESTION}
        [option]
            label=_"Yes"
            [command]
                {WF_CALL_FUNCTION {PROJ_NAME} do,x,y="burn",{X},{Y}}
            [/command]
        [/option]
        [option]
            label=_"No"
            [command] [/command]
        [/option]
    [/message]
#enddef

#define WF_CLEANUP_MENU
    # set_menu_item
    #[clear_menu_item]
    #	id=build_keep_hero
    #[/clear_menu_item]

    [clear_menu_item]
        id=menu_stand_down
    [/clear_menu_item]
    [clear_menu_item]
        id=build_menu
    [/clear_menu_item]
    [clear_menu_item]
        id=label_farm
    [/clear_menu_item]
    [clear_menu_item]
        id=relocate_keep_hero
    [/clear_menu_item]
    [clear_menu_item]
        id=eat_mushrooms
    [/clear_menu_item]
    [clear_menu_item]
        id=sacrifice_unit
    [/clear_menu_item]
    [clear_menu_item]
        id=disable_unit_training
    [/clear_menu_item]
    [clear_menu_item]
        id=enable_unit_training
    [/clear_menu_item]
    [clear_menu_item]
        id=remove_artifact
    [/clear_menu_item]
#enddef
